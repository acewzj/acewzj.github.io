<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="acewzj C++ Linux TCP/IP" />










<meta name="description" content="acewzj">
<meta property="og:type" content="website">
<meta property="og:title" content="acewzj">
<meta property="og:url" content="http://acewzj.github.io/index.html">
<meta property="og:site_name" content="acewzj">
<meta property="og:description" content="acewzj">
<meta property="og:locale" content="zh">
<meta property="article:author" content="acewzj">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://acewzj.github.io/"/>





  <title>acewzj</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">acewzj</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">王忠杰</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/29/2024-03-08-meta/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/29/2024-03-08-meta/" itemprop="url">Matlab</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-29T22:16:18+08:00">
                2020-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MATLAB/" itemprop="url" rel="index">
                    <span itemprop="name">MATLAB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/29/2020-03-29-Matlab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/29/2020-03-29-Matlab/" itemprop="url">Matlab</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-29T22:16:18+08:00">
                2020-03-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MATLAB/" itemprop="url" rel="index">
                    <span itemprop="name">MATLAB</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>


<p>这篇文章主要记述了MATLAB。</p>
<p>1、首先把照片中每一个偏振角度里的值抠出来赋给im ，然后通过一个遮罩获取通过的像素点放到I 的列向量里。</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> <span class="built_in">i</span>=<span class="number">1</span>:nimages</span><br><span class="line">    im = images(:,:,<span class="built_in">i</span>);<span class="comment">% 三维数组images的每一个像素的第i通道 它这一张照片有36个通道？%读取每一个通道里的值赋给im，然后im利用遮罩来把1像素下的变成I的列向量</span></span><br><span class="line">    I(:,<span class="built_in">i</span>)=im(mask);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>2、进入线性方法中，生成一个（偏振角度）行 3 列的矩阵A【第一列是单位1，第二列是偏振角度的余弦，第三列是偏振角度的正弦】</p>
<p><code>A = [ones(nimages,1) cos(2.*angles&#39;) sin(2.*angles&#39;)];</code></p>
<p>3、一般情况下，x=a\b是方程a<em>x =b的解，而x=b/a是方程x</em>a=b的解</p>
<figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x = A\(I');<span class="comment">% A * x = (I')  I' = 36行*74331列 A 36行3列</span></span><br><span class="line">   x = x';<span class="comment">%</span></span><br><span class="line">   Imax = x(:,<span class="number">1</span>)+<span class="built_in">sqrt</span>(x(:,<span class="number">2</span>).^<span class="number">2</span>+x(:,<span class="number">3</span>).^<span class="number">2</span>);<span class="comment">% 取出x第一列的值 + 根号下（x第二列的值^2 + x第三列的值^2）</span></span><br><span class="line">   Imin = x(:,<span class="number">1</span>)-<span class="built_in">sqrt</span>(x(:,<span class="number">2</span>).^<span class="number">2</span>+x(:,<span class="number">3</span>).^<span class="number">2</span>);</span><br><span class="line">   Iun = (Imin+Imax)./<span class="number">2</span>;</span><br><span class="line">   rho = (Imax-Imin)./(Imax+Imin);</span><br><span class="line">   phi = <span class="number">0.5</span>*<span class="built_in">atan2</span>(x(:,<span class="number">3</span>),x(:,<span class="number">2</span>));</span><br><span class="line">   phi = <span class="built_in">mod</span>(phi,<span class="built_in">pi</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/31/Q2KTpNMundXUsxl.jpg" alt=""></p>
<p><img src="https://i.loli.net/2020/03/31/amGrO9uxZVKHzfF.jpg" alt=""></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/21/2020-03-21-TCP_IP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/21/2020-03-21-TCP_IP/" itemprop="url">TCP/IP</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-21T10:16:18+08:00">
                2020-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TCP-IP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP/IP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了TCP/IP以及网络编程的知识。</p>
<p>废话少说，首先，我们需要知道TCP在网络OSI的七层模型中的第四层——<code>Transport层</code>，IP在第三层——<code>Network层</code>，ARP在第二层——<code>Data Link层</code>，在第二层上的数据，我们叫<code>Frame</code>，在第三层上的数据叫<code>Packet</code>，第四层的数据叫<code>Segment</code>。</p>
<p>首先，我们需要知道，我们程序的数据首先会打到TCP的<code>Segment</code>中，然后TCP的<code>Segment</code>会打到IP的<code>Packet</code>中，然后再打到以太网<code>Ethernet</code>的<code>Frame</code>中，传到对端后，各个层解析自己的协议，然后把数据交给更高层的协议处理。</p>
<h2 id="connection-refused"><a href="#connection-refused" class="headerlink" title="connection refused"></a>connection refused</h2><p>服务器正常启动，但是客户端一启动就在<code>connect</code>函数退出了，错误显示<code>connection refused</code>，单步调试也看不出什么来。</p>
<p>上网一看，有的人也碰到了类似问题，他们怀疑出现这个状况最大的可能是服务器正在监听程序，但是客户端并没有按照规矩的IP和端口号来给服务器发程序：这不有的人就是因为把服务器的<code>serv_addr.sin_port = htons(atoi(argv[1]));</code>写错为<code>serv_addr.sin_port = htonl(atoi(argv[1]));</code>导致端口号分配出错了。</p>
<p><img src="https://i.loli.net/2020/04/01/2UY1yrgvwzsNjD8.png" alt="image-20200401092200981"></p>
<p>当然我也好不到哪里去？在使用telnet localhost 9000发现服务器正常好用之后，我坚信我的客户端程序出了问题：一行一行代码排查，终于发现<code>serv_addr.sin_port = htons(argv[1]);</code> 我特么忘了加atoi，这端口号肯定是错了啊【初始端口为9000，16进制为0x2328经过hostToNetShort后变成0x2823–&gt;10275】</p>
<p><img src="https://i.loli.net/2020/04/01/OcltiYzaLw89gv3.png" alt="image-20200401100250744"></p>
<p><img src="https://i.loli.net/2020/04/01/L6Qp4ORXPeFi5UY.png" alt="image-20200401100638777"></p>
<p><img src="https://i.loli.net/2020/04/01/1gzbMQ6qr5VkNY7.png" alt="image-20200401101317898"></p>
<h2 id="1、Epoll"><a href="#1、Epoll" class="headerlink" title="1、Epoll"></a>1、Epoll</h2><p><img src="https://i.loli.net/2020/03/30/4FkcyDpC9ZxMiTu.png" alt="image-20200328232049698"></p>
<p><img src="https://i.loli.net/2020/03/30/IhUAb6fsQgp2LyG.png" alt="image-20200328232416075"></p>
<p><img src="https://i.loli.net/2020/03/30/e7WKMlwZguRIyE4.png" alt="image-20200328232423802"></p>
<h2 id="2、不同socket地址结构对比"><a href="#2、不同socket地址结构对比" class="headerlink" title="2、不同socket地址结构对比"></a>2、不同socket地址结构对比</h2><p><img src="https://i.loli.net/2020/04/01/8ZcPnrdFHtVwW5D.png" alt="image-20200401224452953"></p>
<h2 id="3、如何判断机器的大端与小端？"><a href="#3、如何判断机器的大端与小端？" class="headerlink" title="3、如何判断机器的大端与小端？"></a>3、如何判断机器的大端与小端？</h2><h3 id="3-1、常见的字节序"><a href="#3-1、常见的字节序" class="headerlink" title="3.1、常见的字节序"></a>3.1、常见的字节序</h3><p>一般操作系统都是小端，而通讯协议是大端的。</p>
<p><img src="https://i.loli.net/2020/04/01/Nxpg5lwZLejzRTA.png" alt="image-20200401213715103"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BigtoLittle16(A)  ((((uint16)(A) &amp; 0xff00) &gt;&gt; 8) | </span></span><br><span class="line">							(((uint16)(A) &amp; <span class="number">0x00ff</span>) &lt;&lt; <span class="number">8</span>))</span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BigtoLittle32(A)  ((((uint32)(A) &amp; 0xff000000) &gt;&gt; 24) |                                            						(((uint32)(A) &amp; 0x00ff0000) &gt;&gt; 8) | \</span></span><br><span class="line">                   (((uint32)(A) &amp; <span class="number">0x0000ff00</span>) &lt;&lt; <span class="number">8</span>) | \</span><br><span class="line">                   (((uint32)(A) &amp; <span class="number">0x000000ff</span>) &lt;&lt; <span class="number">24</span>))</span><br></pre></td></tr></table></figure>



<h2 id="4、慢系统调用阻塞状态下来了个信号（Vital）"><a href="#4、慢系统调用阻塞状态下来了个信号（Vital）" class="headerlink" title="4、慢系统调用阻塞状态下来了个信号（Vital）"></a>4、慢系统调用阻塞状态下来了个信号（Vital）</h2><p>select函数、accept函数等都是慢系统调用函数，就是它得等系统网络IO准备好了才能执行，没有准备好就进入阻塞状态下，如果这个时候来了一个信号（因为我们知道信号是模仿的中断的嘛），当执行完信号处理函数返回后，PC指针就会跑到select函数的下一条指令去执行去了。。。。。。这不完蛋了吗：我等待的事件还没来呢我就被信号处理函数给跳过去了。</p>
<p>所以我们需要在select函数的返回值上做文章，如果select函数失败会返回-1，如果是去执行信号处理函数去了，error = EINTR</p>
<h2 id="4-1、非阻塞编程"><a href="#4-1、非阻塞编程" class="headerlink" title="4.1、非阻塞编程"></a>4.1、非阻塞编程</h2><p>让服务器不会阻塞在send，accept等函数之上，防止有人恶意攻击</p>
<p><img src="https://i.loli.net/2020/03/30/4txL8PY9qgjCdbJ.png" alt="image-20200322111836020"></p>
<p><img src="https://i.loli.net/2020/03/30/JuRfAcSBvnHa1qr.png" alt="image-20200322112447217"></p>
<p><img src="https://i.loli.net/2020/03/30/fHRLFJg8sGY6t4b.png" alt="image-20200322112833866"></p>
<p><img src="https://i.loli.net/2020/03/30/M1fJEvI9H56tsWQ.png" alt="image-20200322113420519"></p>
<h2 id="5、TCP头格式"><a href="#5、TCP头格式" class="headerlink" title="5、TCP头格式"></a>5、TCP头格式</h2><h3 id="acknowledge-告知已收到"><a href="#acknowledge-告知已收到" class="headerlink" title="acknowledge(告知已收到)"></a>acknowledge(告知已收到)</h3><p>接下来，我们来看一下TCP头的格式</p>
<p><img src="https://i.loli.net/2020/03/30/amtJPn6jgFLT7BC.png" alt="image-20200320091059508"></p>
<p>逐个分析：</p>
<ul>
<li>16位源端口号和16位目的端口号。</li>
<li>32位序号：一次TCP通信过程中某一个传输方向上的字节流的每个字节的编号，通过这个来确认发送的数据有序，比如现在序列号为1000，发送了1000，下一个序列号就是2000。</li>
<li>32位确认号：用来响应TCP报文段，给收到的TCP报文段的序号加1，三握时还要携带自己的序号。</li>
<li>4位头部长度：标识该TCP头部有多少个4字节，共表示最长15*4=60字节。同IP头部。</li>
<li>6位保留。6位标志。URG（紧急指针是否有效）ACK（表示确认号是否有效）PSH（提示接收端应用程序应该立即从TCP接收缓冲区读走数据）RST（表示要求对方重新建立连接）SYN（表示请求建立一个连接）FIN（表示通知对方本端要关闭连接）</li>
<li>16位窗口大小：TCP流量控制的一个手段，用来告诉对端TCP缓冲区还能容纳多少字节。</li>
<li>16位校验和：由发送端填充，接收端对报文段执行CRC算法以检验TCP报文段在传输中是否损坏。</li>
<li>16位紧急指针：一个正的偏移量，它和序号段的值相加表示最后一个紧急数据的下一字节的序号。</li>
</ul>
<h2 id="6、三次握手与四次挥手"><a href="#6、三次握手与四次挥手" class="headerlink" title="6、三次握手与四次挥手"></a>6、三次握手与四次挥手</h2><p><img src="https://i.loli.net/2020/03/30/uzFWcwyeg9NmIrZ.jpg" alt=""></p>
<p><img src="https://i.loli.net/2020/03/30/9w3uJ4Iv8hYfcEC.png" alt="image-20200321103919380"></p>
<p><strong>握手过程可以简化为下面的四次交互：</strong></p>
<ul>
<li>1 ) clien 端首先发送一个 SYN 包告诉 Server 端我的初始序列号是 X；</li>
<li>2 ) Server 端收到 SYN 包后回复给 client 一个 ACK 确认包，告诉 client 说我收到了；</li>
<li>3 ) 接着 Server 端也需要告诉 client 端自己的初始序列号，于是 Server 也发送一个 SYN 包告诉 client 我的初始序列号是Y；</li>
<li>4 ) Client 收到后，回复 Server 一个 ACK 确认包说我知道了。</li>
</ul>
<h4 id="这里为什么服务器也要发一个初始序列号？"><a href="#这里为什么服务器也要发一个初始序列号？" class="headerlink" title="这里为什么服务器也要发一个初始序列号？"></a>这里为什么服务器也要发一个初始序列号？</h4><p>因为有可能客户端之前与服务器连过一次，后来网络断了，客户端再连接时你服务器好意思再从头给人家发一次吗？</p>
<p><strong>在三次握手过程中，细心的同学可能会有以下疑问：</strong></p>
<ul>
<li>1）初始化序列号X、Y是可以是写死固定的吗，为什么不能呢？</li>
<li>2）假如Client发送一个SYN包给Server后就挂了或是不管了，这个时候这个连接处于什么状态呢？会超时吗？为什么呢？</li>
</ul>
<p><strong>如果初始化序列号（缩写为ISN：Inital Sequence Number）可以固定，我们来看看会出现什么问题：</strong></p>
<ul>
<li>假设ISN固定是1，Client和Server建立好一条TCP连接后，Client连续给Server发了10个包，这10个包不知怎么被链路上的路由器缓存了(路由器会毫无先兆地缓存或者丢弃任何的数据包)，这个时候碰巧Client挂掉了；</li>
<li>然后Client用同样的端口号重新连上Server，Client又连续给Server发了几个包，假设这个时候Client的序列号变成了5；</li>
<li>接着，之前被路由器缓存的10个数据包全部被路由到Server端了，Server给Client回复确认号10，这个时候，Client整个都不好了，这是什么情况？我的序列号才到5，你怎么给我的确认号是10了，整个都乱了。</li>
</ul>
<h2 id="疑症-3-初始化连接的-SYN-超时问题"><a href="#疑症-3-初始化连接的-SYN-超时问题" class="headerlink" title="疑症 3 : 初始化连接的 SYN 超时问题"></a>疑症 3 : 初始化连接的 SYN 超时问题</h2><p>Client发送SYN包给Server后挂了，Server回给Client的SYN-ACK一直没收到Client的ACK确认，这个时候这个连接既没建立起来，也不能算失败。这就需要一个超时时间让Server将这个连接断开，否则这个连接就会一直占用Server的SYN连接队列中的一个位置，大量这样的连接就会将Server的SYN连接队列耗尽，让正常的连接无法得到处理。</p>
<p>目前，Linux下默认会进行5次重发SYN-ACK包，重试的间隔时间从1s开始，下次的重试间隔时间是前一次的双倍，5次的重试时间间隔为1s, 2s, 4s, 8s, 16s，总共31s，第5次发出后还要等32s都知道第5次也超时了.所以，总共需要 1s + 2s + 4s+ 8s+ 16s + 32s = 63s，TCP才会把断开这个连接。</p>
<p>由于，SYN超时需要63秒，那么就给攻击者一个攻击服务器的机会，攻击者在短时间内发送大量的SYN包给Server(俗称 SYN flood 攻击)，用于耗尽Server的SYN队列。对于应对SYN 过多的问题，linux提供了几个TCP参数：tcp_syncookies、tcp_synack_retries、tcp_max_syn_backlog、tcp_abort_on_overflow 来调整应对。</p>
<h2 id="8、疑症-5-四次挥手能不能变成三次挥手呢？"><a href="#8、疑症-5-四次挥手能不能变成三次挥手呢？" class="headerlink" title="8、疑症 5 : 四次挥手能不能变成三次挥手呢？"></a>8、疑症 5 : 四次挥手能不能变成三次挥手呢？</h2><p>答案是可能的。</p>
<p>TCP是全双工通信，Cliet在自己已经不会在有新的数据要发送给Server后，可以发送FIN信号告知Server，这边已经终止Client到对端Server那边的数据传输。但是，这个时候对端Server可以继续往Client这边发送数据包。于是，两端数据传输的终止在时序上是独立并且可能会相隔比较长的时间，这个时候就必须最少需要2+2 = 4 次挥手来完全终止这个连接。但是，如果Server在收到Client的FIN包后，在也没数据需要发送给Client了，那么对Client的ACK包和Server自己的FIN包就可以合并成为一个包发送过去，这样四次挥手就可以变成三次了(似乎linux协议栈就是这样实现的)。</p>
<p>TCP进行断开连接的目标是：回收资源、终止数据传输。由于TCP是全双工的，需要Peer两端分别各自拆除自己通向Peer对端的方向的通信信道。</p>
<p><strong>这样需要四次挥手来分别拆除通信信道，就比较清晰明了了：</strong></p>
<ul>
<li>1）Client 发送一个FIN包来告诉 Server 我已经没数据需要发给 Server了；</li>
<li>2）Server 收到后回复一个 ACK 确认包说我知道了；</li>
<li>3）然后 server 在自己也没数据发送给client后，Server 也发送一个 FIN 包给 Client 告诉 Client 我也已经没数据发给client 了；</li>
<li>4）Client 收到后，就会回复一个 ACK 确认包说我知道了。</li>
</ul>
<p>很多人会问，为什么建链接要3次握手，断链接需要4次挥手？</p>
<ul>
<li><strong>对于建链接的3次握手，</strong>主要是要初始化Sequence Number 的初始值。通信的双方要互相通知对方自己的初始化的Sequence Number（缩写为ISN：Inital Sequence Number）——所以叫SYN，全称Synchronize Sequence Numbers。也就上图中的 x 和 y。这个号要作为以后的数据通信的序号，以保证应用层接收到的数据不会因为网络上的传输的问题而乱序（TCP会用这个序号来拼接数据）。</li>
<li><strong>对于4次挥手，</strong>其实你仔细看是2次，因为TCP是全双工的，所以，发送方和接收方都需要Fin和Ack。只不过，有一方是被动的，所以看上去就成了所谓的4次挥手。如果两边同时断连接，那就会就进入到CLOSING状态，然后到达TIME_WAIT状态。下图是双方同时断连接的示意图（你同样可以对照着TCP状态机看）：</li>
</ul>
<p>另外，有几个事情需要注意一下：</p>
<ul>
<li><strong>关于建连接时SYN超时</strong>。试想一下，如果server端接到了client发的SYN后回了SYN-ACK后client掉线了，server端没有收到client回来的ACK，那么，这个连接处于一个中间状态，即没成功，也没失败。于是，server端如果在一定时间内没有收到的TCP会重发SYN-ACK。在Linux下，默认重试次数为5次，重试的间隔时间从1s开始每次都翻售，5次的重试时间间隔为1s, 2s, 4s, 8s, 16s，总共31s，第5次发出后还要等32s都知道第5次也超时了，所以，总共需要 1s + 2s + 4s+ 8s+ 16s + 32s = 2^6 -1 = 63s，TCP才会把断开这个连接。</li>
<li><strong>关于SYN Flood攻击</strong>。一些恶意的人就为此制造了SYN Flood攻击——给服务器发了一个SYN后，就下线了，于是服务器需要默认等63s才会断开连接，这样，攻击者就可以把服务器的syn连接的队列耗尽，让正常的连接请求不能处理。于是，Linux下给了一个叫<strong>tcp_syncookies</strong>的参数来应对这个事——当SYN队列满了后，TCP会通过源地址端口、目标地址端口和时间戳打造出一个特别的Sequence Number发回去（又叫cookie），如果是攻击者则不会有响应，如果是正常连接，则会把这个 SYN Cookie发回来，然后服务端可以通过cookie建连接（即使你不在SYN队列中）。请注意，<strong>请先千万别用tcp_syncookies来处理正常的大负载的连接的情况</strong>。因为，synccookies是妥协版的TCP协议，并不严谨。对于正常的请求，你应该调整三个TCP参数可供你选择，第一个是：tcp_synack_retries 可以用他来减少重试次数；第二个是：tcp_max_syn_backlog，可以增大SYN连接数；第三个是：tcp_abort_on_overflow 处理不过来干脆就直接拒绝连接了。</li>
<li><strong>关于ISN的初始化</strong>。ISN是不能hard code的，不然会出问题的——比如：如果连接建好后始终用1来做ISN，如果client发了30个segment过去，但是网络断了，于是 client重连，又用了1做ISN，但是之前连接的那些包到了，于是就被当成了新连接的包，此时，client的Sequence Number 可能是3，而Server端认为client端的这个号是30了。全乱了。<a href="http://tools.ietf.org/html/rfc793" target="_blank" rel="noopener">RFC793</a>中说，ISN会和一个假的时钟绑在一起，这个时钟会在每4微秒对ISN做加一操作，直到超过2^32，又从0开始。这样，一个ISN的周期大约是4.55个小时。因为，我们假设我们的TCP Segment在网络上的存活时间不会超过Maximum Segment Lifetime（缩写为MSL – <a href="http://en.wikipedia.org/wiki/Maximum_Segment_Lifetime" target="_blank" rel="noopener">Wikipedia语条</a>），所以，只要MSL的值小于4.55小时，那么，我们就不会重用到ISN。</li>
<li><strong>关于 MSL 和 TIME_WAIT</strong>。通过上面的ISN的描述，相信你也知道MSL是怎么来的了。我们注意到，在TCP的状态图中，从TIME_WAIT状态到CLOSED状态，有一个超时设置，这个超时设置是 2*MSL（<a href="http://tools.ietf.org/html/rfc793" target="_blank" rel="noopener">RFC793</a>定义了MSL为2分钟，Linux设置成了30s）为什么要这有TIME_WAIT？为什么不直接给转成CLOSED状态呢？主要有两个原因：1）TIME_WAIT确保有足够的时间让对端收到了ACK，如果被动关闭的那方没有收到Ack，就会触发被动端重发Fin，一来一去正好2个MSL，2）有足够的时间让这个连接不会跟后面的连接混在一起（你要知道，有些自做主张的路由器会缓存IP数据包，如果连接被重用了，那么这些延迟收到的包就有可能会跟新连接混在一起）。你可以看看这篇文章《<a href="http://www.serverframework.com/asynchronousevents/2011/01/time-wait-and-its-design-implications-for-protocols-and-scalable-servers.html" target="_blank" rel="noopener">TIME_WAIT and its design implications for protocols and scalable client server systems</a>》</li>
<li><strong>关于TIME_WAIT数量太多</strong>。从上面的描述我们可以知道，TIME_WAIT是个很重要的状态，但是如果在大并发的短链接下，TIME_WAIT 就会太多，这也会消耗很多系统资源。只要搜一下，你就会发现，十有八九的处理方式都是教你设置两个参数，一个叫<strong>tcp_tw_reuse</strong>，另一个叫<strong>tcp_tw_recycle</strong>的参数，这两个参数默认值都是被关闭的，后者recyle比前者resue更为激进，resue要温柔一些。另外，如果使用tcp_tw_reuse，必需设置tcp_timestamps=1，否则无效。这里，你一定要注意，<strong>打开这两个参数会有比较大的坑——可能会让TCP连接出一些诡异的问题</strong>（因为如上述一样，如果不等待超时重用连接的话，新的连接可能会建不上。正如<a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="noopener">官方文档</a>上说的一样“<strong>It should not be changed without advice/request of technical experts</strong>”）。</li>
<li><strong>关于tcp_tw_reuse</strong>。官方文档上说tcp_tw_reuse 加上tcp_timestamps（又叫PAWS, for Protection Against Wrapped Sequence Numbers）可以保证协议的角度上的安全，但是你需要tcp_timestamps在两边都被打开（你可以读一下<a href="http://lxr.free-electrons.com/ident?i=tcp_twsk_unique" target="_blank" rel="noopener">tcp_twsk_unique</a>的源码 ）。我个人估计还是有一些场景会有问题。</li>
<li><strong>关于tcp_tw_recycle</strong>。如果是tcp_tw_recycle被打开了话，会假设对端开启了tcp_timestamps，然后会去比较时间戳，如果时间戳变大了，就可以重用。但是，如果对端是一个NAT网络的话（如：一个公司只用一个IP出公网）或是对端的IP被另一台重用了，这个事就复杂了。建链接的SYN可能就被直接丢掉了（你可能会看到connection time out的错误）（如果你想观摩一下Linux的内核代码，请参看源码<a href="http://lxr.free-electrons.com/ident?i=tcp_timewait_state_process" target="_blank" rel="noopener"> tcp_timewait_state_process</a>）。</li>
<li><strong>关于tcp_max_tw_buckets</strong>。这个是控制并发的TIME_WAIT的数量，默认值是180000，如果超限，那么，系统会把多的给destory掉，然后在日志里打一个警告（如：time wait bucket table overflow），官网文档说这个参数是用来对抗DDoS攻击的。也说的默认值180000并不小。这个还是需要根据实际情况考虑。</li>
</ul>
<p>*<em>Again，使用tcp_tw_reuse和tcp_tw_recycle来解决TIME_WAIT的问题是非常非常危险的，因为这两个参数违反了TCP协议（<a href="http://tools.ietf.org/html/rfc1122" target="_blank" rel="noopener">RFC 1122</a>） *</em></p>
<p>其实，TIME_WAIT表示的是你主动断连接，所以，这就是所谓的“不作死不会死”。试想，如果让对端断连接，那么这个破问题就是对方的了，呵呵。另外，如果你的服务器是于HTTP服务器，那么设置一个<a href="http://en.wikipedia.org/wiki/HTTP_persistent_connection" target="_blank" rel="noopener">HTTP的KeepAlive</a>有多重要（浏览器会重用一个TCP连接来处理多个HTTP请求），然后让客户端去断链接（你要小心，浏览器可能会非常贪婪，他们不到万不得已不会主动断连接）。</p>
<h4 id="数据传输中的Sequence-Number"><a href="#数据传输中的Sequence-Number" class="headerlink" title="数据传输中的Sequence Number"></a>数据传输中的Sequence Number</h4><p>下图是我从Wireshark中截了个我在访问coolshell.cn时的有数据传输的图给你看一下，SeqNum是怎么变的。（使用Wireshark菜单中的Statistics -&gt;Flow Graph… ）</p>
<p><a href="http://www.52im.net/thread-1003-1-1.html" target="_blank" rel="noopener">http://www.52im.net/thread-1003-1-1.html</a></p>
<p>作者：Cooci_和谐学习_不急不躁<br>链接：<a href="https://www.jianshu.com/p/69695f332a71" target="_blank" rel="noopener">https://www.jianshu.com/p/69695f332a71</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/17/2020-03-17-Schedule/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/17/2020-03-17-Schedule/" itemprop="url">Schedule</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-17T10:16:18+08:00">
                2020-03-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<ul>
<li>2020秋招提前批</li>
<li>C/C++相关开发</li>
<li>拿到<strong>腾讯</strong>、华为等offer</li>
</ul>
<hr>
<p><strong>学习路线及时间安排</strong></p>
<p>推荐时间为4个月，包括四部分：语言，计算机基础知识，项目基础知识，项目实践。</p>
<ul>
<li>语言<ul>
<li>推荐学习<strong>1个月</strong></li>
<li>学习方针：<strong>视频为主，书籍为辅</strong>。</li>
<li>配套视频：C语言，C++语言</li>
<li>C++ Primer Plus<ul>
<li>集中学习该书的1~8章，涉及C语言基础语法及指针、结构体的使用。</li>
</ul>
</li>
<li>C和指针<ul>
<li>该书全面深入的剖析了指针的概念与使用，是C语言的进阶。</li>
</ul>
</li>
<li>C++ Primer<ul>
<li>作为C++查询的工具书，相当于新华词典，里面会涉及C++的很多技术细节，实际工程中用到的并不会太多。平时遇到问题可以查询该书，另外也可以作为面试的参考书。</li>
</ul>
</li>
<li>STL源码解析<ul>
<li>涉及C++标准模板库的源码实现，其中vector、map的实现需要重点关注，比如内存分配，底层数据结构等。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/005TJ2c7ly1gc5h141pomj30u00omjsz.jpg" alt="img"></p>
<ul>
<li>计算机基础知识<ul>
<li>推荐学习<strong>1个月</strong></li>
<li>配套视频：数据结构</li>
<li>数据结构<ul>
<li>视频为主，书籍为辅。看小甲鱼的数据结构，该视频以大话数据结构为蓝本讲解，了解链表，栈，队列，二叉树，哈希表，堆等基础的数据结构。</li>
</ul>
</li>
<li>算法<ul>
<li>推荐直接刷题，先临摹再实战。推荐书籍剑指offer，左程云大神的程序员代码面试指南；刷题网站推荐牛客网。</li>
</ul>
</li>
<li>操作系统<ul>
<li>推荐书籍学习，重点看深入理解计算机系统的6,7,9,10章。主要理解线程，进程，虚拟内存及锁机制。</li>
</ul>
</li>
<li>计算机网络<ul>
<li>推荐书籍学习。主要理解TCP/UDP/HTTP三种协议。其中TCP/UDP以谢希仁老师的计算机网络为主，HTTP以图解HTTP协议为主。</li>
</ul>
</li>
<li>设计模式<ul>
<li>推荐书籍学习，大话设计模式。设计模式可以放在所有知识的最后进行学习。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/005TJ2c7ly1gc5h20cobsj30u00qmmyn.jpg" alt="img"></p>
<ul>
<li>项目基础知识<ul>
<li>推荐学习<strong>1个月</strong></li>
<li>配套视频：Linux，数据库</li>
<li>Linux基本命令<ul>
<li>该部分主要以看视频为主，记住常用的即可，其余的在实际使用时即用即搜。</li>
</ul>
</li>
<li>Linux系统编程<ul>
<li>在Linux下进行编程，会涉及到与系统的交互，内存访问，需要学习Linux系统API用法。</li>
</ul>
</li>
<li>网络编程<ul>
<li>视频为主，书籍为辅。书籍先看tcp/ip网络编程查漏补缺，补齐网络编程基础知识，然后看Linux高性能编程。</li>
</ul>
</li>
<li>数据库<ul>
<li>视频为主，书籍为辅。MySQL和Redis数据库是当前面试的热门，书籍先看MySQL必知必会，再看Redis设计与实现。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/005TJ2c7ly1gc5h2pm8anj30u00kdgnh.jpg" alt="img"></p>
<ul>
<li>项目实践<ul>
<li>项目名称为<strong>Linux下C++轻量级Web服务器开发</strong>，实现web端用户注册，登录功能，经压力测试可以实现上万的并发连接。（测试机器为Intel i7 7700，16G内存）</li>
<li>推荐学习<strong>1个月</strong></li>
<li>线程池<ul>
<li>涉及线程，锁机制。使用一个工作队列完全解除了主线程和工作线程的耦合关系：主线程往工作队列中插入任务，工作线程通过竞争来取得任务并执行它。</li>
</ul>
</li>
<li>HTTP请求与响应<ul>
<li>涉及Linux系统编程，网络编程，TCP和HTTP协议。根据状态转移,通过主从状态机封装了http连接类。其中,主状态机在内部调用从状态机,从状态机将处理状态和数据传给主状态机。</li>
</ul>
</li>
<li>注册登录<ul>
<li>涉及少许网页html知识。实现用户名和密码校验，另外通过html文件设置action实现跳转。</li>
</ul>
</li>
<li>定时器<ul>
<li>涉及Linux系统信号及数据结构的使用。由于非活跃连接占用了连接资源，严重影响服务器的性能，通过实现一个服务器定时器，处理这种非活跃连接，释放连接资源。</li>
</ul>
</li>
<li>数据库连接池<ul>
<li>涉及MySQL数据库。建立数据库连接池，通过重复使用这些已经建立的数据库连接，解决频繁建立连接的缺点，从而提高系统性能。</li>
</ul>
</li>
<li>同步/异步日志系统<ul>
<li>涉及设计模式，自定义阻塞队列。同步/异步日志系统主要涉及了两个模块，一个是日志模块，一个是阻塞队列模块,其中加入阻塞队列模块主要是解决异步写入日志做准备。</li>
</ul>
</li>
<li>压力测试<ul>
<li>阅读Webbench源码，对进程加深理解。通过Webbench创建多个进程，每个进程通过HTTP连接访问服务器，完成压力测试。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/005TJ2c7ly1gc5h3163c0j30g80lmjsd.jpg" alt="img"></p>
<hr>
<p><strong>相关资料**</strong>电子书链接：<a href="https://pan.baidu.com/s/1dD_F6aG5dIetaks0kIobAg提取码：buim" target="_blank" rel="noopener">https://pan.baidu.com/s/1dD_F6aG5dIetaks0kIobAg提取码：buim</a><br>视频链接：<a href="https://pan.baidu.com/s/1tri7oj_R_J4QU__8RjZq7w提取码：emtp" target="_blank" rel="noopener">https://pan.baidu.com/s/1tri7oj_R_J4QU__8RjZq7w提取码：emtp</a><br>项目Linux下C++轻量级Web服务器<a href="https://github.com/qinguoyi/TinyWebServer" target="_blank" rel="noopener">https://github.com/qinguoyi/TinyWebServer</a><br>知识总结<a href="https://github.com/twomonkeyclub/BackEnd" target="_blank" rel="noopener">https://github.com/twomonkeyclub/BackEnd</a><br>**</p>
<p>作者：这波有什么问题<br>链接：<a href="https://www.nowcoder.com/discuss/379063?type=all&amp;order=time&amp;pos=&amp;page=1" target="_blank" rel="noopener">https://www.nowcoder.com/discuss/379063?type=all&amp;order=time&amp;pos=&amp;page=1</a><br>来源：牛客网</p>
<p>1自我介绍<br> 2实习项目（问的挺详细的），实习学到了哪些东西<br> 3看过哪些c++的书，印象最深的是哪个？具体是什么方面<br> 4除了看书还通过哪些渠道学习c++？有没有喜欢的博主？有没有自己写过博客？<br> 5虚函数的实现原理？<br> 6析构函数有没有必要都设置成虚函数？为什么？<br> 7Socket编程了解过吗？<br> 8网络的知识了解的多吗？说一下tcp连接和释放的过程？<br> 9Vector的底层实现原理？STL容器哪些用的比较多<br> 10map和unorder_map的底层实现和区别？<br> 11哈希表的实现原理?如何解决哈希冲突？哪种方法更好？</p>
<p>  12有什么方法可以避免申请的内存忘记被释放？</p>
<p>作者：Buermy<br>链接：<a href="https://www.nowcoder.com/discuss/394076?type=0&amp;order=0&amp;pos=1&amp;page=1" target="_blank" rel="noopener">https://www.nowcoder.com/discuss/394076?type=0&amp;order=0&amp;pos=1&amp;page=1</a><br>来源：牛客网</p>
<p>一面:电话面<br>1.自我介绍;<br>2.你是非科班的，说一下你的自学过程;<br>3.简单介绍一下你的项目;<br>4.项目用到了epoll，讲一下epoll的ET模式和LT模式;<br>5.讲一下epoll的oneshot?<br>6.惊群效应;<br>7.有什么想问的吗?<br>这一面感觉就是简单聊天</p>
<p>二面:视频面<br>1.介绍一下项目;<br>2.项目用到了线程池，如何避免多线程的同步错误?<br>3.线程间的通信机制;<br>4.项目用到了stl，从源码角度讲一种你熟悉的stl容器的实现?map与unordered_map的底层数据结构与查找复杂度;<br>5.项目是用Cpp11写的吗?讲一下Cpp11的新特性?<br>6.讲一下智能指针为何能避免内存泄露?为什么匿名函数能提高程序效率?<br>7.你的http报文解析是怎么做的?用到了什么数据结构?如果http应答报文大于你设定的写缓冲区怎么处理?<br>8.既然tcp更可靠，为什么有很多项目还是优先选择udp?udp快在哪里?如何保证udp的可靠性?<br>9.libevent了解过吗?讲一下libevent的原理;<br>10.内存对齐;<br>11.虚函数工作原理;<br>12.什么时候用模板函数?什么时候用虚函数?<br>13.Cpp 类对象的内存分布;<br>14.手撕LRUmap<br>这一面主要面基础</p>
<p>三面:视频压力面<br>1.介绍一下你的项目;<br>2.你写的服务器性能怎么样?<br>3.服务器压力测试怎么做的?<br>4.服务器吞吐量?<br>5.服务器响应时间?<br>6.如何减少响应时间?<br>7.如何确定服务器的最大并发连接数?<br>8.讲一个你做过的一个确实能用的项目;<br>9.还有什么问题吗?<br>这一面节奏很快，如果不能很快答出来就立刻跳到下一个问题，而且面试官很严肃</p>
<p>四面:电话hr面<br>1.做一下自我介绍;<br>2.你在一年时间内又要做项目又要自学计算机基础又要打比赛，时间是怎么分配的?<br>3.你是哪里人?未来打算在哪里发展?<br>4.现在拿到几个offer了?<br>5.最早能过来实习的时间?实习时长?<br>6.还有什么要问的吗?<br>hr小姐姐人很好，感觉放轻松聊天就好了</p>
<p>作者：A1kaid<br>链接：<a href="https://www.nowcoder.com/discuss/395060?type=0&amp;order=0&amp;pos=13&amp;page=1" target="_blank" rel="noopener">https://www.nowcoder.com/discuss/395060?type=0&amp;order=0&amp;pos=13&amp;page=1</a><br>来源：牛客网</p>
<p>事业群：CSIG 在线教育部</p>
<p>Base：深圳</p>
<p>技术栈：半路出家学了半年的C++、学了一年的Python</p>
<p>个人项目是烂大街的服务器和一个外包🤣</p>
<p>团队项目是两个和数据挖掘相关的项目🤣</p>
<h2 id="电话一面-40min"><a href="#电话一面-40min" class="headerlink" title="电话一面(40min)"></a>电话一面(40min)</h2><p>项目介绍<br>小根堆计时器是怎么样的机制<br>优先队列和map的区别是什么<br>vector的内部结构<br>如何避免vector的动态扩容<br>vector越界访问会怎么样<br>红黑树的规则<br>红黑树的增删改查的时间复杂度<br>往map里面增加或删除元素是怎么实现的<br>智能指针是自己实现的吗<br>如何实现智能指针<br>智能指针的引用计数如何确保线程安全<br>怎么实现原子操作<br>RAII机制具体是什么含义<br>日志系统的相关问题<br>线程池是怎么使用的<br>长连接过程中线程一直持有连接对象吗<br>有用过什么数据库<br>数据库的字段类型是如何设计的<br>用的是什么数据库引擎<br>Innodb和MyISAM的区别<br>varchar最大长度是多少<br>varchar如果长度超过了怎么办<br>Linux常用的命令<br>压测如何查看在哪里达到瓶颈<br>有什么问题？</p>
<h3 id="总结：一面的时候挺突然的，所以也没多准备，主要围绕的是简历上的项目来问，中间夹杂着一些基础的询问，所以最终结果也还好，最后询问的时候面试官也肯定了我的C-基础不错，并且说了会有下一面。"><a href="#总结：一面的时候挺突然的，所以也没多准备，主要围绕的是简历上的项目来问，中间夹杂着一些基础的询问，所以最终结果也还好，最后询问的时候面试官也肯定了我的C-基础不错，并且说了会有下一面。" class="headerlink" title="总结：一面的时候挺突然的，所以也没多准备，主要围绕的是简历上的项目来问，中间夹杂着一些基础的询问，所以最终结果也还好，最后询问的时候面试官也肯定了我的C++基础不错，并且说了会有下一面。"></a>总结：一面的时候挺突然的，所以也没多准备，主要围绕的是简历上的项目来问，中间夹杂着一些基础的询问，所以最终结果也还好，最后询问的时候面试官也肯定了我的C++基础不错，并且说了会有下一面。</h3><h2 id="视频二面-40min"><a href="#视频二面-40min" class="headerlink" title="视频二面(40min)"></a>视频二面(40min)</h2><p>自我介绍<br>有用过部门的产品吗？<br>讲一讲团队项目？为什么要使用这些算法？算法是如何挑选的<br>讲讲DBSCAN和KMeans算法的区别，讲一下你理解的DS证据理论<br>介绍项目<br>EPOLL和Select的区别<br>为什么要使用边缘触发模式<br>EPOLL ET和LT的区别<br>ET模式下，要遵循哪些规范<br>Reactor和Proactor模式的区别<br>如何保证线程安全<br>请求进入之后是如何处理的<br>Time-wait状态过多会有什么后果，怎么处理？<br>长连接和短连接之间是如何处理的<br>为什么采用小根堆的优先队列作为定时器<br>对请求报文的解析是自己写的还是调用库，难度在哪<br>日志系统是如何保证高并发的<br>日志系统如何保证线程安全<br>有看过其他开源服务器吗<br>Nginx的请求处理流程<br>目前有投什么公司<br>为什么CVTE刷了你 (HR面刷的- -无语)<br>头条和腾讯选择哪个</p>
<h3 id="总结：一开始的时候也没想到面试官会问我的团队项目里面的算法内容-不过好在之前有特地的去看过相关的，所以答的也还算是流畅。可能是因为这个所以整个面试流程下来完全没撕代码？"><a href="#总结：一开始的时候也没想到面试官会问我的团队项目里面的算法内容-不过好在之前有特地的去看过相关的，所以答的也还算是流畅。可能是因为这个所以整个面试流程下来完全没撕代码？" class="headerlink" title="总结：一开始的时候也没想到面试官会问我的团队项目里面的算法内容- -不过好在之前有特地的去看过相关的，所以答的也还算是流畅。可能是因为这个所以整个面试流程下来完全没撕代码？"></a>总结：一开始的时候也没想到面试官会问我的团队项目里面的算法内容- -不过好在之前有特地的去看过相关的，所以答的也还算是流畅。可能是因为这个所以整个面试流程下来完全没撕代码？</h3><p>这篇文章主要记述了任务任务任务计划。</p>
<p><a href="https://ww2.mathworks.cn/help/vision/examples/3-d-point-cloud-registration-and-stitching.html" target="_blank" rel="noopener">使用Matlab而成的三维点云拼接</a></p>
<p><img src="https://i.loli.net/2020/03/30/WHd5bxqghvMPYZS.png" alt="image-20200321224600477"></p>
<p><img src="https://i.loli.net/2020/03/30/81xUy9uWBJiPnsD.png" alt="image-20200321224546995"></p>
<h2 id="Task0317"><a href="#Task0317" class="headerlink" title="Task0317"></a>Task0317</h2><p>你根据偏振成像的基本推导出发，并研究下我那天找的利用法向量重建三维代码，因为要解决歧义问题，你看看最后学弟讲的那篇解决歧义的论文，也可以找其他文章，写一个文档，看看有哪些难点等等。Matlab 这周</p>
<p><img src="https://i.loli.net/2020/03/30/c41tbqZzymFhJDL.png" alt="image-20200321230918065"></p>
<p>Dng格式的raw图解析完，获取的数据是bayer格式，在ISP流程中是有一个算法模块叫Demosaic，专门用于将Bayer格式转为RGB格式，该code只用于简单的demosaic处理</p>
<p><img src="https://i.loli.net/2020/03/30/KLsXmRiGtx8EDu2.png" alt="image-20200321230233521"></p>
<p><img src="https://i.loli.net/2020/03/30/ZvCDy5wTHlVNqIQ.png" alt="image-20200321230254146"></p>
<p>However, if you have full gradient information you are better off with the Frankot Chellappa algorithm below.</p>
<p>???full gradient information</p>
<p>高级计算机视觉–猫狗合成Python 这周</p>
<p>Linux – kgdb调试C 这周</p>
<p>图像处理 – 作业处理项目 – 移植代码C++ 这周</p>
<p>互联网络程序设计 – socket 编程C</p>
<p> GPU并行编程 – C</p>
<p><a href="https://www.researchgate.net/figure/Relationship-between-zenith-angle-and-degree-of-polarization_fig1_216360513" target="_blank" rel="noopener">Relationship between zenith angle and degree of polarization</a></p>
<p><img src="https://i.loli.net/2020/03/30/K9fR5S3ozNuBg7m.png" alt="image-20200321185717592"></p>
<p><img src="https://i.loli.net/2020/03/30/mT5zoSgWrCFvEHu.png" alt="image-20200321185735672"></p>
<p><img src="https://i.loli.net/2020/03/30/iTNkvDM97sZX6dW.png" alt="image-20200325222316687"></p>
<h2 id="0327多线程直播"><a href="#0327多线程直播" class="headerlink" title="0327多线程直播"></a>0327多线程直播</h2><p>今天参加了小方的多线程直播课程，印象里比较深刻的是他讲述了基础的重要性例如虚假唤醒的原语等，还讲述了他的flamingo客户端与服务器端代码，下面这幅图为什么810行使用while而不是使用if的原因是为了防止虚假唤醒：如果wait因为虚假唤醒而跳出等待，结果还有一个while等着它呢！</p>
<p><img src="https://i.loli.net/2020/03/30/JRF2KkXTiz3vhE8.png" alt="image-20200328223725660"></p>
<p><img src="https://i.loli.net/2020/03/30/RHtn946iqMKSrg5.png" alt="image-20200328232442727"></p>
<p><img src="https://i.loli.net/2020/03/30/HorCyUVqATIQ8BF.png" alt="image-20200328232448066"></p>
<p><img src="https://i.loli.net/2020/03/30/sMkQgROAjo2xLy7.png" alt="image-20200328232458226"></p>
<p><img src="https://i.loli.net/2020/03/29/MrXK23Qbg8wuyem.png" alt="image-20200328232437290.png"></p>
<p><img src="https://i.loli.net/2020/03/29/U4SpBovcEZOCNaY.png" alt="image-20200328232453922"></p>
<h2 id="SIFT"><a href="#SIFT" class="headerlink" title="SIFT"></a>SIFT</h2><p><img src="https://i.loli.net/2020/03/29/ejXwdJAVOLxh9PR.png" alt="1581908329661"></p>
<p><img src="https://i.loli.net/2020/03/29/LazNSDw42nrmdfq.png" alt="1581908309724"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/16/2020-03-16-Python/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/16/2020-03-16-Python/" itemprop="url">Python应用技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-16T16:31:18+08:00">
                2020-03-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了Python应用的一些笔记。</p>
<h2 id="1、Python操作Excel简化操作"><a href="#1、Python操作Excel简化操作" class="headerlink" title="1、Python操作Excel简化操作"></a>1、Python操作Excel简化操作</h2><p>需求：从Excel表中提取出人的名字看看其在线时间是否满足100min，用来判定其有没有上课。Excel格式为CSV后缀的。</p>
<p>输入：人的名字（文本形式）</p>
<p>输出：排序好的excel表</p>
<p>若文本中的名字存在，打印出该行值</p>
<blockquote>
<p><strong>逗号分隔值</strong>（Comma-Separated Values，<strong>CSV</strong>，有时也称为<strong>字符分隔值</strong>，因为分隔字符也可以不是逗号），其文件以<a href="https://zh.wikipedia.org/wiki/纯文本" target="_blank" rel="noopener">纯文本</a>形式存储<a href="https://zh.wikipedia.org/wiki/表格" target="_blank" rel="noopener">表格</a>数据（数字和文本）。纯文本意味着该文件是一个<a href="https://zh.wikipedia.org/wiki/字符" target="_blank" rel="noopener">字符</a>序列，不含必须像二进制数字那样被解读的数据。CSV文件由任意数目的<a href="https://zh.wikipedia.org/wiki/记录" target="_blank" rel="noopener">记录</a>组成，记录间以某种换行符分隔；每条记录由<a href="https://zh.wikipedia.org/w/index.php?title=字段&action=edit&redlink=1" target="_blank" rel="noopener">字段</a>组成，字段间的分隔符是其它字符或字符串，最常见的是逗号或<a href="https://zh.wikipedia.org/wiki/制表键#定位字符" target="_blank" rel="noopener">制表符</a>。通常，所有记录都有完全相同的字段序列。</p>
</blockquote>
<p>参考代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> xlrd <span class="comment">#Excel Read</span></span><br><span class="line"><span class="keyword">import</span> xlwt <span class="comment">#Excel Write</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_excel</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 打开文件</span></span><br><span class="line">    workbook = xlrd.open_workbook(<span class="string">r'0311.xls'</span>)</span><br><span class="line">    <span class="comment"># 获取所有sheet</span></span><br><span class="line">    sheet_name = workbook.sheet_names()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 根据sheet索引或者名称获取sheet内容</span></span><br><span class="line">    sheet = workbook.sheet_by_index(<span class="number">0</span>)  <span class="comment"># sheet索引从0开始</span></span><br><span class="line">    </span><br><span class="line">    name_list = open(<span class="string">'name.txt'</span>)</span><br><span class="line">    <span class="comment"># 创建excel文件</span></span><br><span class="line">    filename = xlwt.Workbook()</span><br><span class="line">    <span class="comment"># 给工作表命名，test</span></span><br><span class="line">    sheet_write = filename.add_sheet(<span class="string">"test"</span>)</span><br><span class="line">    <span class="comment"># print (str(name).decode("unicode_escape").encode("utf8"))</span></span><br><span class="line">    <span class="comment"># if name[2] != "unknow":</span></span><br><span class="line">    <span class="comment"># if int(name[2]) &gt; 100:#如果在线时间大于100</span></span><br><span class="line">    <span class="comment"># print (name[2])</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        row = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            line = name_list.readline()<span class="comment"># 从文本逐行读取名字</span></span><br><span class="line">            <span class="keyword">if</span> line:</span><br><span class="line">                line = line.strip(<span class="string">'\n'</span>)<span class="comment">#去除换行符</span></span><br><span class="line">                <span class="keyword">for</span> rown <span class="keyword">in</span> range(sheet.nrows):</span><br><span class="line">                    name = sheet.row_values(rown)  <span class="comment"># 获取第rown行内容</span></span><br><span class="line">                    <span class="keyword">if</span> line <span class="keyword">in</span> name[<span class="number">0</span>]:</span><br><span class="line">                        row = row + <span class="number">1</span></span><br><span class="line">                        <span class="keyword">for</span> cols <span class="keyword">in</span> [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]:</span><br><span class="line">                            sheet_write.write(row, cols, name[cols])</span><br><span class="line">                            <span class="keyword">print</span> (str(name).decode(<span class="string">"unicode_escape"</span>).encode(<span class="string">"utf8"</span>))</span><br><span class="line">                                    <span class="comment">#print (str(name[0])</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        filename.save(<span class="string">"0311_sort.xls"</span>)</span><br><span class="line">        name_list.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 读取Excel</span></span><br><span class="line">    read_excel();</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'----读取成功----'</span>)</span><br></pre></td></tr></table></figure>



<h2 id="2、Python-Numpy"><a href="#2、Python-Numpy" class="headerlink" title="2、Python Numpy"></a>2、Python Numpy</h2><p><img src="https://i.loli.net/2020/03/30/GDkBnV4L1hesg3l.png" alt="image-20200322222621682"></p>
<h3 id="2-1-numpy中-？"><a href="#2-1-numpy中-？" class="headerlink" title="2.1 numpy中 **  ？"></a>2.1 numpy中 **  ？</h3><p>就是给里面每个元素开平方的意思</p>
<p>It’s just the square of each element.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> *</span><br><span class="line">a = arange(<span class="number">4</span>).reshape((<span class="number">2</span>,<span class="number">2</span>))</span><br><span class="line"><span class="keyword">print</span> a**<span class="number">2</span></span><br><span class="line">--- prints</span><br><span class="line">--- [[<span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">--- [<span class="number">4</span> <span class="number">9</span>]]</span><br></pre></td></tr></table></figure>

<h3 id="2-2-Numpy-基本除法运算和模运算"><a href="#2-2-Numpy-基本除法运算和模运算" class="headerlink" title="2.2 Numpy 基本除法运算和模运算"></a>2.2 Numpy 基本除法运算和模运算</h3><p># divide函数在整数和浮点数除法中均只保留整数部分(python3中的np.divide == np.true_divide)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = np.array([<span class="number">2</span>,<span class="number">6</span>,<span class="number">5</span>])</span><br><span class="line">b = np.array([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line"><span class="keyword">print</span> (np.divide(a,b),np.divide(b,a))</span><br><span class="line"><span class="comment"># (array([2, 3, 1]), array([0, 0, 0]))</span></span><br></pre></td></tr></table></figure>


<p># true_divide函数与数学中的除法定义更为接近，即返回除法的浮点数结果而不作截断</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (np.true_divide(a,b),np.true_divide(b,a))</span><br><span class="line"><span class="comment"># (array([ 2. , 3. , 1.66666667]), array([ 0.5 , 0.33333333, 0.6 ]))</span></span><br></pre></td></tr></table></figure>

<p># floor_divide函数总是返回整数结果，相当于先调用divide函数再调用floor函数(floor函数将对浮点数进行向下取整并返回整数)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (np.floor_divide(a,b),np.floor_divide(b,a))</span><br><span class="line"><span class="comment"># [2 3 1] [0 0 0]</span></span><br><span class="line">c = <span class="number">3.14</span> * b</span><br><span class="line"><span class="keyword">print</span> (np.floor_divide(c,b),np.floor_divide(b,c))</span><br><span class="line"><span class="comment"># [ 3. 3. 3.] [ 0. 0. 0.]</span></span><br></pre></td></tr></table></figure>

<p># /运算符相当于调用divide函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (a/b,b/a)</span><br><span class="line"><span class="comment"># (array([2, 3, 1]), array([0, 0, 0]))</span></span><br></pre></td></tr></table></figure>

<p># 运算符//对应于floor_divide函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (a//b,b//a)</span><br><span class="line"><span class="comment"># [2 3 1] [0 0 0]</span></span><br><span class="line"><span class="keyword">print</span> (c//b,b//c)</span><br><span class="line"><span class="comment"># [ 3. 3. 3.] [ 0. 0. 0.]</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>模运算<br># 计算模数或者余数，可以使用NumPy中的mod、remainder和fmod函数。也可以用%运算符</li>
</ol>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure>

<p># remainder函数逐个返回两个数组中元素相除后的余数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">d = np.arange(<span class="number">-4</span>,<span class="number">4</span>)</span><br><span class="line"><span class="keyword">print</span> (np.remainder(d,<span class="number">2</span>))</span><br><span class="line"><span class="comment"># [0 1 0 1 0 1 0 1]</span></span><br></pre></td></tr></table></figure>

<p># mod函数与remainder函数的功能完全一致</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (np.mod(d,<span class="number">2</span>))</span><br><span class="line"><span class="comment"># [0 1 0 1 0 1 0 1]</span></span><br></pre></td></tr></table></figure>

<p># %操作符仅仅是remainder函数的简写(功能一样)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> ( d % <span class="number">2</span> )</span><br><span class="line"><span class="comment"># [0 1 0 1 0 1 0 1]</span></span><br></pre></td></tr></table></figure>

<p># fmod函数处理负数的方式与remainder、mod和%不同。所得余数的正负由被除数决定，与除数的正负无关</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">print</span> (np.fmod(d,<span class="number">2</span>))</span><br><span class="line"><span class="comment"># [ 0 -1 0 -1 0 1 0 1]</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3、Numpy-中clip函数的使用"><a href="#2-3、Numpy-中clip函数的使用" class="headerlink" title="2.3、Numpy 中clip函数的使用"></a>2.3、Numpy 中clip函数的使用</h3><p>numpy.clip(a, a_min, a_max, out=None)[source]</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy as np</span><br><span class="line">x=np.<span class="built_in">array</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>])</span><br><span class="line">np.clip(x,<span class="number">3</span>,<span class="number">8</span>)</span><br><span class="line">Out[<span class="number">88</span>]:</span><br><span class="line"><span class="built_in">array</span>([<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">8</span>])</span><br></pre></td></tr></table></figure>

<p>也就是说clip这个函数将将数组中的元素限制在a_min, a_max之间，大于a_max的就使得它等于 a_max，小于a_min,的就使得它等于a_min。</p>
<h2 id="3、通过图片修改时间重命名"><a href="#3、通过图片修改时间重命名" class="headerlink" title="3、通过图片修改时间重命名"></a>3、通过图片修改时间重命名</h2><p>3.1 、Q：os.rename()导致WindowsError: [Error 183]的问题</p>
<p>A：Error 183是文件已经存在错误,要更改成的文件的名字已经存在，换一个不冲突的名称就可以了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> nt <span class="keyword">import</span> chdir</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用到的知识</span></span><br><span class="line"><span class="comment"># os.path.getatime(file) 输出文件访问时间</span></span><br><span class="line"><span class="comment"># os.path.getctime(file) 输出文件的创建时间</span></span><br><span class="line"><span class="comment"># os.path.getmtime(file) 输出文件最近修改时间</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">renameF</span><span class="params">(preName, newName)</span>:</span></span><br><span class="line">    chdir(os.path.dirname(preName))</span><br><span class="line">    os.rename(preName, newName)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    source_dir = <span class="string">"./"</span></span><br><span class="line">    output_dir = <span class="string">"./outputImages/"</span></span><br><span class="line">    g = os.walk(source_dir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> path, dir_list, file_list <span class="keyword">in</span> g:</span><br><span class="line">        <span class="keyword">for</span> file_name <span class="keyword">in</span> file_list:</span><br><span class="line">            cnt = random.randint(<span class="number">100</span>,<span class="number">999</span>)</span><br><span class="line">            TIME = str(datetime.datetime.fromtimestamp(os.path.getmtime(file_name)).strftime(<span class="string">'%Y%m%d%H%M%S'</span>))</span><br><span class="line">            NAME = <span class="string">"image-"</span> + TIME + str(cnt) + <span class="string">".png"</span>;</span><br><span class="line">            <span class="comment"># print (os.path.join(source_dir, file_name))</span></span><br><span class="line">            os.rename(file_name, NAME)</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/15/2020-03-15-EmbeddedSystem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/15/2020-03-15-EmbeddedSystem/" itemprop="url">Embedded_System</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-15T12:16:18+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C-C-Embedded/" itemprop="url" rel="index">
                    <span itemprop="name">C/C++ Embedded</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了嵌入式系统的一些笔记。</p>
<p><img src="https://i.loli.net/2020/03/30/OAK3RvSBZ5pMqEF.png" alt="1583135575292"></p>
<h2 id="NandFlash与NorFlash的区别"><a href="#NandFlash与NorFlash的区别" class="headerlink" title="NandFlash与NorFlash的区别"></a>NandFlash与NorFlash的区别</h2><p><img src="https://i.loli.net/2020/03/30/JnTlka8t6hqpEvr.png" alt="1584345668683"></p>
<p><img src="https://i.loli.net/2020/03/30/n1cMJYev75dIQmg.png" alt="1584345681200"></p>
<h2 id="STM32"><a href="#STM32" class="headerlink" title="STM32"></a>STM32</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OSTaskCreate(start_task,(<span class="keyword">void</span> *)<span class="number">0</span>,(OS_STK *)&amp;START_TASK_STK[START_STK_SIZE<span class="number">-1</span>],START_TASK_PRIO );</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个函数用来管理任务的执行，任务可以在多任务开始或运行之前被创建。</span></span><br><span class="line"></span><br><span class="line"><span class="function">INT8U  <span class="title">OSTaskCreate</span> <span class="params">(<span class="keyword">void</span>   (*task)(<span class="keyword">void</span> *p_arg),</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">​                     <span class="keyword">void</span>    *p_arg,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">​                     OS_STK  *ptos,</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">​                     INT8U    prio)</span></span></span><br></pre></td></tr></table></figure>

<p>第一个参数一个指针，也就是用户代码的首地址; 在平时使用中我们把自己创建的任务的名字作为这个参数就可以了； 第三个参数是指向任务堆栈栈顶的指针，通常我们把创建的任务的堆栈数组的首地址给第三个参数就可以了；第四个参数是任务的优先级；</p>
<p>void   (*task)(void *p_arg)——-&gt; 定义了一个指向函数的指针task，所指向的函数无返回值，参数为可指向任意类型的指针；</p>
<p>普通的禁止和使能中断，在禁止中断时有触发中断的事件发生，当使能中断时该中断不会在响应，说明普通的禁止中断是阻止了中断的发生。</p>
<p>而在进入临界段时，有中断发生，在退出临界段时中断会得到响应，说明临街段只是延迟了中断的响应时间，并没有真正的阻止中断。</p>
<h3 id="VCZH大佬"><a href="#VCZH大佬" class="headerlink" title="VCZH大佬"></a>VCZH大佬</h3><p>&lt; &gt;引用的是编译器的类库路径里面的头文件</p>
<p>“ “引用的是你程序目录的<a href="https://www.baidu.com/s?wd=相对路径&tn=44039180_cpr&fenlei=mv6quAkxTZn0IZRqIHckPjm4nH00T1YvmWw-rycYrHIBPj9WPARd0ZwV5Hcvrjm3rH6sPfKWUMw85HfYnjn4nH6sgvPsT6KdThsqpZwYTjCEQLGCpyw9Uz4Bmy-bIi4WUvYETgN-TLwGUv3EPjc4rjndP1f4" target="_blank" rel="noopener">相对路径</a>中的头文件</p>
<p><img src="https://i.loli.net/2020/03/30/o5bcml1y2hHi63a.png" alt="1576645965036"></p>
<p><img src="https://i.loli.net/2020/03/30/F85vsyDShmIuOLe.jpg" alt=""></p>
<p>C语言定义变量后面加冒号，数字什么意思?</p>
<p>该种形式出现于结构体或共用体的定义中，是位域定义的标准形式。</p>
<p>其使用方式为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">name</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">type var_name : n;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>含义为，在结构体name汇总，成员变量var_name占用空间为n位。</p>
<p>n为正整数，其值必须小于type类型占用的位数。比如type如果是int，占4字节32位，那么n必须是1~31之间的整数。</p>
<p>对于位域类型的成员，在赋值时如果实际值超过n位所能表达的范围，那么超出部分将会被截掉，只保存低位值。如int var:4,本身只有4位的空间，如果赋值var = 20, 由于20的二进制值为10100，实际为五位，这时var实际被赋值的就是低四位，0100，即4。</p>
<p>由于C语言中的地址是针对字节计算的，所以位域类型的成员变量不支持取地址操作，即对于变量v, 如果存在位域成员变量var，那么&amp;a.var是非法的，编译会出错。</p>
<p><img src="https://i.loli.net/2020/03/30/l1gSMzWcPZXrGYa.png" alt="1576646119827"></p>
<p><img src="https://i.loli.net/2020/03/30/AF2cbheZV3YMv8i.png" alt="1576646134031"></p>
<p>那为什么要叫TCP/IP协议栈内，这些协议和栈有什么关系呢，大家应该都知道栈是一种先进后出的数据结构，那这和TCP/IP协议有什么关系呢？我们就拿一个HTTP报文来说吧，HTTP报文属于应用层协议的报文，我们输入网址，首先会调用到DNS协议（域名协议，后面会讲到），然后把我们输入的网址转换为IP地址，这个IP地址大致就相当于现实生活中每个人的身份证一样，是每个网页唯一的标识，关于IP地址，后续我会详细介绍，IP协议属于网络层的协议。我们先将HTTP报文压入一个栈中（就好像是在分装报文），然后是IP，不对，我们貌似漏了一个传输层啊，别急别介，HTTP报文在传输层用的是TCP协议，好，我们把TCP压入栈中，再讲IP层也压入栈中，至于链路层的话，就用最常见的以太网就OK了，好了，现在我们的栈里面从头至尾依次是以太帧头-IP协议-TCP协议-HTTP协议，然后我们先忽略最底层的物理层，假设这个封装好的栈一样的报文漂洋过海，来到了它的目的地（至于怎么过来的，我们后续也会讲到），当对端收到这个报文以后，也就是我们封装好的这个栈一样的东西以后该怎么办呢？会不会也是先拿HTTP呢？因为这个报文是我们构造的一个栈，所以说它的顺序肯定也是栈，因此拿取的顺序就是以太帧头-IP协议-TCP协议-HTTP协议，发现没，最先被封装入的HTTP报文是最后才被拿出来的，这中间的细节如果能全部掌握，那基本商就算是入门了，关于这部分东西，我会在后面详细介绍，现在有这个概念就可以了</p>
<p><img src="https://i.loli.net/2020/03/30/TyvP24FAzuBcQ9g.png" alt="1576646164341"></p>
<p><img src="https://i.loli.net/2020/03/30/1LgXTeqvRxWmznf.png" alt="1576646175250"></p>
<p><img src="https://i.loli.net/2020/03/30/rf7C3MPA2eTIUg1.png" alt="image-20200330195249657"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/09/2020-03-09-ImageProcessCV/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/09/2020-03-09-ImageProcessCV/" itemprop="url">图像处理与视频分析的笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-09T10:16:18+08:00">
                2020-03-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了图像处理与视频分析的一些笔记。</p>
<p><img src="https://i.loli.net/2020/03/29/LQ1ElHr5utv6wVo.png" alt=""></p>
<h2 id="卷积"><a href="#卷积" class="headerlink" title="卷积"></a>卷积</h2><p>数字图像处理第一课，卷积也叫模板匹配（后者就好理解了）。比如有一张包含人脸的图像，如果你拿一个和它一模一样的模板和它卷积，只有当模板滑动到人脸上的时候产生的响应是最大的。</p>
<p>模板匹配就是在大图中找小图，也就说在一幅图像中寻找另一幅模板图像的位置</p>
<p><img src="https://i.loli.net/2020/03/29/GemhlwytQV26dCS.png" alt="1583803163978"></p>
<p>整幅图像的响应如下图，越亮的地方响应越大，正是人脸被匹配的地方，</p>
<p><img src="https://i.loli.net/2020/03/29/Czr5m6Lt3K2xcTE.png" alt="1583803192621"></p>
<h2 id="傅里叶级数与变换"><a href="#傅里叶级数与变换" class="headerlink" title="傅里叶级数与变换"></a>傅里叶级数与变换</h2><p>傅里叶级数是针对周期性函数分解成正弦与余弦函数加和：其中频谱和相位谱都是离散的（相位谱就是正弦函数从哪个度数开始分解的，也就是相位）</p>
<p><img src="https://i.loli.net/2020/03/29/Wr6TonlXmSDg8JY.png" alt="1583762624300"></p>
<p>傅里叶变换是针对非周期性函数进行分解，其中利用了欧拉公式的概念，其中频谱和相位谱都是连续的，所以使用了积分</p>
<p><img src="https://i.loli.net/2020/03/29/xlcsPt5Lr4OKJg3.png" alt="1583762608395"></p>
<p>n<strong>空间是三维的，图像是二维的，因此空间中物体在另一个维度上的关系就必须由梯度来表示。</strong></p>
<blockquote>
<p>当然，更重要的意义在于复数运算保留了二维信息。假如我让你计算3+5，虽然你可以轻松的计算出8，但是如果让你分解8你会有无数种分解的方法，3和5原始在各自维度上的信息被覆盖了。<br>但是计算3+5i的话，你依然可以分解出实部和虚部，就像上图那样。基于以上两个理由，用复数来描述电场与磁场简直完美到爆棚！<br>我们即可以让电场强度与复数磁场强度相加而不损失各自的信息，又满足了电场与磁场90度垂直的要求。另外，一旦我们需要让任何一个场旋转90度，只要乘一个“i”就可以了</p>
</blockquote>
<p><img src="https://i.loli.net/2020/03/29/JYAXVhyWIqENZCK.jpg" alt=""></p>
<p><img src="https://i.loli.net/2020/03/29/jSQH4AFwTLR7EkC.gif" alt="Fourier_series_square_wave_circles_animation"></p>
<p><img src="https://i.loli.net/2020/03/29/Jb1NsPBE6MDo4K5.png" alt=""></p>
<p><img src="https://i.loli.net/2020/03/29/1BqD9X5CYzPNEMl.png" alt="1583120066486"></p>
<p><img src="https://i.loli.net/2020/03/30/5Bzd1ai6f8XreU7.png" alt="1583120081343"></p>
<p>对比度：最高值/最低值亮度</p>
<p><img src="https://i.loli.net/2020/03/29/Lol5gGtI6pqAYbK.png" alt="1583120235702"></p>
<p><img src="https://i.loli.net/2020/03/29/dbSviEHRD4U87r5.png" alt="1583120275933"></p>
<p>中值滤波就是取一个窗口排序中间像素的灰度值作为当前像素的灰度值，所以在面对椒盐噪声时由于椒盐噪声就是黑白差异很大的点肯定不会在排序的中间，处理效果较好。</p>
<p><img src="https://i.loli.net/2020/03/29/Wfl4J6mI358pRNw.png" alt="1583462273037"></p>
<p><img src="https://i.loli.net/2020/03/29/PkjKEndWhywIGZ6.png" alt="1583462410564"></p>
<h2 id="高通滤波"><a href="#高通滤波" class="headerlink" title="高通滤波"></a>高通滤波</h2><p>中间比较粗用多圈的滤波器</p>
<p><img src="https://i.loli.net/2020/03/29/ceTdXmZtYDjFRQK.png" alt="1583721403547"></p>
<p><img src="https://i.loli.net/2020/03/29/Rjme4ygfMbuYkcD.png" alt="1583895066834"></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="为什么用齐次坐标？"><a href="#为什么用齐次坐标？" class="headerlink" title="为什么用齐次坐标？"></a>为什么用齐次坐标？</h2><p><img src="https://i.loli.net/2020/03/29/keny1zaYUdqwKJ4.png" alt="1583908903979"></p>
<p>用四维矩阵能更好的表示，如果用三维的话x怎么减TX？所以表示起来比较统一</p>
<p><img src="https://i.loli.net/2020/03/29/GeKl6O1axRkiZT7.png" alt="1583909031048"></p>
<p><img src="https://i.loli.net/2020/03/30/oj7V2dzcyh6vHZM.png" alt="1583910982943"></p>
<h2 id="傅里叶频谱"><a href="#傅里叶频谱" class="headerlink" title="傅里叶频谱"></a>傅里叶频谱</h2><p>仔细观察这幅图，频谱就是一幅图片各个频率的条纹？波分解出来的频率-幅值（也有频率-相位）图，只不过是将原点移位到了图像中心。下面这幅图可以看见有明显的横向条纹，你可以把它想象成频率很小的波，为什么很小呢？因为你都肉眼可见了，频率肯定比那些肉眼不可见的条纹频率小了啊。所以在频谱图上的体现就是靠近原点的小范围内的幅值出现了白色的竖直条纹：白色代表值很高 啊。去掉这些竖直白色条纹之后效果好多了吧哈哈~</p>
<p><img src="https://i.loli.net/2020/03/29/QKo5IV2duZpWfJz.png" alt="1584071227285"></p>
<p><img src="https://i.loli.net/2020/03/29/WaSvxglpwyZJ6rY.png" alt="1584071419230"></p>
<h2 id="Cannny边缘检测"><a href="#Cannny边缘检测" class="headerlink" title="Cannny边缘检测"></a>Cannny边缘检测</h2><p>边缘检测就是靠边缘像素突变进行检测的。可以利用一阶偏导来检测这个突变。步骤如下：</p>
<p>第一步目的是滤波，如果图像中存在噪声，就会导致一阶导数不平滑，进而导致边缘的误检测。</p>
<p>第二步的目的是求二阶偏导：先求x方向的偏导，再求Y方向的偏导；最后再合成出梯度图，找到梯度方向，把XY方向的两幅图进行叠加会发现边缘有的变胖了，如图中的美女的腿</p>
<p>第三步的目的是让边缘变瘦，你的像素强度肯定是最亮的，直接忽略掉他们选择自己就行了。如果梯度方向上不存在什么临近的邻居点，可以通过插值的方式（灰色的点就是左右黑色像素插值插出来的）来进行找邻居点</p>
<p>第四步的目的是利用延滞性来让粗的边后面紧接着的边不要突然变得那么细，好让他稍微连续一点。</p>
<p><img src="https://i.loli.net/2020/03/29/5ydvkmcprGHxDK4.png" alt="image-20200318211947596"></p>
<p><img src="https://i.loli.net/2020/03/29/MfN9ywCEmLQtSzp.png" alt="image-20200318212351664"></p>
<p><img src="https://i.loli.net/2020/03/29/cyzf4n57aWKNsQD.png" alt="image-20200318212543634"></p>
<p><img src="https://i.loli.net/2020/03/29/wi8aVJrkDZCSetv.png" alt="image-20200318212404405"></p>
<p><img src="https://i.loli.net/2020/03/29/k8Zpm3R6ohXE4FY.png" alt="image-20200318212554994"></p>
<p><img src="https://i.loli.net/2020/03/29/EWbTVU72Z9tdwpv.png" alt="1583219058702"></p>
<h2 id="特征点检测"><a href="#特征点检测" class="headerlink" title="特征点检测"></a>特征点检测</h2><p><img src="https://i.loli.net/2020/03/29/U2WI8HvEXL1Cg4b.png" alt="image-20200319195331162"></p>
<h2 id="直方图规定化的实现"><a href="#直方图规定化的实现" class="headerlink" title="直方图规定化的实现"></a>直方图规定化的实现</h2><p>直方图均衡化是将原图像的直方图通过变换函数修正为均匀的直方图， 然后按均衡直方图修正原<br>图像。图像均衡化处理后，图像的直方图是平直的，即各灰度级具有近似相同的出现频数。那么，由于灰度级具有均匀的概率分布，图像看起来就更清晰了。直方图均衡化通常用来增加许多图像的局部对比度，尤其是当图像的有用数据的对比度相当接近的时候。通过这种方法，亮度可以更好地在直方图上分布。这样就可以用于增强局部的对比度而不影响整体的对比度，</p>
<p><img src="https://i.loli.net/2020/03/29/6Q3IA1DTVdfeOPx.png" alt="1583635716616"></p>
<p>直方图规定化的实现可以分为一下三步：</p>
<ul>
<li>计算原图像的累积直方图</li>
<li>计算规定直方图的累积直方图</li>
<li>计算两累积直方图的差值的绝对值</li>
<li>根据累积直方图差值建立灰度级的映射</li>
</ul>
<p><img src="https://i.loli.net/2020/03/29/s4ficKjC35TnHG9.png" alt="image-20200320095548295"></p>
<p><img src="https://i.loli.net/2020/03/29/bzfmiWqpRI4oevH.png" alt="image-20200320095640085"></p>
<p><img src="https://i.loli.net/2020/03/29/OasYy1k2oNUXHZP.png" alt="image-20200320095654277"></p>
<p><img src="https://i.loli.net/2020/03/29/K8spTLgZ9VPaS1Y.png" alt="image-20200320095708679"></p>
<h2 id="直方图均衡化"><a href="#直方图均衡化" class="headerlink" title="直方图均衡化"></a>直方图均衡化</h2><p>BINS<br>BINS：上面的直方图显示了每个像素值的像素数，从0到255。您需要256个值来显示以上的直方图。但是，考虑一下，如果您不需要单独查找所有像素值的像素数量，而是在一个像素值区间内的像素数量，该怎么办？例如，你需要找到介于0到15之间的像素数，然后是16到31……240到255。您只需要16个值来表示这个直方图。OpenCV Tutorials on histograms中展示了这个例子。</p>
<p>所以你要做的就是把整个直方图分成16个子部分，每个子部分的值是所有像素数的和。每个子部分都被称为“BIN”。在第一种情况下，BINS的数量是256(每个像素一个)，而在第二种情况下，它只有16个。在OpenCV文档中，用术语 histSize 表示 BINS</p>
<h4 id="DIMS"><a href="#DIMS" class="headerlink" title="DIMS"></a>DIMS</h4><p>DIMS：它是我们收集数据的参数的个数。在这种情况下，我们收集的数据只有一件事，强度值。所以这里是1。</p>
<h4 id="RANGE"><a href="#RANGE" class="headerlink" title="RANGE"></a>RANGE</h4><p>RANGE：它是你想测量的强度值的范围。通常，它是 [ 0，256 ]，也就是所有的强度值。</p>
<p><img src="https://i.loli.net/2020/03/30/UtedMlqc7QNEKrR.png" alt="image-20200320102057476"></p>
<h1 id="关于命名空间"><a href="#关于命名空间" class="headerlink" title="关于命名空间"></a>关于命名空间</h1><p>命名空间是可以不断进行扩充的，并不是一次就定义好命名空间里所有的东西。</p>
<p>尽量少的使用Using namespace std;等全局的引入，因为这样的引入多了之后，还是会产生命名污染。最好是你用哪里的变量，在前面写上命名空间。</p>
<p><code>error C2872: ACCESS_MASK: 不明确的符号。</code><br>有点懵，来不及懵。</p>
<p>当一个函数没有在编译头文件中找到定义时，一般就会报错：未标识的符号。<br>至于报错不明确的符号，那可能是因为，工程的编译文件里有多个该符号定义。<br>笔者没那么聪明，是在前辈基础经验上总结的。<br>opencv3.0的cv “ACCESS_MASK”冲突</p>
<p>不想打开链接可以直接看原文截图：</p>
<p>瞧见没？是因为winnt.h里边定义了cv，它的cv空间里有一个符号叫ACCESS_MASK；<br>opencv函数里边也定义了命名空间cv，它的cv空间里也有一个符号叫ACCESS_MASK。<br>那么我的项目如果同时包含这两个头文件，计算机是否知道我要调用哪个ACCESS_MASK吗？</p>
<p>回想平时写代码习惯性的：</p>
<p>using namespace std;<br>using namespace cv;<br>1<br>2<br>因为opencv里边很多函数，诸如imread，imshow，waitkey，Rect，Point，在使用频率上比较高，每次把它所在的命名空间书写有点麻烦，所以就习惯性的一次性了。<br>可惜懒人没懒福，这样的报错遇到过很多次，一直在回避。<br>改完这六百多个报错，以后还是一次性写清楚吧，不要给自己留隐患了。</p>
<h1 id="关于OPENCV"><a href="#关于OPENCV" class="headerlink" title="关于OPENCV"></a>关于OPENCV</h1><p>通过观察opencv的源代码我们发现了一些很有意思的事情：</p>
<ul>
<li>形参采用了const：const可以保证该形参不会被缺心眼的程序员在接下来给修改了，毕竟你像原始图片这样的非常重要的形参如果被修改一下，后面都白做了，相当于一个保险措施吧。</li>
<li>传照片过来时，是一个mat类型的指针：</li>
<li>函数内部局部变量命名很有特点，以下划线开头：就是为了避免命名冲突</li>
</ul>
<h2 id="关于VS调试Opencv源码无法进行单步调试的解决办法"><a href="#关于VS调试Opencv源码无法进行单步调试的解决办法" class="headerlink" title="关于VS调试Opencv源码无法进行单步调试的解决办法"></a>关于VS调试Opencv源码无法进行单步调试的解决办法</h2><p>右键项目属性–链接–输入–外部依赖项–将opencv_world340d.lib放在最下面，因为你如果把他放在最上面的话，它里面就包含了opencv所有的符号表，其他静态库就不用加载了，自然也加载不了pdb文件调试了。</p>
<p>开启源服务器支持，将CMake好后生成的bin目录添加到相应目录下。</p>
<h1 id="C-中const的作用"><a href="#C-中const的作用" class="headerlink" title="C++中const的作用"></a>C++中const的作用</h1><p><strong>1. const可以定义常量</strong>。const定义的常量编译器可以对其进行静态数据类型安全检查。</p>
<p><strong>2. const修饰函数形式参数</strong>。当输入参数为用户自定义类型和抽象数据类型时，应该将值传递改为”cosnt &amp; 传递”，可以提高效率。比如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(A a)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(A <span class="keyword">const</span> &amp;a)</span></span>;</span><br></pre></td></tr></table></figure>

<p>第一个效率低，因为函数体内产生A类型的临时对象用于复制参数a，临时对象的构造、复制、析构过程都将消耗时间。第二个是引用传递，不需要产生临时对象，节省了临时对象的构造、复制、西沟过程消耗的时间。但是只用引用有可能改变a，因此加const。</p>
<h2 id="CV-DbAssert"><a href="#CV-DbAssert" class="headerlink" title="CV_DbAssert"></a>CV_DbAssert</h2><p>OpenCV中经常会碰见CV_DbAssert，来谈一谈opencv中Mat类的CV_DbAssert</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_Tp&amp; <span class="title">Mat::at</span><span class="params">(<span class="keyword">int</span> i0, <span class="keyword">int</span> i1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//1.如果维度越界</span></span><br><span class="line">CV_DbgAssert(dims &lt;= <span class="number">2</span>);</span><br><span class="line"><span class="comment">//2.如果数据为空</span></span><br><span class="line">CV_DbgAssert(data);</span><br><span class="line"><span class="comment">//3.如果i0越界</span></span><br><span class="line">CV_DbgAssert((<span class="keyword">unsigned</span>)i0 &lt; (<span class="keyword">unsigned</span>)<span class="built_in">size</span>.p[<span class="number">0</span>]);</span><br><span class="line"><span class="comment">//4.如果i1越界</span></span><br><span class="line">CV_DbgAssert((<span class="keyword">unsigned</span>)(i1 * DataType&lt;_Tp&gt;::channels) &lt; (<span class="keyword">unsigned</span>)(<span class="built_in">size</span>.p[<span class="number">1</span>] * channels()));</span><br><span class="line"><span class="comment">//5.elemSize1为Mat中一个通道中一个元素的所占内存大小的值。</span></span><br><span class="line">CV_DbgAssert(CV_ELEM_SIZE1(traits::Depth&lt;_Tp&gt;::value) == elemSize1());</span><br><span class="line"><span class="comment">//6.返回该点对应的值</span></span><br><span class="line"><span class="keyword">return</span> ((_Tp*)(data + <span class="built_in">step</span>.p[<span class="number">0</span>] * i0))[i1];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先，这个断言官方的解释是只在调试阶段运行，在发布版本不运行，但是很有可能会引起程序的崩溃。<br>主要的目的就是防止越界。</p>
<p>首先，这个断言官方的解释是只在调试阶段运行，在发布版本不运行，但是很有可能会引起程序的崩溃。<br>主要的目的就是防止越界。</p>
<h2 id="在VS2017中实现OpenCV源码级调试"><a href="#在VS2017中实现OpenCV源码级调试" class="headerlink" title="在VS2017中实现OpenCV源码级调试"></a>在VS2017中实现OpenCV源码级调试</h2><p>0.需要把<code>opencv</code>的源码路径加上，在<code>配置属性-&gt;vc++目录-&gt;源目录</code>，<code>C:\Program Files\opencv\sources\modules</code></p>
<p>1.<code>cmake</code>编译<code>opencv</code>源码，如果是<code>OpenCV3.0</code>以上版本可以勾选<code>Build OpenCV_World</code>选项，这样可以使得编译的最终结果是一个总的<code>dll</code>等文件，省的一个一个<code>dll</code>文件添加了。然后打开<code>opencv.sln</code>，<code>Debug</code>，<code>release</code>下都<code>build</code>一遍。这时会出现<code>bin</code>文件，<code>lib</code>文件，以及<code>install</code>文件：<code>bin文件</code>你会发现有了<code>dll</code>，还有<code>pdb</code>文件，一一对应，<code>lib</code>文件同样也多了<code>exp</code>文件；<br>而install文件你会发现和一键安装opencv时生成的文件一样， 有lib include bin；</p>
<p>2.打开<code>工具-&gt;选项-&gt;调试-&gt;符号</code>，在<code>Microsoft</code>符号服务器下右上角有个添加，我输入<code>opencv_world340d.pdb</code>，然后运行，看输出窗口还是提示说 无法查找或打开 <code>PDB</code>文件，，又发现右上角是文件夹的新建,接着把debug的pdb路径输入，在运行程序加断点，完美，输出窗口 </p>
<p>3.在opencv自带函数处加断点，F11，哇，cvLoadImage(), 调到opencv的src文件内的<code>d:\opencv340\opencv\sources\modules\highgui\src\loadsave.cpp</code>，可以看到<code>oepncv</code>自带函数的实现了，点云库<code>PCL</code>想看源码，也一样</p>
<ul>
<li>debug下，F11单步执行才可以进入opencv源码的cpp.</li>
</ul>
<blockquote>
<p>之前怎么也不成功是因为生成的Opencv_world340d.dll不对，正经生成出来的是150M</p>
</blockquote>
<p><img src="https://i.loli.net/2020/03/29/1LGB6ygPmpOlSKs.png" alt="image-20191219213007592"></p>
<h2 id="OpencvCmake"><a href="#OpencvCmake" class="headerlink" title="OpencvCmake"></a>OpencvCmake</h2><ul>
<li>如果根据上面设置之后，编译还会有同样的错误，可以直接注释发生错误的地方。 经过一番搜索之后，发现是因为vtk8.10之后的版本中将vtkMapper的ImmediateModeRenderingOff()方法移除了，所以为了让pcl1.9.1代码编译通过，只需要将错误提示中对应的那一行代码注释掉即可，或者更换为更低版本的vtk也行。我是通过注释掉上述出错的两行代码，因为ImmediateModeRenderingOff()方法不是必须的操作，最后通过了编译。</li>
<li>libConfig++，注意生成的要是64位的Lib&amp;DLL</li>
<li>boost连接</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/08/2020-03-08-GPU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/08/2020-03-08-GPU/" itemprop="url">GPU并行编程--CUDA模型学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-08T10:16:18+08:00">
                2020-03-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了GPU并行编程CUDA的一些笔记。</p>
<p><img src="https://i.loli.net/2020/03/30/HtDAjOmXqVnLKgb.png" alt="1583476702566"></p>
<p>32是考虑流水线【取指–执行—-】</p>
<p><img src="https://i.loli.net/2020/03/30/Lp1crIB4K5EmHQX.png" alt="1583478205636"></p>
<p><img src="https://i.loli.net/2020/03/30/gJCWhvV6HkwqTd2.png" alt="1583480186631"></p>
<p>均匀分布比起高斯分布具有更高的信息熵（更混乱，因为均匀分布说明物体很多且分布均匀，而高斯分布集中在峰值那块，更整齐一些）</p>
<p><img src="https://i.loli.net/2020/03/30/lY8G7mgMEnroPa2.png" alt="1583995920661"></p>
<p><img src="https://i.loli.net/2020/03/30/zXL9xRYIdmP6SEO.png" alt="1583996284858"></p>
<p>第二个式子是保证正负号的，也就是保证分类正确（因为求w最小求出两个值）</p>
<p><img src="https://i.loli.net/2020/03/30/gMdYEFTuqoCByi1.png" alt="1583998459306"></p>
<p>可以使用 <code>nvidia-smi</code> (<em>Systems Management Interface</em>) 命令行命令查询有关此 GPU 的信息。</p>
<p><img src="https://i.loli.net/2020/03/30/RbHi3vYFqhWt7yK.png" alt="1584235758864"></p>
<p>可以通过以下方式轻松解决这种情况：</p>
<ul>
<li>编写执行配置，使其创建的线程数<strong>超过</strong>执行分配工作所需的线程数。</li>
<li>将值作为参数传递到核函数 (<code>N</code>) 中，以表示要处理的数据集总大小或完成工作所需的总线程数。</li>
<li>计算网格内的线程索引后（使用 <code>tid+bid*bdim</code>），请检查该索引是否超过 <code>N</code>，并且只在不超过的情况下执行与核函数相关的工作。</li>
</ul>
<p>以下是编写执行配置的惯用方法示例，适用于 <code>N</code> 和线程块中的线程数已知，但无法保证网格中的线程数和 <code>N</code> 之间完全匹配的情况。如此一来，便可确保网格中至少始终拥有 <code>N</code> 所需的线程数，且超出的线程数至多仅可相当于 1 个线程块的线程数量：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assume `N` is known</span></span><br><span class="line"><span class="keyword">int</span> N = <span class="number">100000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Assume we have a desire to set `threads_per_block` exactly to `256`</span></span><br><span class="line"><span class="keyword">size_t</span> threads_per_block = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Ensure there are at least `N` threads in the grid, but only 1 block's worth extra</span></span><br><span class="line"><span class="keyword">size_t</span> number_of_blocks = (N + threads_per_block - <span class="number">1</span>) / threads_per_block;</span><br><span class="line"></span><br><span class="line">some_kernel&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;(N);</span><br></pre></td></tr></table></figure>

<p>由于上述执行配置致使网格中的线程数超过 <code>N</code>，因此需要注意 <code>some_kernel</code> 定义中的内容，以确保 <code>some_kernel</code> 在由其中一个 \”extra\” 线程执行时不会尝试访问超出范围的数据元素：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="title">some_kernel</span><span class="params">(<span class="keyword">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> idx = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (idx &lt; N) <span class="comment">// Check to make sure `idx` maps to some value within `N`</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// Only do work if it does</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/30/pEVzKnYhoGvtjOe.png" alt="1584163725409"></p>
<hr>
<h2 id="Allocating-Memory-to-be-accessed-on-the-GPU-and-the-CPU"><a href="#Allocating-Memory-to-be-accessed-on-the-GPU-and-the-CPU" class="headerlink" title="Allocating Memory to be accessed on the GPU and the CPU"></a>Allocating Memory to be accessed on the GPU and the CPU</h2><p>CUDA 的最新版本（版本 6 和更高版本）已能轻松分配可用于 CPU 主机和任意数量 GPU 设备的内存。尽管现今有许多适用于内存管理并可支持加速应用程序中最优性能的 <a href="http://docs.nvidia.com/cuda/cuda-c-best-practices-guide/index.html#memory-optimizations" target="_blank" rel="noopener">中高级技术</a>，但我们现在要介绍的基础 CUDA 内存管理技术不但能够支持远超 CPU 应用程序的卓越性能，而且几乎不会产生任何开发人员成本。</p>
<p>如要分配和释放内存，并获取可在主机和设备代码中引用的指针，请使用 <code>cudaMallocManaged</code> 和 <code>cudaFree</code> 取代对 <code>malloc</code> 和 <code>free</code> 的调用，如下例所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CPU-only</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> N = <span class="number">2</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line"><span class="keyword">size_t</span> size = N * <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *a;</span><br><span class="line">a = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use `a` in CPU-only program.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(a);</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Accelerated</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> N = <span class="number">2</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line"><span class="keyword">size_t</span> size = N * <span class="keyword">sizeof</span>(<span class="keyword">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> *a;</span><br><span class="line"><span class="comment">// Note the address of `a` is passed as first argument.</span></span><br><span class="line">cudaMallocManaged(&amp;a, size);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use `a` on the CPU and/or on any GPU in the accelerated system.</span></span><br><span class="line"></span><br><span class="line">cudaFree(a);</span><br></pre></td></tr></table></figure>

<h2 id="Data-Sets-Larger-then-the-Grid"><a href="#Data-Sets-Larger-then-the-Grid" class="headerlink" title="Data Sets Larger then the Grid"></a>Data Sets Larger then the Grid</h2><p>或出于选择，为了要创建具有超高性能的执行配置，或出于需要，一个网格中的线程数量可能会小于数据集的大小。请思考一下包含 1000 个元素的数组和包含 250 个线程的网格（此处使用极小的规模以便于说明）。此网格中的每个线程将需使用 4 次。如要实现此操作，一种常用方法便是在核函数中使用<strong>网格跨度循环</strong>。</p>
<p>在网格跨度循环中，每个线程将在网格内使用 <code>tid+bid*bdim</code> 计算自身唯一的索引，并对数组内该索引的元素执行相应运算，然后将网格中的线程数添加到索引并重复此操作，直至超出数组范围。例如，对于包含 500 个元素的数组和包含 250 个线程的网格，网格中索引为 20 的线程将执行如下操作：</p>
<ul>
<li>对包含 500 个元素的数组的元素 20 执行相应运算</li>
<li>将其索引增加 250，使网格的大小达到 270</li>
<li>对包含 500 个元素的数组的元素 270 执行相应运算</li>
<li>将其索引增加 250，使网格的大小达到 520</li>
<li>由于 520 现已超出数组范围，因此线程将停止工作</li>
</ul>
<p>CUDA 提供一个可给出网格中线程块数的特殊变量：<code>gridDim.x</code>。然后计算网格中的总线程数，即网格中的线程块数乘以每个线程块中的线程数：<code>gridDim.x * blockDim.x</code>。带着这样的想法来看看以下核函数中网格跨度循环的详细示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__global <span class="keyword">void</span> <span class="title">kernel</span><span class="params">(<span class="keyword">int</span> *a, <span class="keyword">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> indexWithinTheGrid = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">  <span class="keyword">int</span> gridStride = gridDim.x * blockDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = indexWithinTheGrid; i &lt; N; i += gridStride)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// do work on a[i];</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Error-Handling"><a href="#Error-Handling" class="headerlink" title="Error Handling"></a>Error Handling</h2><p>与在任何应用程序中一样，加速 CUDA 代码中的错误处理同样至关重要。即便不是大多数，也有许多 CUDA 函数（例如，<a href="http://docs.nvidia.com/cuda/cuda-runtime-api/group__CUDART__MEMORY.html#group__CUDART__MEMORY" target="_blank" rel="noopener">内存管理函数</a>）会返回类型为 <code>cudaError_t</code> 的值，该值可用于检查调用函数时是否发生错误。以下是对调用 <code>cudaMallocManaged</code> 函数执行错误处理的示例：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cudaError_t err;</span><br><span class="line">err = cudaMallocManaged(&amp;a, N)                    <span class="comment">// Assume the existence of `a` and `N`.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (err != cudaSuccess)                           <span class="comment">// `cudaSuccess` is provided by CUDA.</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Error: %s\n"</span>, cudaGetErrorString(err)); <span class="comment">// `cudaGetErrorString` is provided by CUDA.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动定义为返回 <code>void</code> 的核函数后，将不会返回类型为 <code>cudaError_t</code> 的值。为检查启动核函数时是否发生错误（例如，如果启动配置错误），CUDA 提供 <code>cudaGetLastError</code> 函数，该函数会返回类型为 <code>cudaError_t</code> 的值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This launch should cause an error, but the kernel itself</span></span><br><span class="line"><span class="comment"> * cannot return it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">someKernel&lt;&lt;&lt;<span class="number">1</span>, <span class="number">-1</span>&gt;&gt;&gt;();  <span class="comment">// -1 is not a valid number of threads.</span></span><br><span class="line"></span><br><span class="line">cudaError_t err;</span><br><span class="line">err = cudaGetLastError(); <span class="comment">// `cudaGetLastError` will return the error from above.</span></span><br><span class="line"><span class="keyword">if</span> (err != cudaSuccess)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Error: %s\n"</span>, cudaGetErrorString(err));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，为捕捉异步错误（例如，在异步核函数执行期间），请务必检查后续同步 CUDA 运行时 API 调用所返回的状态（例如 <code>cudaDeviceSynchronize</code>）；如果之前启动的其中一个核函数失败，则将返回错误。</p>
<h3 id="CUDA-Error-Handling-Function"><a href="#CUDA-Error-Handling-Function" class="headerlink" title="CUDA Error Handling Function"></a>CUDA Error Handling Function</h3><p>创建一个包装 CUDA 函数调用的宏对于检查错误十分有用。以下是一个宏示例，您可以在余下练习中随时使用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> cudaError_t <span class="title">checkCuda</span><span class="params">(cudaError_t result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (result != cudaSuccess) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"CUDA Runtime Error: %s\n"</span>, cudaGetErrorString(result));</span><br><span class="line">    assert(result == cudaSuccess);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The macro can be wrapped around any function returning</span></span><br><span class="line"><span class="comment"> * a value of type `cudaError_t`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">  checkCuda( cudaDeviceSynchronize() )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Final-Exercise-Accelerate-Vector-Addition-Application"><a href="#Final-Exercise-Accelerate-Vector-Addition-Application" class="headerlink" title="Final Exercise: Accelerate Vector Addition Application"></a>Final Exercise: Accelerate Vector Addition Application</h3><p>下面的挑战将使您有机会运用在实验中学到的知识。其中涉及加速 CPU 向量加法程序，尽管该程序不甚复杂，但仍能让您有机会重点运用所学的借助 CUDA 加速 GPU 应用程序的相关知识。完成此练习后，如果您有富余时间并有意深究，可继续学习<em>高阶内容</em>部分以了解涉及更复杂代码库的一些挑战。</p>
<p>01-vector-add.cu包含一个可正常运作的 CPU 向量加法应用程序。加速其 <code>addVectorsInto</code> 函数，使之在 GPU 上以 CUDA 核函数运行并使其并行执行工作。鉴于需发生以下操作，如您遇到问题，请参阅解决方案。</p>
<ul>
<li>扩充 <code>addVectorsInto</code> 定义，使之成为 CUDA 核函数。</li>
<li>选择并使用有效的执行配置，以使 <code>addVectorsInto</code> 作为 CUDA 核函数启动。</li>
<li>更新内存分配，内存释放以反映主机和设备代码需要访问 3 个向量：<code>a</code>、<code>b</code> 和 <code>result</code>。</li>
<li>重构 <code>addVectorsInto</code> 的主体：将在单个线程内部启动，并且只需对输入向量执行单线程操作。确保线程从不尝试访问输入向量范围之外的元素，并注意线程是否需对输入向量的多个元素执行操作。</li>
<li>在 CUDA 代码可能以其他方式静默失败的位置添加错误处理。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> cudaError_t <span class="title">checkCuda</span><span class="params">(cudaError_t result)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (result != cudaSuccess) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"CUDA Runtime Error: %s\n"</span>, cudaGetErrorString(result));</span><br><span class="line">    assert(result == cudaSuccess);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initWith</span><span class="params">(<span class="keyword">float</span> num, <span class="keyword">float</span> *a, <span class="keyword">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    a[i] = num;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">addVectorsInto</span><span class="params">(<span class="keyword">float</span> *result, <span class="keyword">float</span> *a, <span class="keyword">float</span> *b, <span class="keyword">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> idx = threadIdx.x + blockIdx.x * blockDim.x;    </span><br><span class="line">    <span class="keyword">int</span> gridStride = gridDim.x * blockDim.x;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = idx;i&lt;N;i+=gridStride)&#123;</span><br><span class="line">          <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; ++i)</span><br><span class="line">          &#123;</span><br><span class="line">            result[i] = a[i] + b[i];</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkElementsAre</span><span class="params">(<span class="keyword">float</span> target, <span class="keyword">float</span> *<span class="built_in">array</span>, <span class="keyword">int</span> N)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">array</span>[i] != target)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"FAIL: array[%d] - %0.0f does not equal %0.0f\n"</span>, i, <span class="built_in">array</span>[i], target);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"SUCCESS! All values added correctly.\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">2</span>&lt;&lt;<span class="number">20</span>;</span><br><span class="line">  <span class="keyword">size_t</span> size = N * <span class="keyword">sizeof</span>(<span class="keyword">float</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">float</span> *a;</span><br><span class="line">  <span class="keyword">float</span> *b;</span><br><span class="line">  <span class="keyword">float</span> *c;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  cudaMallocManaged(&amp;a,size);</span><br><span class="line">  cudaMallocManaged(&amp;b,size);</span><br><span class="line">  cudaMallocManaged(&amp;c,size);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  initWith(<span class="number">3</span>, a, N);</span><br><span class="line">  initWith(<span class="number">4</span>, b, N);</span><br><span class="line">  initWith(<span class="number">0</span>, c, N);</span><br><span class="line"></span><br><span class="line">  addVectorsInto&lt;&lt;&lt;<span class="number">100</span>,<span class="number">100</span>&gt;&gt;&gt;(c, a, b, N);</span><br><span class="line">  <span class="comment">//cudaDeviceSynchronize();</span></span><br><span class="line">  checkCuda( cudaDeviceSynchronize() );</span><br><span class="line"></span><br><span class="line">  checkElementsAre(<span class="number">7</span>, c, N);</span><br><span class="line"></span><br><span class="line">  cudaFree(a);</span><br><span class="line">  cudaFree(b);</span><br><span class="line">  cudaFree(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Grids-and-Blocks-of-2-and-3-Dimensions"><a href="#Grids-and-Blocks-of-2-and-3-Dimensions" class="headerlink" title="Grids and Blocks of 2 and 3 Dimensions"></a>Grids and Blocks of 2 and 3 Dimensions</h2><p>可以将网格和线程块定义为最多具有 3 个维度。使用多个维度定义网格和线程块绝不会对其性能造成任何影响，但这在处理具有多个维度的数据时可能非常有用，例如 2D 矩阵。如要定义二维或三维网格或线程块，可以使用 CUDA 的 <code>dim3</code> 类型，即如下所示：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">dim3 <span class="title">threads_per_block</span><span class="params">(<span class="number">16</span>, <span class="number">16</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line"><span class="function">dim3 <span class="title">number_of_blocks</span><span class="params">(<span class="number">16</span>, <span class="number">16</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">someKernel&lt;&lt;&lt;number_of_blocks, threads_per_block&gt;&gt;&gt;();</span><br></pre></td></tr></table></figure>

<p>鉴于以上示例，<code>someKernel</code> 内部的变量 <code>gridDim.x</code>、<code>gridDim.y</code>、<code>blockDim.x</code> 和 <code>blockDim.y</code> 均将等于 <code>16</code>。</p>
<h3 id="Exercise-Accelerate-2D-Matrix-Multiply-Application"><a href="#Exercise-Accelerate-2D-Matrix-Multiply-Application" class="headerlink" title="Exercise: Accelerate 2D Matrix Multiply Application"></a>Exercise: Accelerate 2D Matrix Multiply Application</h3><p>文件 <a href="http://ec2-3-89-85-142.compute-1.amazonaws.com/DdJxiLJo/edit/tasks/task1/task/01_AC_CUDA_C-zh/08-matrix-multiply/01-matrix-multiply-2d.cu" target="_blank" rel="noopener"><code>01-matrix-multiply-2d.cu</code></a> 包含一个功能齐全的主机函数 <code>matrixMulCPU</code>。您的任务是扩建 CUDA 核函数 <code>matrixMulGPU</code>。源代码将使用这两个函数执行矩阵乘法，并比较它们的答案以验证您编写的 CUDA 核函数是否正确。使用以下指南获得操作支持，如您遇到问题，请参阅 <a href="http://ec2-3-89-85-142.compute-1.amazonaws.com/DdJxiLJo/edit/tasks/task1/task/01_AC_CUDA_C-zh/08-matrix-multiply/solutions/01-matrix-multiply-2d-solution.cu" target="_blank" rel="noopener">解决方案</a>：</p>
<ul>
<li>您将需创建执行配置，其参数均为 <code>dim3</code> 值，且 <code>x</code> 和 <code>y</code> 维度均设为大于 <code>1</code>。</li>
<li>在核函数主体内部，您将需要按照惯例在网格内建立所运行线程的唯一索引，但应为线程建立两个索引：一个用于网格的 x 轴，另一个用于网格的 y 轴。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N  64</span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">matrixMulGPU</span><span class="params">( <span class="keyword">int</span> * a, <span class="keyword">int</span> * b, <span class="keyword">int</span> * c )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> row = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="keyword">int</span> col = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (row &lt; N &amp;&amp; col &lt; N)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; N; ++k )</span><br><span class="line">      val += a[row * N + k] * b[k * N + col];</span><br><span class="line">    c[row * N + col] = val;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This CPU function already works, and will run to create a solution matrix</span></span><br><span class="line"><span class="comment"> * against which to verify your work building out the matrixMulGPU kernel.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">matrixMulCPU</span><span class="params">( <span class="keyword">int</span> * a, <span class="keyword">int</span> * b, <span class="keyword">int</span> * c )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> val = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      val = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; N; ++k )</span><br><span class="line">        val += a[row * N + k] * b[k * N + col];</span><br><span class="line">      c[row * N + col] = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *a, *b, *c_cpu, *c_gpu; <span class="comment">// Allocate a solution matrix for both the CPU and the GPU operations</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span> = N * N * <span class="keyword">sizeof</span> (<span class="keyword">int</span>); <span class="comment">// Number of bytes of an N x N matrix</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate memory</span></span><br><span class="line">  cudaMallocManaged (&amp;a, <span class="built_in">size</span>);</span><br><span class="line">  cudaMallocManaged (&amp;b, <span class="built_in">size</span>);</span><br><span class="line">  cudaMallocManaged (&amp;c_cpu, <span class="built_in">size</span>);</span><br><span class="line">  cudaMallocManaged (&amp;c_gpu, <span class="built_in">size</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize memory; create 2D matrices</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> row = <span class="number">0</span>; row &lt; N; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> col = <span class="number">0</span>; col &lt; N; ++col )</span><br><span class="line">    &#123;</span><br><span class="line">      a[row*N + col] = row;</span><br><span class="line">      b[row*N + col] = col+<span class="number">2</span>;</span><br><span class="line">      c_cpu[row*N + col] = <span class="number">0</span>;</span><br><span class="line">      c_gpu[row*N + col] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Assign `threads_per_block` and `number_of_blocks` 2D values</span></span><br><span class="line"><span class="comment">   * that can be used in matrixMulGPU above.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="function">dim3 <span class="title">threads_per_block</span><span class="params">(<span class="number">16</span>,<span class="number">16</span>,<span class="number">1</span>)</span></span>;</span><br><span class="line">  <span class="function">dim3 <span class="title">number_of_blocks</span><span class="params">(<span class="number">4</span>,<span class="number">4</span>,<span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  matrixMulGPU &lt;&lt;&lt; number_of_blocks, threads_per_block &gt;&gt;&gt; ( a, b, c_gpu );</span><br><span class="line"></span><br><span class="line">  cudaDeviceSynchronize();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Call the CPU version to check our work</span></span><br><span class="line">  matrixMulCPU( a, b, c_cpu );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Compare the two answers to make sure they are equal</span></span><br><span class="line">  <span class="keyword">bool</span> error = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> row = <span class="number">0</span>; row &lt; N &amp;&amp; !error; ++row )</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> col = <span class="number">0</span>; col &lt; N &amp;&amp; !error; ++col )</span><br><span class="line">      <span class="keyword">if</span> (c_cpu[row * N + col] != c_gpu[row * N + col])</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"FOUND ERROR at c[%d][%d]\n"</span>, row, col);</span><br><span class="line">        error = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="keyword">if</span> (!error)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Success!\n"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Free all our allocated memory</span></span><br><span class="line">  cudaFree(a); cudaFree(b);</span><br><span class="line">  cudaFree( c_cpu ); cudaFree( c_gpu );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Exercise-Accelerate-A-Thermal-Conductivity-Application"><a href="#Exercise-Accelerate-A-Thermal-Conductivity-Application" class="headerlink" title="Exercise: Accelerate A Thermal Conductivity Application"></a>Exercise: Accelerate A Thermal Conductivity Application</h3><p>在下面的练习中，您将为模拟金属银二维热传导的应用程序执行加速操作。</p>
<p>将 <a href="http://ec2-3-84-208-168.compute-1.amazonaws.com/3riRC33t/edit/tasks/task1/task/01_AC_CUDA_C-zh/09-heat/01-heat-conduction.cu" target="_blank" rel="noopener"><code>01-heat-conduction.cu</code></a> 内的 <code>step_kernel_mod</code> 函数转换为在 GPU 上执行，并修改 <code>main</code> 函数以恰当分配在 CPU 和 GPU 上使用的数据。<code>step_kernel_ref</code> 函数在 CPU 上执行并用于检查错误。由于此代码涉及浮点计算，因此不同的处理器甚或同一处理器上的简单重排操作都可能导致结果略有出入。为此，错误检查代码会使用错误阈值，而非查找完全匹配。如您遇到问题，请参阅 <a href="http://ec2-3-84-208-168.compute-1.amazonaws.com/3riRC33t/edit/tasks/task1/task/01_AC_CUDA_C-zh/09-heat/solutions/01-heat-conduction-solution.cu" target="_blank" rel="noopener">解决方案</a>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple define to index into a 1D array from 2D space</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> I2D(num, c, r) ((r)*(num)+(c))</span></span><br><span class="line"></span><br><span class="line">__global__</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">step_kernel_mod</span><span class="params">(<span class="keyword">int</span> ni, <span class="keyword">int</span> nj, <span class="keyword">float</span> fact, <span class="keyword">float</span>* temp_in, <span class="keyword">float</span>* temp_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i00, im10, ip10, i0m1, i0p1;</span><br><span class="line">  <span class="keyword">float</span> d2tdx2, d2tdy2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> j = blockIdx.x * blockDim.x + threadIdx.x;</span><br><span class="line">  <span class="keyword">int</span> i = blockIdx.y * blockDim.y + threadIdx.y;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// loop over all points in domain (except boundary)</span></span><br><span class="line">  <span class="keyword">if</span> (j &gt; <span class="number">0</span> &amp;&amp; i &gt; <span class="number">0</span> &amp;&amp; j &lt; nj<span class="number">-1</span> &amp;&amp; i &lt; ni<span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">// find indices into linear memory</span></span><br><span class="line">    <span class="comment">// for central point and neighbours</span></span><br><span class="line">    i00 = I2D(ni, i, j);</span><br><span class="line">    im10 = I2D(ni, i<span class="number">-1</span>, j);</span><br><span class="line">    ip10 = I2D(ni, i+<span class="number">1</span>, j);</span><br><span class="line">    i0m1 = I2D(ni, i, j<span class="number">-1</span>);</span><br><span class="line">    i0p1 = I2D(ni, i, j+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// evaluate derivatives</span></span><br><span class="line">    d2tdx2 = temp_in[im10]<span class="number">-2</span>*temp_in[i00]+temp_in[ip10];</span><br><span class="line">    d2tdy2 = temp_in[i0m1]<span class="number">-2</span>*temp_in[i00]+temp_in[i0p1];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update temperatures</span></span><br><span class="line">    temp_out[i00] = temp_in[i00]+fact*(d2tdx2 + d2tdy2);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">step_kernel_ref</span><span class="params">(<span class="keyword">int</span> ni, <span class="keyword">int</span> nj, <span class="keyword">float</span> fact, <span class="keyword">float</span>* temp_in, <span class="keyword">float</span>* temp_out)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i00, im10, ip10, i0m1, i0p1;</span><br><span class="line">  <span class="keyword">float</span> d2tdx2, d2tdy2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// loop over all points in domain (except boundary)</span></span><br><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> j=<span class="number">1</span>; j &lt; nj<span class="number">-1</span>; j++ ) &#123;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i=<span class="number">1</span>; i &lt; ni<span class="number">-1</span>; i++ ) &#123;</span><br><span class="line">      <span class="comment">// find indices into linear memory</span></span><br><span class="line">      <span class="comment">// for central point and neighbours</span></span><br><span class="line">      i00 = I2D(ni, i, j);</span><br><span class="line">      im10 = I2D(ni, i<span class="number">-1</span>, j);</span><br><span class="line">      ip10 = I2D(ni, i+<span class="number">1</span>, j);</span><br><span class="line">      i0m1 = I2D(ni, i, j<span class="number">-1</span>);</span><br><span class="line">      i0p1 = I2D(ni, i, j+<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// evaluate derivatives</span></span><br><span class="line">      d2tdx2 = temp_in[im10]<span class="number">-2</span>*temp_in[i00]+temp_in[ip10];</span><br><span class="line">      d2tdy2 = temp_in[i0m1]<span class="number">-2</span>*temp_in[i00]+temp_in[i0p1];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// update temperatures</span></span><br><span class="line">      temp_out[i00] = temp_in[i00]+fact*(d2tdx2 + d2tdy2);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> istep;</span><br><span class="line">  <span class="keyword">int</span> nstep = <span class="number">200</span>; <span class="comment">// number of time steps</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Specify our 2D dimensions</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> ni = <span class="number">200</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> nj = <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">float</span> tfac = <span class="number">8.418e-5</span>; <span class="comment">// thermal diffusivity of silver</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">float</span> *temp1_ref, *temp2_ref, *temp1, *temp2, *temp_tmp;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> <span class="built_in">size</span> = ni * nj * <span class="keyword">sizeof</span>(<span class="keyword">float</span>);</span><br><span class="line"></span><br><span class="line">  temp1_ref = (<span class="keyword">float</span>*)<span class="built_in">malloc</span>(<span class="built_in">size</span>);</span><br><span class="line">  temp2_ref = (<span class="keyword">float</span>*)<span class="built_in">malloc</span>(<span class="built_in">size</span>);</span><br><span class="line">  cudaMallocManaged(&amp;temp1, <span class="built_in">size</span>);</span><br><span class="line">  cudaMallocManaged(&amp;temp2, <span class="built_in">size</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize with random data</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ni*nj; ++i) &#123;</span><br><span class="line">    temp1_ref[i] = temp2_ref[i] = temp1[i] = temp2[i] = (<span class="keyword">float</span>)rand()/(<span class="keyword">float</span>)(RAND_MAX/<span class="number">100.0f</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Execute the CPU-only reference version</span></span><br><span class="line">  <span class="keyword">for</span> (istep=<span class="number">0</span>; istep &lt; nstep; istep++) &#123;</span><br><span class="line">    step_kernel_ref(ni, nj, tfac, temp1_ref, temp2_ref);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// swap the temperature pointers</span></span><br><span class="line">    temp_tmp = temp1_ref;</span><br><span class="line">    temp1_ref = temp2_ref;</span><br><span class="line">    temp2_ref= temp_tmp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">dim3 <span class="title">tblocks</span><span class="params">(<span class="number">32</span>, <span class="number">16</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">  <span class="function">dim3 <span class="title">grid</span><span class="params">((nj/tblocks.x)+<span class="number">1</span>, (ni/tblocks.y)+<span class="number">1</span>, <span class="number">1</span>)</span></span>;</span><br><span class="line">  cudaError_t ierrSync, ierrAsync;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Execute the modified version using same data</span></span><br><span class="line">  <span class="keyword">for</span> (istep=<span class="number">0</span>; istep &lt; nstep; istep++) &#123;</span><br><span class="line">    step_kernel_mod&lt;&lt;&lt; grid, tblocks &gt;&gt;&gt;(ni, nj, tfac, temp1, temp2);</span><br><span class="line"></span><br><span class="line">    ierrSync = cudaGetLastError();</span><br><span class="line">    ierrAsync = cudaDeviceSynchronize(); <span class="comment">// Wait for the GPU to finish</span></span><br><span class="line">    <span class="keyword">if</span> (ierrSync != cudaSuccess) &#123; <span class="built_in">printf</span>(<span class="string">"Sync error: %s\n"</span>, cudaGetErrorString(ierrSync)); &#125;</span><br><span class="line">    <span class="keyword">if</span> (ierrAsync != cudaSuccess) &#123; <span class="built_in">printf</span>(<span class="string">"Async error: %s\n"</span>, cudaGetErrorString(ierrAsync)); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// swap the temperature pointers</span></span><br><span class="line">    temp_tmp = temp1;</span><br><span class="line">    temp1 = temp2;</span><br><span class="line">    temp2= temp_tmp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">float</span> maxError = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// Output should always be stored in the temp1 and temp1_ref at this point</span></span><br><span class="line">  <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ni*nj; ++i ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">abs</span>(temp1[i]-temp1_ref[i]) &gt; maxError) &#123; maxError = <span class="built_in">abs</span>(temp1[i]-temp1_ref[i]); &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check and see if our maxError is greater than an error bound</span></span><br><span class="line">  <span class="keyword">if</span> (maxError &gt; <span class="number">0.0005f</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Problem! The Max Error of %.5f is NOT within acceptable bounds.\n"</span>, maxError);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The Max Error of %.5f is within acceptable bounds.\n"</span>, maxError);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>( temp1_ref );</span><br><span class="line">  <span class="built_in">free</span>( temp2_ref );</span><br><span class="line">  cudaFree( temp1 );</span><br><span class="line">  cudaFree( temp2 );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">==<span class="number">188</span>== NVPROF <span class="keyword">is</span> profiling process <span class="number">188</span>, command: ./single-thread-vector-add</span><br><span class="line">Success! All values calculated correctly.</span><br><span class="line">==<span class="number">188</span>== Profiling application: ./single-thread-vector-add</span><br><span class="line">==<span class="number">188</span>== Profiling result:</span><br><span class="line">            Type  Time(%)      Time     Calls       Avg       Min       Max  Name</span><br><span class="line"> GPU activities:  <span class="number">100.00</span>%  <span class="number">2.37011</span>s         <span class="number">1</span>  <span class="number">2.37011</span>s  <span class="number">2.37011</span>s  <span class="number">2.37011</span>s  addVectorsInto(<span class="built_in">float</span>*, <span class="built_in">float</span>*, <span class="built_in">float</span>*, <span class="built_in">int</span>)</span><br><span class="line">      API calls:   <span class="number">57.28</span>%  <span class="number">2.37013</span>s         <span class="number">1</span>  <span class="number">2.37013</span>s  <span class="number">2.37013</span>s  <span class="number">2.37013</span>s  cudaDeviceSynchronize</span><br><span class="line">                   <span class="number">42.13</span>%  <span class="number">1.74342</span>s         <span class="number">3</span>  <span class="number">581.14</span>ms  <span class="number">19.768</span>us  <span class="number">1.74336</span>s  cudaMallocManaged</span><br><span class="line">                    <span class="number">0.56</span>%  <span class="number">23.287</span>ms         <span class="number">3</span>  <span class="number">7.7625</span>ms  <span class="number">7.0587</span>ms  <span class="number">9.0555</span>ms  cudaFree</span><br><span class="line">                    <span class="number">0.02</span>%  <span class="number">704.50</span>us         <span class="number">1</span>  <span class="number">704.50</span>us  <span class="number">704.50</span>us  <span class="number">704.50</span>us  cuDeviceTotalMem</span><br><span class="line">                    <span class="number">0.01</span>%  <span class="number">216.34</span>us        <span class="number">94</span>  <span class="number">2.3010</span>us     <span class="number">606</span>ns  <span class="number">50.785</span>us  cuDeviceGetAttribute</span><br><span class="line">                    <span class="number">0.00</span>%  <span class="number">76.115</span>us         <span class="number">1</span>  <span class="number">76.115</span>us  <span class="number">76.115</span>us  <span class="number">76.115</span>us  cudaLaunch</span><br><span class="line">                    <span class="number">0.00</span>%  <span class="number">14.602</span>us         <span class="number">1</span>  <span class="number">14.602</span>us  <span class="number">14.602</span>us  <span class="number">14.602</span>us  cuDeviceGetName</span><br><span class="line">                    <span class="number">0.00</span>%  <span class="number">10.685</span>us         <span class="number">4</span>  <span class="number">2.6710</span>us     <span class="number">676</span>ns  <span class="number">7.6680</span>us  cudaSetupArgument</span><br><span class="line">                    <span class="number">0.00</span>%  <span class="number">4.5370</span>us         <span class="number">1</span>  <span class="number">4.5370</span>us  <span class="number">4.5370</span>us  <span class="number">4.5370</span>us  cudaConfigureCall</span><br><span class="line">                    <span class="number">0.00</span>%  <span class="number">3.6480</span>us         <span class="number">3</span>  <span class="number">1.2160</span>us     <span class="number">646</span>ns  <span class="number">1.9600</span>us  cuDeviceGetCount</span><br><span class="line">                    <span class="number">0.00</span>%  <span class="number">2.0180</span>us         <span class="number">2</span>  <span class="number">1.0090</span>us     <span class="number">693</span>ns  <span class="number">1.3250</span>us  cuDeviceGet</span><br><span class="line">                    <span class="number">0.00</span>%     <span class="number">973</span>ns         <span class="number">1</span>     <span class="number">973</span>ns     <span class="number">973</span>ns     <span class="number">973</span>ns  cudaGetLastError</span><br><span class="line"></span><br><span class="line">==<span class="number">188</span>== Unified Memory profiling result:</span><br><span class="line">Device <span class="string">"Tesla V100-SXM2-16GB (0)"</span></span><br><span class="line">   Count  Avg Size  Min Size  Max Size  Total Size  Total Time  Name</span><br><span class="line">    <span class="number">2304</span>  <span class="number">170.67</span>KB  <span class="number">4.0000</span>KB  <span class="number">0.9961</span>MB  <span class="number">384.0000</span>MB  <span class="number">42.44723</span>ms  Host To Device</span><br><span class="line">     <span class="number">768</span>  <span class="number">170.67</span>KB  <span class="number">4.0000</span>KB  <span class="number">0.9961</span>MB  <span class="number">128.0000</span>MB  <span class="number">11.30275</span>ms  Device To Host</span><br><span class="line">     <span class="number">768</span>         -         -         -           -  <span class="number">110.5986</span>ms  Gpu page fault groups</span><br><span class="line">Total CPU Page faults: <span class="number">1536</span></span><br></pre></td></tr></table></figure>

<p><img src="1584244854962.png" alt="1584244854962"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"timer.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"check.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SOFTENING 1e-9f</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Each body contains x, y, and z coordinate positions,</span></span><br><span class="line"><span class="comment"> * as well as velocities in the x, y, and z directions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span> <span class="keyword">float</span> x, y, z, vx, vy, vz; &#125; Body;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Do not modify this function. A constraint of this exercise is</span></span><br><span class="line"><span class="comment"> * that it remain a host function.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">randomizeBodies</span><span class="params">(<span class="keyword">float</span> *data, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">    data[i] = <span class="number">2.0f</span> * (rand() / (<span class="keyword">float</span>)RAND_MAX) - <span class="number">1.0f</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This function calculates the gravitational impact of all bodies in the system</span></span><br><span class="line"><span class="comment"> * on all others, but does not update their positions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">__global__</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bodyForce</span><span class="params">(Body *p, <span class="keyword">float</span> dt, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">  <span class="keyword">int</span> stride = blockDim.x * gridDim.x;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; n; i += stride) &#123;</span><br><span class="line">    <span class="keyword">float</span> Fx = <span class="number">0.0f</span>; <span class="keyword">float</span> Fy = <span class="number">0.0f</span>; <span class="keyword">float</span> Fz = <span class="number">0.0f</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++) &#123;</span><br><span class="line">      <span class="keyword">float</span> dx = p[j].x - p[i].x;</span><br><span class="line">      <span class="keyword">float</span> dy = p[j].y - p[i].y;</span><br><span class="line">      <span class="keyword">float</span> dz = p[j].z - p[i].z;</span><br><span class="line">      <span class="keyword">float</span> distSqr = dx*dx + dy*dy + dz*dz + SOFTENING;</span><br><span class="line">      <span class="keyword">float</span> invDist = rsqrtf(distSqr);</span><br><span class="line">      <span class="keyword">float</span> invDist3 = invDist * invDist * invDist;</span><br><span class="line"></span><br><span class="line">      Fx += dx * invDist3; Fy += dy * invDist3; Fz += dz * invDist3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p[i].vx += dt*Fx; </span><br><span class="line">    p[i].vy += dt*Fy; </span><br><span class="line">    p[i].vz += dt*Fz; </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">add</span><span class="params">(Body*p, <span class="keyword">float</span> dt,<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index = threadIdx.x + blockIdx.x * blockDim.x;</span><br><span class="line">  <span class="keyword">int</span> stride = blockDim.x * gridDim.x;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = index; i &lt; n; i += stride) &#123;</span><br><span class="line">    p[i].x += p[i].vx*dt;</span><br><span class="line">    p[i].y += p[i].vy*dt;</span><br><span class="line">    p[i].z += p[i].vz*dt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> deviceId;</span><br><span class="line">  <span class="keyword">int</span> numberOfSMs;</span><br><span class="line"></span><br><span class="line">  cudaGetDevice(&amp;deviceId);</span><br><span class="line">  cudaDeviceGetAttribute(&amp;numberOfSMs, cudaDevAttrMultiProcessorCount, deviceId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Do not change the value for `nBodies` here. If you would like to modify it,</span></span><br><span class="line"><span class="comment">   * pass values into the command line.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> nBodies = <span class="number">2</span>&lt;&lt;<span class="number">11</span>;</span><br><span class="line">  <span class="keyword">int</span> salt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (argc &gt; <span class="number">1</span>) nBodies = <span class="number">2</span>&lt;&lt;atoi(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * This salt is for assessment reasons. Tampering with it will result in automatic failure.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc &gt; <span class="number">2</span>) salt = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">float</span> dt = <span class="number">0.01f</span>; <span class="comment">// time step</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> nIters = <span class="number">10</span>;  <span class="comment">// simulation iterations</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> bytes = nBodies * <span class="keyword">sizeof</span>(Body);</span><br><span class="line">  <span class="keyword">float</span> *buf;</span><br><span class="line"></span><br><span class="line">  cudaMallocManaged(&amp;buf, bytes);</span><br><span class="line">  <span class="comment">//cudaMemPrefetchAsync(buf, bytes, deviceId);</span></span><br><span class="line"></span><br><span class="line">  Body *p = (Body*)buf;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * As a constraint of this exercise, `randomizeBodies` must remain a host function.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  randomizeBodies(buf, <span class="number">6</span> * nBodies); <span class="comment">// Init pos / vel data</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">size_t</span> threadsPerBlock = <span class="number">256</span>;</span><br><span class="line">  <span class="keyword">size_t</span> numberOfBlocks = <span class="number">32</span> * numberOfSMs;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> totalTime = <span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * This simulation will run for 10 cycles of time, calculating gravitational</span></span><br><span class="line"><span class="comment">   * interaction amongst bodies, and adjusting their positions to reflect.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*******************************************************************/</span></span><br><span class="line">  <span class="comment">// Do not modify these 2 lines of code.</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> iter = <span class="number">0</span>; iter &lt; nIters; iter++) &#123;</span><br><span class="line">    StartTimer();</span><br><span class="line">  <span class="comment">/*******************************************************************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * You will likely wish to refactor the work being done in `bodyForce`,</span></span><br><span class="line"><span class="comment">   * as well as the work to integrate the positions.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  bodyForce&lt;&lt;&lt; numberOfBlocks, threadsPerBlock &gt;&gt;&gt;(p, dt, nBodies); <span class="comment">// compute interbody forces  </span></span><br><span class="line">  cudaDeviceSynchronize();</span><br><span class="line">  add&lt;&lt;&lt; numberOfBlocks, threadsPerBlock &gt;&gt;&gt;(p, dt, nBodies);</span><br><span class="line">  <span class="comment">// Do not modify the code in this section.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">double</span> tElapsed = GetTimer() / <span class="number">1000.0</span>;</span><br><span class="line">    totalTime += tElapsed;</span><br><span class="line">  &#125;</span><br><span class="line">  cudaDeviceSynchronize();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> avgTime = totalTime / (<span class="keyword">double</span>)(nIters);</span><br><span class="line">  <span class="keyword">float</span> billionsOfOpsPerSecond = <span class="number">1e-9</span> * nBodies * nBodies / avgTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ASSESS</span></span><br><span class="line">  checkPerformance(buf, billionsOfOpsPerSecond, salt);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  checkAccuracy(buf, nBodies);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%d Bodies: average %0.3f Billion Interactions / second\n"</span>, nBodies, billionsOfOpsPerSecond);</span><br><span class="line">  salt += <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="comment">/*******************************************************************/</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Feel free to modify code below.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  cudaFree(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复制工作目录（上文高亮部分），并替换以下代码块中的 ##FIXME##。完成替换之后，执行此单元 (Shift+Enter) 以将其存储到变量 MODEL_JOB_DIR 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MODEL_JOB_DIR = '/dli/data/digits/20180301-185638-e918'  ## Remember to set this to be the job directory for your model</span><br><span class="line">!ls $MODEL_JOB_DIR</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">caffe_output</span><span class="selector-class">.log</span>   <span class="selector-tag">snapshot_iter_735</span><span class="selector-class">.caffemodel</span>   <span class="selector-tag">status</span><span class="selector-class">.pickle</span></span><br><span class="line"><span class="selector-tag">deploy</span><span class="selector-class">.prototxt</span>    <span class="selector-tag">snapshot_iter_735</span><span class="selector-class">.solverstate</span>  <span class="selector-tag">train_val</span><span class="selector-class">.prototxt</span></span><br><span class="line"><span class="selector-tag">original</span><span class="selector-class">.prototxt</span>  <span class="selector-tag">solver</span><span class="selector-class">.prototxt</span></span><br></pre></td></tr></table></figure>



<p>复制并粘贴成功后，您将看到该目录中所有文件的列表。如果以下说明与您所见不符，请检查复制/粘贴操作是否成功。</p>
<p>我们的“模型”同样包含两个文件：网络结构和权重。</p>
<p>网络结构文件名为 <code>deploy.prototxt</code>，权重则在最新生成的快照文件中（文件名为 <code>snapshot_iter_#.caffemodel.</code>）在本例中，快照编号 735 包含 5 次训练全部完成后习得的权重。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ARCHITECTURE = MODEL_JOB_DIR + '/' + 'deploy.prototxt'</span><br><span class="line">WEIGHTS = MODEL_JOB_DIR + '/' + 'snapshot_iter_735.caffemodel'</span><br><span class="line"><span class="built_in">print</span> (<span class="string">"Filepath to Architecture = "</span> + ARCHITECTURE)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">"Filepath to weights = "</span>+ WEIGHTS)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Filepath to Architecture = /dli/data/digits/<span class="number">20180301</span><span class="number">-185638</span>-e918/deploy.prototxt</span><br><span class="line">Filepath to weights = /dli/data/digits/<span class="number">20180301</span><span class="number">-185638</span>-e918/snapshot_iter_735.caffemodel</span><br></pre></td></tr></table></figure>



<p>接下来，我们需要确保正在构建的程序可以读取并处理这些文件。在部署中，我们需安装模型训练时所用的深度学习框架，以便能够解析它们。稍后，我们会在本课程中学习如何将模型部署至无需安装框架的环境中。我们还需使用 GPU的并行处理能力。我们的模型包含数十万次操作运算，可通过并行计算予以显著加速。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> caffe</span><br><span class="line">caffe.set_mode_gpu()</span><br></pre></td></tr></table></figure>

<p>接下来，我们将创建名为“net”的“分类器”对象。工作流程越常见，您就越容易利用现有工具创建项目。在本例中，图像分类十分常见，因此下一个代码块只需使用网络结构文件和权重文件以及部分数据，简化了常见操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Initialize the Caffe model <span class="keyword">using</span> the model trained in DIGITS</span><br><span class="line">net = caffe.Classifier(ARCHITECTURE, WEIGHTS,  </span><br><span class="line">                       channel_swap =(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>), #Color images have three channels, Red, Green, <span class="keyword">and</span> Blue.</span><br><span class="line">                       raw_scale=<span class="number">255</span>) #Each pixel value is a number between <span class="number">0</span> <span class="keyword">and</span> <span class="number">255</span></span><br><span class="line">                       #Each <span class="string">"channel"</span> of our images are <span class="number">256</span> x <span class="number">256</span></span><br></pre></td></tr></table></figure>

<p>“分类器”这个类包括一种“预测”方法，该方法会提取上文所定义图像的输入，输出该图像属于每一类别的概率。</p>
<p>创建预期输入：预处理)</p>
<p>我们首先来进行一项简单的任务：尝试从数据集中正确分类已标记图像。我们可以通过运行下方单元来加载图像并进行查看。</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import matplotlib.pyplot <span class="keyword">as</span> plt #matplotlib.pyplot allows us <span class="keyword">to</span> visualize results</span><br><span class="line">input_image= caffe.io.load<span class="constructor">_image('<span class="operator">/</span><span class="params">dli</span><span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">dogscats</span><span class="operator">/</span><span class="params">train</span><span class="operator">/</span><span class="params">cats</span><span class="operator">/</span><span class="params">cat</span>.10941.<span class="params">jpg</span>')</span></span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show<span class="literal">()</span></span><br></pre></td></tr></table></figure>

<p>虽然我们已获得此图像，但它并非网络所期望的“输入”。</p>
<p>在准备推理数据时，我们需遵循一条黄金法则：</p>
<blockquote>
<p>训练前的所有操作均需在推理之前完成</p>
</blockquote>
<p>在上一节中，您看到了 DIGITS 在训练模型时生成的文件。而在本节，我们将检测 DIGITS 在创建数据集时生成的文件。</p>
<p>当您从模型页面“狗和猫”中选择数据集及/或从 DIGITS“数据集”选项卡下选择数据集时，便可找到所训练<strong>数据集</strong>的工作目录。工作目录与模型所在位置相同，只不过编号应会有所不同。</p>
<p>使用此工作目录替换 ##FIXME##，并执行下方代码以将 DATA_JOB_DIR 设置为正确的文件路径，然后检查此路径下的内容：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">DATA_JOB_DIR</span> = <span class="string">'/dli/data/digits/20180222-165843-ada0'</span>  <span class="comment">## Remember to set this to be the job directory for your model</span></span><br><span class="line">!ls <span class="variable">$DATA_JOB_DIR</span></span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">create_train_db</span><span class="selector-class">.log</span>  <span class="selector-tag">labels</span><span class="selector-class">.txt</span>        <span class="selector-tag">mean</span><span class="selector-class">.jpg</span>       <span class="selector-tag">train</span><span class="selector-class">.txt</span>  <span class="selector-tag">val</span><span class="selector-class">.txt</span></span><br><span class="line"><span class="selector-tag">create_val_db</span><span class="selector-class">.log</span>    <span class="selector-tag">mean</span><span class="selector-class">.binaryproto</span>  <span class="selector-tag">status</span><span class="selector-class">.pickle</span>  <span class="selector-tag">train_db</span>	 <span class="selector-tag">val_db</span></span><br></pre></td></tr></table></figure>



<p>同样，此处会提供超过您目前所需的更多信息。您<em>能够</em>了解有关数据科学和数据准备的海量信息，并会在解决各类深度学习问题后获得更清晰的认知。在本例中，DIGITS 在训练之前执行了两个步骤。我们称之为<em>预处理</em>。</p>
<p>1) DIGITS 将图像调整为 256X256 大小的彩色图像</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line">input_image=cv2.resize(input_image, (<span class="number">256</span>, <span class="number">256</span>), <span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>2) DIGITS 通过从每张图像中减除均值图像以将图像<em>标准化</em>，以此减少训练所需的计算量。</p>
<p>加载均值图像，并将其从以下测试图像中减除：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mean_image = caffe.io.load_image(DATA_JOB_DIR+<span class="string">'/mean.jpg'</span>)</span><br><span class="line">ready_image = input_image-mean_image</span><br></pre></td></tr></table></figure>

<p>我们现已取得原始数据，并已将其转换为网络所期望的数据。接下来，我们来看一下网络所创建的输出。</p>
<h2 id="前向传播：使用您的模型"><a href="#前向传播：使用您的模型" class="headerlink" title="前向传播：使用您的模型"></a>前向传播：使用您的模型</h2><p>这就是我们的关注所在。我们来看看这个函数： <code>prediction = net.predict([grid_square])</code>.</p>
<p>与其他任一 <a href="https://www.khanacademy.org/computing/computer-programming/programming#functions" target="_blank" rel="noopener">函数</a> 类似，<code>net.predict</code> 也会传递输入 <code>ready_image</code>，并返回输出 <code>prediction</code>。但与其他函数不同，该函数并不遵循一组步骤，而是逐层开展矩阵数学运算，以将图像转换为概率向量。</p>
<p>运行下方单元，以查看对以上已标记数据作出的预测。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make prediction</span></span><br><span class="line">prediction = net.predict([ready_image])</span><br><span class="line"><span class="keyword">print</span> prediction</span><br><span class="line">--[[ <span class="number">0.70993775</span>  <span class="number">0.29006225</span>]]</span><br></pre></td></tr></table></figure>

<p>结果很有趣，但并未包含太多信息。我们的网络获取到 256x256 大小的标准化彩色图像，并生成一个长度为 2 的向量。</p>
<h2 id="生成有用的输出：后处理"><a href="#生成有用的输出：后处理" class="headerlink" title="生成有用的输出：后处理"></a>生成有用的输出：后处理</h2><p>此时，我们便可真正构建想要的任何内容。而唯一的局限在于您的编程经验。在进行创意操作之前，我们先来构建一些基本内容。此代码将能确定网络输出“狗”的概率是否高于“猫”。若为此，当狗接近模拟的狗门时，其将显示适当的图像。否则，若网络确定门前是只猫，图像便会呈现我们希望看到的内容。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">"Input image:"</span>)</span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Output:"</span>)</span><br><span class="line"><span class="keyword">if</span> prediction.argmax()==<span class="number">0</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Sorry cat:( https://media.giphy.com/media/jb8aFEQk3tADS/giphy.gif"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Welcome dog! https://www.flickr.com/photos/aidras/5379402670"</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/29/jewqLO3yNzpb8Fm.png" alt="1584367324218"></p>
<p>此时，我们已在此处做好所有准备工作，您现在可以对狗门可能会看到的图像进行测试。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##Create an input our network expects</span></span><br><span class="line">input_image= caffe.io.load_image(<span class="string">'/dli/data/fromnest.PNG'</span>)</span><br><span class="line"><span class="attribute">input_image</span>=cv2.resize(input_image, (256, 256), 0,0)</span><br><span class="line">ready_image = input_image-mean_image</span><br><span class="line"><span class="comment">##Treat our network as a function that takes an input and generates an output</span></span><br><span class="line">prediction = net.predict([ready_image])</span><br><span class="line"><span class="builtin-name">print</span>(<span class="string">"Input Image:"</span>)</span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show()</span><br><span class="line"><span class="builtin-name">print</span>(prediction)</span><br><span class="line"><span class="comment">##Create a useful output</span></span><br><span class="line"><span class="builtin-name">print</span>(<span class="string">"Output:"</span>)</span><br><span class="line"><span class="keyword">if</span> prediction.argmax()==0:</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Sorry cat:( https://media.giphy.com/media/jb8aFEQk3tADS/giphy.gif"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="builtin-name">print</span> <span class="string">"Welcome dog! https://www.flickr.com/photos/aidras/5379402670"</span></span><br></pre></td></tr></table></figure>

<p><img src="1584367353177.png" alt="1584367353177"></p>
<p>基本上，我们已经为狗门挑战创建出模拟器。我们已创建一款应用程序，其能从摄像机中提取输入、将其转换为网络所期望的数据类型、生成输出，并将该输出转换为对用户有用的内容。</p>
<p>您能够了解如何通过正确的输出来轻松控制狗门的动力开关装置。在深度学习方面，您已掌握所需的一切！如要查看可在以上代码块中试用的其他图像<code>列表</code>，您可通过运行下方命令来找到测试图像（不用于训练的图像）。其中一些图像预计会输出错误分类。您需要不断测试这些图像直到取得满意的结果为止，然后再继续课程学习，以了解如何提高性能！</p>
<h2 id="融会贯通"><a href="#融会贯通" class="headerlink" title="融会贯通"></a>融会贯通</h2><p>我们来系统全面地理解一下该部署过程，看看它在此 Jupyter notebook 之外会是什么样。在 <a href="http://ec2-54-227-229-252.compute-1.amazonaws.com/Bamaudsn/edit/tasks/task3/task/pythondeployment.py" target="_blank" rel="noopener">pythondeployment.py</a> 的 Python 文件中，您将看到与上文相同的代码，不过此处代码已合并至同一个文件。在课程末尾的“评估”一节中，您将使用此方法，所以现在请作一些了解。将文件路径插入到此处的测试图像，以对其进行可视化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TEST_IMAGE = <span class="string">'/dli/data/dogscats/test/1.jpg'</span></span><br><span class="line">display= caffe.io.load_image(TEST_IMAGE)</span><br><span class="line">plt.imshow(display)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>然后，运行我们的小型 python 应用程序，并按下方输入该图像。请忽略输出的大部分内容，并滚动至底部。（即使出现错误和警告也没关系。）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">!python pythondeployment.py $TEST_IMAGE <span class="number">2</span>&gt;/dev/null</span><br><span class="line">[[ <span class="number">0.42844081</span>  <span class="number">0.57155913</span>]]</span><br><span class="line">Output:</span><br><span class="line">Welcome dog! https://www.flickr.com/photos/aidras/<span class="number">5379402670</span></span><br><span class="line"><span class="literal">None</span></span><br></pre></td></tr></table></figure>



<h1 id="目标检测"><a href="#目标检测" class="headerlink" title="目标检测"></a>目标检测</h1><h3 id="使用部署"><a href="#使用部署" class="headerlink" title="使用部署"></a>使用部署</h3><p>滑动窗口法需要部署经过训练的图像分类器，以在应用程序中将图像的 256X256 图块分类为“狗”或“猫”，而应用程序则会每次以 256X256 大小的窗口在图像上移动。虽然这一解决方案并不完美，但却可以：</p>
<p>1) 构建一个综合运用深度学习和传统编程的典型方法，从而打造出先前无法构建的应用程序 2) 引导启发学习神经网络架构</p>
<p>在本课程第一节中，您已学习如何成功<em>训练</em>及<em>部署</em>神经网络。您了解到，传统编程不足以支持图像分类，而深度学习不仅能够实现图像分类，还能以直观方式进行呈现。</p>
<p>到目前为止，您已采用现有神经网络和开源数据集（狗和猫），并创建出一个模型，用来对与初始数据集相像及不相像的新动物进行正确分类。这相当厉害！</p>
<p>在<strong>此</strong>任务中，您将学习如何通过以下方式以利用深度学习解决<em>图像分类之外</em>的问题：</p>
<ul>
<li>将深度学习与传统计算机视觉相结合</li>
<li>修改神经网络的内部结构（实际数学运算的部分）</li>
<li>选择适合任务的神经网络</li>
</ul>
<p>并进而解决第二项深度学习挑战：</p>
<p><strong>我们能否在图像中检测并定位物体？</strong></p>
<p>首先，我们会采用与上一节相同的方式，将模型实例化。我们引入模型和数据集工作目录来利用模型架构、经过训练的权重和预处理信息（如均值图像）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np <span class="comment">#Data is often stored as "Numpy Arrays"</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt <span class="comment">#matplotlib.pyplot allows us to visualize results</span></span><br><span class="line"><span class="keyword">import</span> caffe <span class="comment">#caffe is our deep learning framework, we'll learn a lot more about this later in this task.</span></span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line">MODEL_JOB_DIR = <span class="string">'/dli/data/digits/20180301-185638-e918'</span>  <span class="comment">## Remember to set this to be the job directory for your model</span></span><br><span class="line">DATASET_JOB_DIR = <span class="string">'/dli/data/digits/20180222-165843-ada0'</span>  <span class="comment">## Remember to set this to be the job directory for your dataset</span></span><br><span class="line"></span><br><span class="line">MODEL_FILE = MODEL_JOB_DIR + <span class="string">'/deploy.prototxt'</span>                 <span class="comment"># This file contains the description of the network architecture</span></span><br><span class="line">PRETRAINED = MODEL_JOB_DIR + <span class="string">'/snapshot_iter_735.caffemodel'</span>    <span class="comment"># This file contains the *weights* that were "learned" during training</span></span><br><span class="line">MEAN_IMAGE = DATASET_JOB_DIR + <span class="string">'/mean.jpg'</span>                      <span class="comment"># This file contains the mean image of the entire dataset. Used to preprocess the data.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Tell Caffe to use the GPU so it can take advantage of parallel processing. </span></span><br><span class="line"><span class="comment"># If you have a few hours, you're welcome to change gpu to cpu and see how much time it takes to deploy models in series. </span></span><br><span class="line">caffe.set_mode_gpu()</span><br><span class="line"><span class="comment"># Initialize the Caffe model using the model trained in DIGITS</span></span><br><span class="line">net = caffe.Classifier(MODEL_FILE, PRETRAINED,</span><br><span class="line">                       channel_swap=(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">                       raw_scale=<span class="number">255</span>,</span><br><span class="line">                       image_dims=(<span class="number">256</span>, <span class="number">256</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># load the mean image from the file</span></span><br><span class="line">mean_image = caffe.io.load_image(MEAN_IMAGE)</span><br><span class="line">print(<span class="string">"Ready to predict."</span>)</span><br></pre></td></tr></table></figure>

<p>接着，我们将直接从前门监控摄像头中获取一张图像。请注意，此图像大于 256X256。我们想知道狗在此图像中位于<em>何处</em>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Choose a random image to test against</span></span><br><span class="line"><span class="comment">#RANDOM_IMAGE = str(np.random.randint(10))</span></span><br><span class="line">IMAGE_FILE = <span class="string">'/dli/tasks/task5/task/images/LouieReady.png'</span></span><br><span class="line">input_image= caffe.io.load_image(IMAGE_FILE)</span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<h3 id="使用我们所学的函数：前向传播"><a href="#使用我们所学的函数：前向传播" class="headerlink" title="使用我们所学的函数：前向传播"></a>使用我们所学的函数：前向传播</h3><p>这就是我们的关注所在。我们来看看这个函数： <code>prediction = net.predict([grid_square])</code>。</p>
<p>与其他任一 <a href="https://www.khanacademy.org/computing/computer-programming/programming#functions" target="_blank" rel="noopener">函数</a>类似，<code>net.predict</code> 也会传递输入 <code>grid_square</code>，并返回输出 <code>预测</code>。但与其他函数不同，该函数并不遵循一组步骤，而是逐层开展矩阵数学运算，以将图像转换为概率向量。</p>
<p>运行以下单元，以从我们随机图像左上方的 256X256 <code>grid_square</code> 查看预测。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">X = <span class="number">0</span></span><br><span class="line">Y = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">grid_square = input_image[X*<span class="number">256</span>:(X+<span class="number">1</span>)*<span class="number">256</span>,Y*<span class="number">256</span>:(Y+<span class="number">1</span>)*<span class="number">256</span>]</span><br><span class="line"><span class="comment"># subtract the mean image (because we subtracted it while we trained the network - more on this in next lab)</span></span><br><span class="line">grid_square -= mean_image</span><br><span class="line"><span class="comment"># make prediction</span></span><br><span class="line">prediction = net.predict([grid_square])</span><br><span class="line"><span class="keyword">print</span> prediction</span><br></pre></td></tr></table></figure>

<p>这是所用网络最后一层的输出。层类型为“softmax”，其中每个单元的值越高，图像属于该类的可能性就越大。在上例中，如果向量的第二个单元高于第一个（且网络已经过训练），则该部分图像便可能包含<em>狗\</em>。由于在本例中，第一个单元<em>远</em>高于第二个，因此很显然，网络并未在左上方的 256x256 网格中检测到狗。</p>
<p>可选：<a href="https://en.wikipedia.org/wiki/Softmax_function" target="_blank" rel="noopener">探索 softmax 的数学运算。</a></p>
<p>接下来，我们将对此函数实施一些代码以对图像进行迭代，并对每个 grid_square 进行分类以创建热图。请注意，本节的课程关键在于，我们可以在此函数上构建“任何东西”，但凡所想，均可构建。</p>
<p>根据具体编程（尤其是 Python）操作的差异，您或许会从以下单元获得截然不同的信息。其核心是，这个块会把我们的输入图像分割成 256X256 大小的方块，并会在我们的狗分类器中对其逐一运行；之后此块会根据分类器所得结果创建新图像，其中没有狗时图像为蓝色，而有狗时则为红色。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Load the input image into a numpy array and display it</span></span><br><span class="line">input_image = caffe.io.load_image(IMAGE_FILE)</span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate how many 256x256 grid squares are in the image</span></span><br><span class="line">rows = input_image.shape[<span class="number">0</span>]/<span class="number">256</span></span><br><span class="line">cols = input_image.shape[<span class="number">1</span>]/<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize an empty array for the detections</span></span><br><span class="line">detections = np.zeros((rows,cols))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Iterate over each grid square using the model to make a class prediction</span></span><br><span class="line">start = time.time()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,rows):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,cols):</span><br><span class="line">        grid_square = input_image[i*<span class="number">256</span>:(i+<span class="number">1</span>)*<span class="number">256</span>,j*<span class="number">256</span>:(j+<span class="number">1</span>)*<span class="number">256</span>]</span><br><span class="line">        <span class="comment"># subtract the mean image</span></span><br><span class="line">        grid_square -= mean_image</span><br><span class="line">        <span class="comment"># make prediction</span></span><br><span class="line">        prediction = net.predict([grid_square]) </span><br><span class="line">        detections[i,j] = prediction[<span class="number">0</span>].argmax()</span><br><span class="line">end = time.time()</span><br><span class="line">        </span><br><span class="line"><span class="comment"># Display the predicted class for each grid square</span></span><br><span class="line">plt.imshow(detections, interpolation=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Display total time to perform inference</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Total inference time: '</span> + str(end-start) + <span class="string">' seconds'</span></span><br></pre></td></tr></table></figure>

<p>同样，这是随机选择的广域测试图像的输出结果和一个数组，显示输入到模型的每个非重叠 256x256 网格的预测类。</p>
<p>在我们更好地解决问题之前，请花一分钟时间回想刚才的操作，并回答以下问题：</p>
<p><strong>用您自己的话描述一下我们刚刚如何使用图像分类器检测物体？</strong></p>
<p>本节旨在说明任何深度学习解决方案都不过是从输入到输出的映射。这一实现手段使我们能够更易理解如何构建更复杂的解决方案。例如，Alexa、Google Assistant 和 Siri 之类的语音助手必须将原始声音数据转换为文本，并将文本转换为相应的理解，最后再将相应的理解转换为预期任务，例如播放您最喜爱的歌曲。</p>
<p>其复杂性影响之广堪比任何已经或能够借助计算机科学构建的内容。请思考，在解决此类编码/问题所面临的挑战中，有哪些因素是我们未考虑到的，又该如何对其进行处理？</p>
<p>可能的答案：[单击此处](<a href="http://ec2-54-173-199-14.compute-1.amazonaws.com/33avr1Ti/notebooks/tasks/task5/task/Object" target="_blank" rel="noopener">http://ec2-54-173-199-14.compute-1.amazonaws.com/33avr1Ti/notebooks/tasks/task5/task/Object</a> detection-zh.ipynb#answer1)</p>
<h3 id="1-4-挑战性练习（可选）："><a href="#1-4-挑战性练习（可选）：" class="headerlink" title="1.4 挑战性练习（可选）："></a>1.4 挑战性练习（可选）：</h3><p>1.使网格大小保持在 256x256，修改代码以增加网格间的重叠，并获得更精细的分类地图。</p>
<p>2.修改代码以将多个网格批量传递到网络中进行预测。</p>
<p>答案：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> caffe</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">MODEL_JOB_NUM = <span class="string">'##FIXME##'</span>  <span class="comment">## Remember to set this to be the job number for your model</span></span><br><span class="line">DATASET_JOB_NUM = <span class="string">'##FIXME##'</span>  <span class="comment">## Remember to set this to be the job number for your dataset</span></span><br><span class="line"></span><br><span class="line">MODEL_FILE = <span class="string">'/dli/data/digits/'</span> + MODEL_JOB_NUM + <span class="string">'/deploy.prototxt'</span>                 <span class="comment"># Do not change</span></span><br><span class="line">PRETRAINED = <span class="string">'/dli/data/digits/'</span> + MODEL_JOB_NUM + <span class="string">'/snapshot_iter_735.caffemodel'</span>    <span class="comment"># Do not change</span></span><br><span class="line">MEAN_IMAGE = <span class="string">'/dli/data/digits/'</span> + DATASET_JOB_NUM + <span class="string">'/mean.jpg'</span>                      <span class="comment"># Do not change</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># load the mean image</span></span><br><span class="line">mean_image = caffe.io.load_image(MEAN_IMAGE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Choose a random image to test against</span></span><br><span class="line"><span class="comment">#RANDOM_IMAGE = str(np.random.randint(10))</span></span><br><span class="line">IMAGE_FILE = <span class="string">'/dli/data/LouieReady.png'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># Tell Caffe to use the GPU</span></span><br><span class="line">caffe.set_mode_gpu()</span><br><span class="line"><span class="comment"># Initialize the Caffe model using the model trained in DIGITS</span></span><br><span class="line">net = caffe.Classifier(MODEL_FILE, PRETRAINED,</span><br><span class="line">                       channel_swap=(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>),</span><br><span class="line">                       raw_scale=<span class="number">255</span>,</span><br><span class="line">                       image_dims=(<span class="number">256</span>, <span class="number">256</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load the input image into a numpy array and display it</span></span><br><span class="line">input_image = caffe.io.load_image(IMAGE_FILE)</span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Calculate how many 256x256 grid squares are in the image</span></span><br><span class="line">rows = input_image.shape[<span class="number">0</span>]/<span class="number">256</span></span><br><span class="line">cols = input_image.shape[<span class="number">1</span>]/<span class="number">256</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Subtract the mean image</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,rows):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,cols):</span><br><span class="line">        input_image[i*<span class="number">256</span>:(i+<span class="number">1</span>)*<span class="number">256</span>,j*<span class="number">256</span>:(j+<span class="number">1</span>)*<span class="number">256</span>] -= mean_image</span><br><span class="line">        </span><br><span class="line"><span class="comment"># Initialize an empty array for the detections</span></span><br><span class="line">detections = np.zeros((rows,cols))</span><br><span class="line">        </span><br><span class="line"><span class="comment"># Iterate over each grid square using the model to make a class prediction</span></span><br><span class="line">start = time.time()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,rows):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,cols):</span><br><span class="line">        grid_square = input_image[i*<span class="number">256</span>:(i+<span class="number">1</span>)*<span class="number">256</span>,j*<span class="number">256</span>:(j+<span class="number">1</span>)*<span class="number">256</span>]</span><br><span class="line">        <span class="comment"># make prediction</span></span><br><span class="line">        prediction = net.predict([grid_square])</span><br><span class="line">        detections[i,j] = prediction[<span class="number">0</span>].argmax()</span><br><span class="line">end = time.time()</span><br><span class="line">        </span><br><span class="line"><span class="comment"># Display the predicted class for each grid square</span></span><br><span class="line">plt.imshow(detections)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Display total time to perform inference</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Total inference time (sliding window without overlap): '</span> + str(end-start) + <span class="string">' seconds'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># define the amount of overlap between grid cells</span></span><br><span class="line">OVERLAP = <span class="number">0.25</span></span><br><span class="line">grid_rows = int((rows<span class="number">-1</span>)/(<span class="number">1</span>-OVERLAP))+<span class="number">1</span></span><br><span class="line">grid_cols = int((cols<span class="number">-1</span>)/(<span class="number">1</span>-OVERLAP))+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"Image has %d*%d blocks of 256 pixels"</span> % (rows, cols)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"With overlap=%f grid_size=%d*%d"</span> % (OVERLAP, grid_rows, grid_cols)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize an empty array for the detections</span></span><br><span class="line">detections = np.zeros((grid_rows,grid_cols))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Iterate over each grid square using the model to make a class prediction</span></span><br><span class="line">start = time.time()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,grid_rows):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,grid_cols):</span><br><span class="line">        start_col = int(j*<span class="number">256</span>*(<span class="number">1</span>-OVERLAP))</span><br><span class="line">        start_row = int(i*<span class="number">256</span>*(<span class="number">1</span>-OVERLAP))</span><br><span class="line">        grid_square = input_image[start_row:start_row+<span class="number">256</span>, start_col:start_col+<span class="number">256</span>]</span><br><span class="line">        <span class="comment"># make prediction</span></span><br><span class="line">        prediction = net.predict([grid_square])</span><br><span class="line">        detections[i,j] = prediction[<span class="number">0</span>].argmax()</span><br><span class="line">end = time.time()</span><br><span class="line">        </span><br><span class="line"><span class="comment"># Display the predicted class for each grid square</span></span><br><span class="line">plt.imshow(detections)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Display total time to perform inference</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'Total inference time (sliding window with %f%% overlap: '</span> % (OVERLAP*<span class="number">100</span>)) + str(end-start) + <span class="string">' seconds'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now with batched inference (one column at a time)</span></span><br><span class="line"><span class="comment"># we are not using a caffe.Classifier here so we need to do the pre-processing</span></span><br><span class="line"><span class="comment"># manually. The model was trained on random crops (256*256-&gt;227*227) so we</span></span><br><span class="line"><span class="comment"># need to do the cropping below. Similarly, we need to convert images</span></span><br><span class="line"><span class="comment"># from Numpy's Height*Width*Channel (HWC) format to Channel*Height*Width (CHW) </span></span><br><span class="line"><span class="comment"># Lastly, we need to swap channels from RGB to BGR</span></span><br><span class="line">net = caffe.Net(MODEL_FILE, PRETRAINED, caffe.TEST)</span><br><span class="line">start = time.time()</span><br><span class="line">net.blobs[<span class="string">'data'</span>].reshape(*[grid_cols, <span class="number">3</span>, <span class="number">227</span>, <span class="number">227</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize an empty array for the detections</span></span><br><span class="line">detections = np.zeros((rows,cols))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,rows):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,cols):</span><br><span class="line">        grid_square = input_image[i*<span class="number">256</span>:(i+<span class="number">1</span>)*<span class="number">256</span>,j*<span class="number">256</span>:(j+<span class="number">1</span>)*<span class="number">256</span>]</span><br><span class="line">        <span class="comment"># add to batch</span></span><br><span class="line">        grid_square = grid_square[<span class="number">14</span>:<span class="number">241</span>,<span class="number">14</span>:<span class="number">241</span>] <span class="comment"># 227*227 center crop        </span></span><br><span class="line">        image = np.copy(grid_square.transpose(<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>)) <span class="comment"># transpose from HWC to CHW</span></span><br><span class="line">        image = image * <span class="number">255</span> <span class="comment"># rescale</span></span><br><span class="line">        image = image[(<span class="number">2</span>,<span class="number">1</span>,<span class="number">0</span>), :, :] <span class="comment"># swap channels</span></span><br><span class="line">        net.blobs[<span class="string">'data'</span>].data[j] = image</span><br><span class="line">    <span class="comment"># make prediction</span></span><br><span class="line">    output = net.forward()[net.outputs[<span class="number">-1</span>]]</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,cols):</span><br><span class="line">        detections[i,j] = output[j].argmax()</span><br><span class="line">end = time.time()</span><br><span class="line">        </span><br><span class="line"><span class="comment"># Display the predicted class for each grid square</span></span><br><span class="line">plt.imshow(detections)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Display total time to perform inference</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Total inference time (batched inference): '</span> + str(end-start) + <span class="string">' seconds'</span></span><br></pre></td></tr></table></figure>

<p>正如当前所示，此滑动窗口法的优点在于我们可以仅使用基于局部的训练数据（可以更广泛地获取）训练检测器，且能帮助我们凭借当前的技能组合着手解决问题。</p>
<p>我们可以不断调整代码以确认自己能否继续通过蛮力解决问题（错误且缓慢），但也可学习更多有关深度学习的知识。我们来选择第二种方式。</p>
<h2 id="方法-2-–-基于已有神经网络进行重建-¶-http-ec2-54-173-199-14-compute-1-amazonaws-com-33avr1Ti-notebooks-tasks-task5-task-Object-detection-zh-ipynb-方法-2-–-基于已有神经网络进行重建"><a href="#方法-2-–-基于已有神经网络进行重建-¶-http-ec2-54-173-199-14-compute-1-amazonaws-com-33avr1Ti-notebooks-tasks-task5-task-Object-detection-zh-ipynb-方法-2-–-基于已有神经网络进行重建" class="headerlink" title="方法 2 – 基于已有神经网络进行重建[¶](http://ec2-54-173-199-14.compute-1.amazonaws.com/33avr1Ti/notebooks/tasks/task5/task/Object detection-zh.ipynb#方法-2-–-基于已有神经网络进行重建)"></a>方法 2 – 基于已有神经网络进行重建[¶](<a href="http://ec2-54-173-199-14.compute-1.amazonaws.com/33avr1Ti/notebooks/tasks/task5/task/Object" target="_blank" rel="noopener">http://ec2-54-173-199-14.compute-1.amazonaws.com/33avr1Ti/notebooks/tasks/task5/task/Object</a> detection-zh.ipynb#方法-2-–-基于已有神经网络进行重建)</h2><p>请记住，深度神经网络的构建灵感源自于人脑。本节将说明如何<em>更改</em>网络以改变其行为和性能。就其核心而言，这些网络均由数学运算组成，改变数学运算即会改变大脑。本节不会全面深入地解释各类网络可完美解决各类问题的具体<em>原因</em>，因为这是一种会随时间逐渐累积的直觉知识。相反，本节将侧重介绍您在试验期间需牢记的限制条件。我们可能会介绍一些常见的层类型，但这并非本课程的内容要点。</p>
<p>我们先来探讨一下当前的网络 AlexNet 吧。</p>
<h3 id="2-1-当前网络"><a href="#2-1-当前网络" class="headerlink" title="2.1 当前网络"></a>2.1 当前网络</h3><p>这些网络的结构均会在某类<em>框架</em>中进行说明，而本例中使用的是 Caffe 框架。<a href="https://developer.nvidia.com/deep-learning-frameworks" target="_blank" rel="noopener">框架种类数不胜数</a>，其中每种框架都能使从业者对网络进行宏观描述，而不必对 GPU 进行物理编程以执行张量数学运算。</p>
<h2 id="方法-3：DetectNet"><a href="#方法-3：DetectNet" class="headerlink" title="方法 3：DetectNet"></a>方法 3：DetectNet</h2><p>在此实验开始时，我们采用的是 AlexNet，这是一款针对极具体<em>图像分类</em>问题的卓越解决方案。我们对其构建一些 Python 代码，然后开展轻微的网络手术，以此来完成一项在利用深度学习开始<em>目标检测</em>工作之前本不可能达成的任务。</p>
<p>不过，是否存在一款专门针对<em>目标检测</em>的卓越解决方案？我们能否建立一个模型，使其直接从输入（航拍照片）映射至预想的输出（定位和检测信息）？</p>
<p>此解决方案的存在将有助我们拓广对深度学习的定义，并能帮助您深入了解可借助其解决哪些<em>其他</em>问题。</p>
<p>本课程首先讨论的是深度学习得以实现的三个要素。</p>
<p>1) 深度神经网络 2) GPU 3) 大数据</p>
<p>当我们超出图像分类的讨论范围时，以上要素仍保持不变，但网络类型、数据和 GPU 的使用会有所不同。我们将从数据谈起，因为这是我们的工作流程在 DIGITS 中的组织方式。</p>
<h3 id="数据差异"><a href="#数据差异" class="headerlink" title="数据差异"></a>数据差异</h3><p>如要构建端到端监督式深度学习工作流程，我们需要已标记的数据。到目前为止，我们已将“已标记”定义为每个图像所属类别的指标。然而，标记数据的真正目的在于**创建输入输出映射。”</p>
<p>在本例中，我们希望输入“任意”尺寸的图像，且输出结果应能表明物体在图像中的所处位置。首先，请输入图像：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input_image = caffe.io.load_image(<span class="string">'/dli/data/train/images/488156.jpg'</span>) <span class="comment">#!ls this directory to see what other images and labels you could test</span></span><br><span class="line">plt.imshow(input_image)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>然后，为其加上对应标签：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!cat <span class="string">'/dli/data/train/labels/488156.txt'</span> <span class="comment">#"cat" has nothing to do with the animals, this displays the text</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>1) 输入及其对应输出基于文件编号一一照应。 2) 所见向量由输入图像中狗的左上方和底部位置的 (x,y) 坐标构成。 3) 如果有足够的冲浪板数据，我们则可训练冲浪板检测器而非狗检测器！在本例中，我们会将数据集设置为只寻找狗。</p>
<p>将此数据集加载到 DIGITS 中。</p>
<p>从 <a href="http://ec2-54-173-199-14.compute-1.amazonaws.com/digits" target="_blank" rel="noopener">DIGITS</a> 主页面中，选择“Datasets”（数据集），然后添加新的<strong>“目标检测”数据集。</strong>请注意，这些参数看起来不同于进行分类时的参数。</p>
<p>打开“New Object Detection Dataset”（新的目标检测数据集）面板后，请使用以下图像的预处理选项（<strong>请留意前部/尾部间距</strong>）：</p>
<p>训练图像文件夹：/dli/data/train/images 训练标签文件夹：/dli/data/train/labels 验证图像文件夹：/dli/data/val/images 验证标签文件夹：/dli/data/val/labels/dog 补齐图像（宽 x 高）：640 x 640 自定义类：dontcare, dog 组名称：MS-COCO 数据集名称：coco-dog</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/02/29/2020-02-29-MachineLearning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/29/2020-02-29-MachineLearning/" itemprop="url">Machine_Learning</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-29T10:16:18+08:00">
                2020-02-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了机器学习的一些笔记。</p>
<h2 id="欠拟合与过拟合"><a href="#欠拟合与过拟合" class="headerlink" title="欠拟合与过拟合"></a>欠拟合与过拟合</h2><p>西瓜书：我们实际希望的，是在新样本上能表现的很好的学习器。为了达到这个目的，应该从训练样本中尽可能学出适用于所有潜在样本的“普遍规律”，这样才能在遇到新样本时做出正确的判别，然而，当学习器把训练样本学得“太好”了的时候，很可能把训练样本本身的一些特点当作了所有潜在样本都会具有的一般性质，这样会导致泛化性能下降。欠拟合则是指对训练样本的一般性质没学好，它比较容易克服，例如通过在决策树学习中扩展分支，在神经网络学习中增加训练次数等。过拟合则比较麻烦，是ML面临的关键障碍，它是无法彻底避免的，我们能做的只是“缓解”，或者说是减少其风险。</p>
<p><img src="https://i.loli.net/2020/03/29/7vzmD4AsSI21XBC.png" alt="1580776286554"></p>
<p>如上图所示：用一次函数进行欠拟合<code>underfitting</code>，会出现数据点都已经平缓了但是函数曲线依旧上升的错误结果，这是先入为主的，具有高偏差且不能预测房子的价格。</p>
<p>而用第三幅图的高次函数进行过拟合<code>overfitting</code>，可以使得整体的偏差函数J达到最小，毕竟将每个点都紧密的连在了一起，具有高方差但是这样起起伏伏的曲线也不能预测未来的房子的价格走势。</p>
<p><img src="https://i.loli.net/2020/03/29/YTe8ALcOmpyIqsf.png" alt="1580777298194"></p>
<p>但是，如果我们有过多的变量，而只有很少的训练数据时，（比如我们预测房价时感觉房子面积、卧室数量、厨房面积等都和房价有关系）就会出现过度拟合的问题。【如果训练数据多的话，每个点挨得密密的，那么就可以不用进行过度波动了，也就可以进行预测房价走势了】</p>
<p>为了减少过拟合，有两个方法：一个是减少选取变量的数量或者就选择重要的变量；另外一个是正则化。</p>
<p><img src="https://i.loli.net/2020/03/29/mvQfCiq2AwxU5Y7.png" alt="1580789332698"></p>
<p>正则化的意思就是说既保留特征变量，又通过使特征变量前面的参数变得微不足道来避免过拟合，lambda就是用来控制这两个参数之间的平衡关系trade-off，即更好的去拟合训练集的目标和将参数控制的更小的目标。如果对参数的惩罚（penalize）过大会导致参数趋近于0，导致最后只有一个参数，这就是欠拟合的例子。</p>
<blockquote>
<p>这里的1/2m是用来减少值，m是样本容量，只是为了使数学更直白一点。</p>
</blockquote>
<h2 id="梯度下降"><a href="#梯度下降" class="headerlink" title="梯度下降"></a>梯度下降</h2><h3 id="总而言之，权重告诉你这个第二层的神经元关注什么样的像素图案，偏置（bias）则告诉你加权和得有多大，才能让神经元的激发变得有意义。"><a href="#总而言之，权重告诉你这个第二层的神经元关注什么样的像素图案，偏置（bias）则告诉你加权和得有多大，才能让神经元的激发变得有意义。" class="headerlink" title="总而言之，权重告诉你这个第二层的神经元关注什么样的像素图案，偏置（bias）则告诉你加权和得有多大，才能让神经元的激发变得有意义。"></a>总而言之，权重告诉你这个第二层的神经元关注什么样的像素图案，偏置（bias）则告诉你加权和得有多大，才能让神经元的激发变得有意义。</h3><p><img src="https://i.loli.net/2020/03/29/qylHXtrwP93u6Jc.png" alt="1582623473821"></p>
<p>你要将每个垃圾（错误的）输出激活值与你想要的值之间的差的平方加起来，【正确的话就是减1，错误的话就是减0，这样的话错误的输出会得到很高的惩罚】这就是我们称之为训练单个样本的“代价”</p>
<p><img src="https://i.loli.net/2020/03/29/uUPhJgEwkcsnpFq.png" alt="1582624671730"></p>
<p><img src="https://i.loli.net/2020/03/29/Ooz2DRM78lgXqBf.png" alt="1582625328359"></p>
<p><img src="17-%E6%98%9F%E6%9C%9F%E4%B8%80-95202.gif" alt=" "></p>
<p><img src="https://i.loli.net/2020/03/29/5Am4zSWByTnMotN.png" alt="1580955304837"></p>
<p><img src="https://i.loli.net/2020/03/29/V25CKsaX6ZzDjYm.png" alt="1580956150366"></p>
<p><img src="1580957499820.png" alt="1580957499820"></p>
<p><img src="https://i.loli.net/2020/03/29/dEYA6uejGnKWvqF.png" alt="1580957706734"></p>
<p><img src="https://i.loli.net/2020/03/29/LE7gT2WxBnAkqfz.png" alt="1580971811886"></p>
<p><img src="https://i.loli.net/2020/03/29/Fikfzs6RbeYrnox.png" alt="1581130404619"></p>
<h2 id="SVM"><a href="#SVM" class="headerlink" title="SVM"></a>SVM</h2><p>有的二维数据不能很好的用SVM超平面进行分类，就说它是线性不可分的。如何做呢？可以将它进行高维映射，但是怎么选取映射函数是很难的，不如直接就选择核函数进行映射吧还简单。</p>
<p><img src="https://i.loli.net/2020/03/29/rxU2Nl5OWPZetCB.png" alt="image-20200318094304398"></p>
<p><img src="https://i.loli.net/2020/03/29/IZBxtCjfuv74b93.png" alt="1581583849931"></p>
<p><img src="https://i.loli.net/2020/03/29/4EVvsPWGBr2ZhI8.png" alt="1581600347364"></p>
<p><img src="https://i.loli.net/2020/03/29/7AVORCfeqYQ6zkN.png" alt="绿色代表正值，红色代表负值"></p>
<p><img src="https://i.loli.net/2020/03/29/lTWn82jYoUzV1Lg.png" alt=""></p>
<p><img src="https://i.loli.net/2020/03/29/nCdycNZARDSOKgH.png" alt="1583391636661"></p>
<p><img src="https://i.loli.net/2020/03/29/SVjBok6dvct7puP.png" alt="1583392810592"></p>
<p><img src="https://i.loli.net/2020/03/29/gx7pl4i9XhqKVFz.png" alt="1583394660258"></p>
<h3 id="KNN优劣"><a href="#KNN优劣" class="headerlink" title="KNN优劣"></a>KNN优劣</h3><p><img src="https://i.loli.net/2020/03/29/UQWJvuoxsGLXEF2.png" alt="1583809914745"></p>
<h2 id="正则化的作用"><a href="#正则化的作用" class="headerlink" title="正则化的作用"></a>正则化的作用</h2><p>二范式可以让参数的值更平滑。而一范数是绝对值，图像就是有棱有角的，两个参数中一定有一个为0，所以使得参数更稀疏。</p>
<p><img src="1583808319588.png" alt="1583808319588"></p>
<p>正则化是为了惩罚</p>
<p><img src="https://i.loli.net/2020/03/29/vzktO3gA1yxCWcD.png" alt="1583394985712"></p>
<h3 id="卷积"><a href="#卷积" class="headerlink" title="卷积"></a>卷积</h3><p><img src="https://i.loli.net/2020/03/29/PbpsBN4MKq3QEnO.png" alt="1582616523275"></p>
<p><img src="1582617559226.png" alt="绿色代表正值，红色代表负值"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/01/27/2020-01-27-Polarizied/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/01/27/2020-01-27-Polarizied/" itemprop="url">Polarizied_Light</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-01-27T10:16:18+08:00">
                2020-01-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C++</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>这篇文章主要记述了偏振光的一些笔记。</p>
<h1 id="什么是偏振光？"><a href="#什么是偏振光？" class="headerlink" title="什么是偏振光？"></a>什么是偏振光？</h1><p><img src="https://i.loli.net/2020/03/29/BabsK4nLNJ3w6fO.png" alt=""></p>
<p>光在物理学中被定义为一种电磁波，电场和磁场是它两个垂直方向的分量，其中电场分量就是我们能够感知到的光。电磁波是一种横波，即光波的传播方向与振动方向相互垂直，偏振现象是横波特有的特性。偏振即波的振动方向相对于传播方向的轴不对称性。偏振光被定义为电场矢量振动方向轴不对称的光，通俗的讲就是垂直于光传播方向的中心轴线的各个方向的电场矢量的矢量和不为零，各个矢量不能相对于光的传播轴线对称。      光波为明显的横波，且从图 2-1 中可以看出电场的振动矢量不能相对光的传播轴线对称（只有一个电场矢量振动），因此为典型的偏振光。 </p>
<p><img src="https://i.loli.net/2020/03/29/2Qjf4GZsBp3zlIY.png" alt="1580096162683"></p>
<p>偏振光中由于电场矢量的振动形式不同又分为三种偏振光。包括：1，线性偏振光：电场矢量的振动在一个与光传播方向垂直的平面内投影为一条直线，其电矢量的振动方向不变，振动大小随着相位不断变化；2，椭圆偏振光：电场矢量的振动在一个与光传播方向垂直的平面内投影为椭圆，光矢量不断旋转，且它的大小和方向随相位有规律的发生变化；3，电场矢量的振动在垂直于光传播方向的平面内的投影为一个圆，振幅不变的光矢量不停旋转，</p>
<p><img src="https://i.loli.net/2020/03/29/Mha46Yb1zJDkFEm.png" alt="1580097807519"></p>
<p><img src="https://i.loli.net/2020/03/29/gUKdjbDLyuNC58O.png" alt="1584404069165"></p>
<p><img src="clip_image002.jpg" alt=""></p>
<p><img src="https://i.loli.net/2020/03/29/nyB51pMsf4kqHNL.jpg" alt=""></p>
<h2 id="偏光片的主要作用"><a href="#偏光片的主要作用" class="headerlink" title="偏光片的主要作用"></a>偏光片的主要作用</h2><p>偏光片的主要作用是将不具有偏极性的自然光转化为偏极光，使得与电场方向成垂直方向的光线通过。偏光板的内部结构为1平方厘米里有30万个肉眼看不见的直线分子排列体，并排列于同一个方向，让光线偏极化取得柔和光线。【偏光板靠着内部细长键状晶体的整齐排列，把凌乱偏振的光束转变为单一方向偏振的平面偏光】</p>
<p><img src="https://i.loli.net/2020/03/29/38tSMmKBHqgj6dc.png" alt=""></p>
<p><img src="https://i.loli.net/2020/03/29/abWNBFpz6yYGeMC.png" alt="1582292043630"></p>
<p><img src="1582292107403.png" alt="1582292107403"></p>
<h2 id="IMX250MZR"><a href="#IMX250MZR" class="headerlink" title="IMX250MZR"></a>IMX250MZR</h2><p><a href="http://thinklucid.cn/tech-briefs/polarization-explained-sony-polarized-sensor/" target="_blank" rel="noopener">SONY成像</a></p>
<p>Sony 在可见光成像之外的领域扩大了自己传感器技术的领导地位，他的第一个意义深远的偏振传感器是新一代的IMX250MZR（单色）传感器，在基于Pregius 5.0MP IMX250 CMOS 传感器的光电二极管上方加入一层偏振片。四个不同角度的偏振片 (90°, 45°, 135° and 0°) 分别放置于单个像元上，每四个像元一组作为一个计算单元。这一创新的4像元块设计中，通过不同方向偏振器之间的关联能够计算偏振的程度和方向。</p>
<p><img src="https://i.loli.net/2020/03/29/eDRJ1OuImNxEHQA.jpg" alt="Sony-polarized-mono-sensor-pattern-6"></p>
<p><img src="https://i.loli.net/2020/03/29/XnQHa8gWpm4ULho.gif" alt="Polarization-example-with-linear-polarizers"></p>
<p><img src="https://i.loli.net/2020/03/29/OEU9sAVyvhngdHf.gif" alt="reflection-refraction-polarization"></p>
<h2 id="什么是天顶角与方位角？"><a href="#什么是天顶角与方位角？" class="headerlink" title="什么是天顶角与方位角？"></a>什么是天顶角与方位角？</h2><p><img src="https://i.loli.net/2020/03/29/2Mhxwz85APTQRFp.png" alt="1582442446949"></p>
<p><img src="https://i.loli.net/2020/03/29/uin1hKC3lkJa57r.png" alt="1582442464604"></p>
<p><img src="https://i.loli.net/2020/03/29/bSwmzKUjG5dAYrI.png" alt="1582604210527"></p>
<p><img src="https://i.loli.net/2020/03/29/4Dl6Lxfo8UrQMwg.png" alt="1582367056983"></p>
<p><img src="https://i.loli.net/2020/03/29/Tn8keUmo5xR7Bjs.png" alt="1582366952148"></p>
<p><img src="https://i.loli.net/2020/03/29/wl95rILKajByUXx.png" alt="1582553791389"></p>
<h2 id="如何由梯度场求表面形状？"><a href="#如何由梯度场求表面形状？" class="headerlink" title="如何由梯度场求表面形状？"></a>如何由梯度场求表面形状？</h2><p>正如单变量的正函数的定积分代表函数图像和<em>x</em>轴之间区域的<a href="https://zh.wikipedia.org/wiki/面积" target="_blank" rel="noopener">面积</a>一样，正的双变量函数的<strong>双重积分</strong>代表函数所定义的曲面和包含函数<a href="https://zh.wikipedia.org/wiki/定义域" target="_blank" rel="noopener">定义域</a>的平面之间所夹的区域的<a href="https://zh.wikipedia.org/wiki/体积" target="_blank" rel="noopener">体积</a>。</p>
<p><img src="https://i.loli.net/2020/03/29/kPIKxzjow6UWXiM.png" alt="1582724644942"></p>
<h2 id="光的干涉与衍射（李永乐）"><a href="#光的干涉与衍射（李永乐）" class="headerlink" title="光的干涉与衍射（李永乐）"></a>光的干涉与衍射（李永乐）</h2><p>光的干涉发生是有条件的：频率相同且相位差恒定</p>
<p>托马斯很巧妙的设计了：首先使用滤光片将光变成那个只有一种颜色的光（满足了频率相同）；然后通过两个狭小的缝（满足相位差相同），这样在两个光波波峰相叠加的地方会有亮条纹。</p>
<p>光的衍射类似于水在碰到障碍物后又汇聚在一起的现象。</p>
<p><img src="https://i.loli.net/2020/03/29/V8TycxDNCt6Lk3K.png" alt="image-20200320193043941"></p>
<p><img src="https://i.loli.net/2020/03/29/AqazEni6cjbs9wR.png" alt="image-20200320193001318"></p>
<h2 id="图像中高光的产生"><a href="#图像中高光的产生" class="headerlink" title="图像中高光的产生"></a>图像中高光的产生</h2><p>在立体视觉非接触式测量系统中，由CCD相机采集得到的目标物体二维图像涵盖了其三维空间信息，因此在图像采集过程中得到信息度较为丰富的目标物体二维图像是提高立体视觉系统测量精度的前提条件[3-5]。在图像采集过程中受到自然光光照分布不均匀的影响，入射光到物体表面会产生镜面反射与漫反射，镜面反射表征了光源光照的分布，而漫反射则体现了目标物体表面的纹理特征信息[31]。一束光线照射到物体表面后光线的分布情况如图2-1所示。</p>
<p><img src="https://i.loli.net/2020/03/29/AgorvhIqV2XMbwy.png" alt="1580265500429"></p>
<p><img src="https://i.loli.net/2020/03/29/dLyovGk2OUNTxei.png" alt="1580444257800"></p>
<p><img src="https://i.loli.net/2020/03/29/oIgBqQ6ziThMUOn.png" alt="1580716274369"></p>
<h2 id="Polarized-SONY"><a href="#Polarized-SONY" class="headerlink" title="Polarized SONY"></a>Polarized SONY</h2><p>光通过一个媒介到另一个媒介，我们知道叫做折射，折射同样能使部分自然光形成偏振光。折射后形成偏振光的光量取决于离Brewster 角度的远近。（一般情况下反射光和折射光都是部分偏振光，只有当入射角为某特定角时反射光才是线偏振光，其振动方向与入射面垂直，此特定角称为布鲁斯特角，用θB表示。光以布鲁斯特角入射时，反射光与折射光互相垂直。）</p>
<p><img src="https://i.loli.net/2020/03/29/TocfrqAKsPpU2jw.png" alt="1582111356813"></p>
<p><img src="https://i.loli.net/2020/03/29/8Hg5sDVn2wFpZC7.png" alt="1582115870286"></p>
<p><img src="https://i.loli.net/2020/03/29/PbVDHhlUfrS2Iem.png" alt="1582118366461"></p>
<p>在垂直于传播方向的平面内，包含一切可能方向的横振动，且平均【从统计角度来将】说来任一方向上具有相同的振幅，这种横振动对称于传播方向的光称为自然光（非偏振光）。凡其振动失去这种对称性的光统称偏振光。自然光在玻璃、水面、木质桌面等表面反射时，反射光和折射光都是偏振光，而且入射角变化时，偏振的程度也有变化。在拍摄表面光滑的物体，如玻璃器皿、水面、陈列橱柜、油漆表面、塑料表面等，常常会出现耀斑或反光，这是由于反射光波的干扰而引起的。如果在拍摄时加用偏振镜，并适当地旋转偏振镜片，让它的透振方向与反射光的透振方向垂直，就可以减弱反射光而使水下或玻璃后的影像清晰。</p>
<p><strong>偏振光通过一些介质后，其振动方向相对原来的振动方向会发生一定角度的旋转，旋转的这个角度叫旋光度，旋光度与介质的浓度、长度、折射率等因素有关。测量旋光度的大小，就可以知道介质相关物理量的变化。</strong></p>
<p><img src="https://i.loli.net/2020/03/29/9BdgwjNQ2ME8kKy.png" alt="1582259553250"></p>
<p><img src="https://i.loli.net/2020/03/29/Qumz2FyiBAgK1cJ.png" alt="1582259913487"></p>
<p><img src="https://i.loli.net/2020/03/29/RwzTiSGl8HgDYyA.png" alt="1582260677691"></p>
<p><img src="https://i.loli.net/2020/03/29/yJXTwqMubD4UtjI.png" alt="1582260722470"></p>
<p>偏振片并不能将任意偏振态的入射光转化成需要的偏振方向。它只能消除不需要的偏振光。</p>
<h3 id="不同颜色区块表示不同程度的电磁波偏振程度"><a href="#不同颜色区块表示不同程度的电磁波偏振程度" class="headerlink" title="不同颜色区块表示不同程度的电磁波偏振程度"></a>不同颜色区块表示不同程度的电磁波偏振程度</h3><p>偏光片的主要作用是将不具有偏极性的自然光转化为偏极光，使得与电场方向成垂直方向的光线通过。偏光板的内部结构为1平方厘米里有30万个肉眼看不见的直线分子排列体，并排列于同一个方向，让光线偏极化取得柔和光线。【偏光板靠着内部细长键状晶体的整齐排列，把凌乱偏振的光束转变为单一方向偏振的平面偏光】</p>
<p>当太阳光接触到水面、地面、平面反射时，因为直线振动的偏光光线的关系所以很难看清物体—</p>
<p>利用偏光片过滤直线振动的光源特性，并利用分子排列的水平线，重新调整吸收光线的方向。以消除不清楚以及刺眼的光线，让自然光中的乱反射的光线、眩光及物体反射光能有效的阻隔掉。</p>
<p><img src="https://i.loli.net/2020/03/31/97LpQqH4OoSaR5G.png" alt="1582271285114"></p>
<p><img src="https://i.loli.net/2020/03/29/Vsm4a9iKNRIobtA.png" alt="1582291925405"></p>
<p><img src="https://i.loli.net/2020/03/29/whDkRPVu3GpN2lQ.png" alt="1582291992528"></p>
<p>研究表明，通过观测物体表面反射光中的偏振特性，可以获得物体的形状信息，且偏振所具有的“弱光强化，强光弱化”特性，使得即便外界光源不理想，仍然能得到较为清晰的偏振信息，从而进行三维表面恢复.三维重建的方法大致可以分为两种，一种是利用三维激光扫描仪等直接获取测区及环境的三维点云，这种方法精度较高，但是作业时间长，设备昂贵，受限于物体尺寸和材质；另一种是基于视觉的重建方法，多目立体视觉通过提取多张影像的特征点并匹配同名像点[3]，然后利用影像间的几何关系重建三维表面[4]，明暗恢复法（Shape From Shading, SFS）[5]利用单张影像的明暗变化获取物体形状信息，认为灰度值与表面不同位置反射光强弱有关，光度立体法（Photometric Stereo, PS）[6]通过改变入射光源得到多幅明暗不同的影像，利用目标表面同一个像素点在不同影像中的亮度信息得到几何信息，但是这些方法都要求已知光源的方向与强度等，不能很好的适用于大多数情况.基于偏振信息的三维重构方法不依赖物体的纹理特征，同时又能很好地抑制耀光，对低纹理、高反光的物体也能获得完整的三维表面形态.Koshikawa[7]最早将偏振视觉引入三维重建领域；S.Rahmann和N. Canterakis等[8]针对绝缘体反射光的偏振信息首次提出了完整的偏振三维重建算法；Ghosh等[9]利用圆偏光分离了漫反射与镜面反射，完成了物体材质和形状的同时估计；Miche[10]设计一种特定的视觉系统，可实现偏振图像采集与处理，通过积分过程实现三维重建；Kadambi等[11]融合了Kinect得到的粗深度图和偏振图像得到的法向量，得到了较高精度的三维重建结果.该文章出发点与本文较为相似，但本文使用较少的偏振图像，对方位角处理和积分算法更简单高效，并且将结果与扫描仪真值进行了对比分析.国内近年来也开展了偏振三维重建技术的研究，平茜茜等[12]结合双目立体视觉，提出偏振双目视觉三维重建算法，并获得目标的世界坐标系下绝对数据；岳春敏等[13]提出利用解析反射光偏振图像重建透明物体三维表面的方法，并推导偏振度与表面法向量得函数关系，构建三维重建算法；彭群聂等[14]针对视觉任务中表面光滑低纹理的目标，提出多尺度Shapelets算子获取有效深度信息，恢复三维形状.</p>
<p><strong>光矢量即E</strong>。光波是<a href="https://baike.baidu.com/item/电磁波/102449" target="_blank" rel="noopener">电磁波</a>，在光波中，产生感光作用与生理作用的主要是电场强度<strong>E。</strong></p>
<p><img src="https://i.loli.net/2020/03/29/FCSlX2tmbcsjxUi.png" alt="1582347106624"></p>
<p>由于光波对物质的磁场作用远比电场作用弱，所以讨论光场振动性质时通常只考虑电矢量，将电矢量称为光矢量。</p>
<p>根据电磁波特性，空间确定点的<strong>E</strong>和<strong>H</strong>是相关的，为了便于表述，规定<strong>E</strong>为光矢量。电磁波能流密度的时间平均值称为该点的光强。 [1]</p>
<p><img src="https://i.loli.net/2020/03/29/PEg3YVklDv6TIzn.png" alt="1582367123700"></p>
<p><img src="https://i.loli.net/2020/03/29/k8xKRTCaZ1z4uPq.png" alt="1582440866367"></p>
<p><img src="https://i.loli.net/2020/03/29/CB2sm89gidTj6ax.png" alt="1582440878206"></p>
<h2 id="看不懂？"><a href="#看不懂？" class="headerlink" title="看不懂？"></a>看不懂？</h2><p><img src="https://i.loli.net/2020/03/29/tinzFAWdcSlQZgM.png" alt="1582441035090"></p>
<p><img src="https://i.loli.net/2020/03/29/kSjTBA81DvoaXVt.png" alt="1582466348161"></p>
<blockquote>
<p>1、先求曲线在M点（x0,y0,z0）处的切向量；因为分别求出三个坐标轴方向上的偏导就可以合成切向量。</p>
<p>2、然后就可以求出切平面了。</p>
<p>3、利用切线斜率和法线斜率相乘得-1求出法线方程</p>
</blockquote>
<p><img src="https://i.loli.net/2020/03/29/l1vVfnAkBZIdXF2.png" alt="1582516653903"></p>
<p><img src="https://i.loli.net/2020/03/29/nTQq1BM86oZwlfX.png" alt="1582466361177"> </p>
<p><img src="https://i.loli.net/2020/03/29/8dB5ZEiVHhX2Jg6.png" alt="1582466380401"></p>
<p>我们可以从四个角度恢复出相位信息，因为相位信息对应的就是强弱（cos函数中的自变量）<br>光源在不同的方位照射到物体表面像素点会具有不同的方位角，于是可以通过相位角恢复方位角                                                                                                                                                                                                               </p>
<p><img src="https://i.loli.net/2020/03/29/H9RQ3pNXi7dyzck.png" alt="1583071895698"></p>
<p><img src="https://i.loli.net/2020/03/29/HmCIe3KQqXnDirS.png" alt="1582442571888"></p>
<p>偏振光在行进的过程中光矢量的末端轨迹呈椭圆形（它的末端轨迹就是cos曲线的形状，你能说它是圆形的吗？不能）</p>
<p>这是一个椭圆方程，即在传播的过程中光矢量末端经过的各点将形成一个椭圆，因此这种光被称为椭圆偏振光。在光波传播的过程中，光矢量的旋向是不同的，迎着光波观察时，若旋向为顺时针，则将这种偏振光称为右旋椭圆偏振光，若旋向为逆时针，则为左旋椭圆偏振光。</p>
<p>由于Stokes矢量可以用来表示各种光波的偏振态，因此对它的测量是对光波偏振态进行探测的重要步骤。从式(2-14)中对Stokes矢量的描述可以看出，Stokes矢量包含了相位信息，然而目前的探测器直接测量相位信息还比较困难，对于光强的测量则相对较为容易。所以在探测Stokes参量时，大多采用的是获取某些特定的光强值，并通过(2-14)式来计算得到Stokes矢量的四个参量的方法。 </p>
<p><a href="https://www.baidu.com/s?wd=切线&tn=SE_PcZhidaonwhc_ngpagmjz&rsv_dl=gh_pc_zhidao" target="_blank" rel="noopener">切线</a>与<a href="https://www.baidu.com/s?wd=法线&tn=SE_PcZhidaonwhc_ngpagmjz&rsv_dl=gh_pc_zhidao" target="_blank" rel="noopener">法线</a>互相垂直，而互相垂直的<a href="https://www.baidu.com/s?wd=直线的斜率&tn=SE_PcZhidaonwhc_ngpagmjz&rsv_dl=gh_pc_zhidao" target="_blank" rel="noopener">直线的斜率</a>的积等于 -1 </p>
<p>原理：根据光波的反射和折射定律可知，目标表面反射光的传播方向由光波入射方向和目标表面形状决定，而菲涅耳公式及偏振度定义给出了目标表面反射光偏振度与光波入射方向之间的关系，因此可以根据目标表面反射光偏振度获取光波的入射方向信 息；</p>
<p>人眼之所以能看清物体的全貌，主要是靠漫反射光在眼内的成像。如是全部单向反射的物体表面，不但看不清物体的外貌，还会引起某一方向上的眩光干扰现象。</p>
<h3 id="反射光是由什么组成的？"><a href="#反射光是由什么组成的？" class="headerlink" title="反射光是由什么组成的？"></a>反射光是由什么组成的？</h3><p>– 要想解决这个问题，首先区分一下什么是漫反射光？</p>
<blockquote>
<p>当一束平行的入射光线射到粗糙的表面时，表面会把光线向着四面八方反射，所以入射线虽然互相平行，由于各点的法线方向不一致，造成反射光线向不同的方向无规则地反射，这种反射称之为“漫反射”或“ 漫射 ”。</p>
</blockquote>
<p><img src="https://i.loli.net/2020/03/29/KCR3OZmNIVJXrsd.png" alt="1582553531782"></p>
<p>光波入射到一个粗糙表面上时，由于目标表面折射率、粗糙度等因素的影响，其反射光是由不同分量构成的。1991 年，Lawrence  B.  Wolff 提出光从物质表面反射时可以分为以下四种情况[39][Wolff L B , Boult T E . Constraining object features using a polarization reflectance model[JIEEE Transactions on Pattern Analysis and Machine Intelligence, 1991, 13(7):635-657.].  ：<br>(1)  光波入射到远大于其波长的平面上经过一次反射形成的镜面反射；<br>(2)  光波在远大于其波长的目标表面多个微面元上经过多次反射(至少两次)形成的反射光；<br>(3)  光波透过目标表面，在其内部经过多次折射后，再折射回空气中；<br>(4)  光波在等于或者小于其波长的目标表面上发生衍射现象形成的衍射光。</p>
<p>以上四种反射情况如图 2.5 所示。其中第一种情况也被称为反射光的镜面反射分量，这种反射具有极强的方向性，且由于在表面上仅发生一次反射，反射光的能量是四种情况中最大的，因此其颜色和光源颜色几乎一致[40]。第二种反射光能量比第一种小，但其与第一种反射光同是无吸收的反射情况，反射光的颜色与光源颜色一致。第二到第四种情况被称为反射光的漫反射分量。对于粗糙的非金属介质，其表面反射光的漫反射分量主要是由第三种情况造成，第四种反射光占极少部分。对于粗 糙的金属介质，漫反射分量是由第二到第四种情况共同造成的。</p>
<p><img src="https://i.loli.net/2020/03/29/L8MvmKa1Qc3H9oz.png" alt="1582640617670"></p>
<p><img src="https://i.loli.net/2020/03/29/WHG57raAx2oJ4Bp.png" alt="1582640634818"></p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p><img src="https://i.loli.net/2020/03/29/t8T4REOgs6Za1eS.png" alt="1582607629196"></p>
<p><img src="https://i.loli.net/2020/03/29/81nZFsEYfTDpxJB.png" alt="1582607706104"></p>
<p><img src="https://i.loli.net/2020/03/29/J1MzvF2Gu4TkRxf.png" alt="1582607775435"></p>
<p>在不考虑相干性的情况下，非偏振光或部分偏振光必须使用穆勒微积分进行处理，而完全偏振光可以使用穆勒微积分或更简单的琼斯微积分进行处理。然而，许多涉及相干光的问题(例如来自激光的)必须用琼斯演算来处理，因为它直接与光的电场而不是光的强度或功率有关，因此保留了关于波的相位的信息。斯托克斯矢量和穆勒矩阵作用于强度及其差异，即光的非相干叠加;它们不足以描述干涉或衍射效应。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">acewzj</p>
              <p class="site-description motion-element" itemprop="description">acewzj</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">acewzj</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  








  
  





  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_sphere.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
