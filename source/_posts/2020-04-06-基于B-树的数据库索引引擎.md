---
title: 基于B+树的数据库索引引擎
date: 2020-04-06 08:21:09
tags:
- B+
- DB
- 多线程
---



这篇文章主要记述基于B+树的数据库索引引擎的一些知识点。

<!--more-->

## 大作业:基于B+树的数据库索引引擎

目标：完成支持整数为key的数据库索引功能，提供包括insert, del, update的多线程事务操作。
形式要求：基于C/C++，提供上述接口，并封装为SO库。
实现约束：所有索引文件需统一存储在一个大文件中，索引的数据可以为任意数据结构; 需支持多线程环境，采用多生产者多消费者模型；完成持续读写压力测试，运行时间不低于12小时，插入对象不低于1千万个，观察CPU，内存，磁盘开销，并将压测分析输出到报告中。
提交内容：可编译的源码，可在Linux环境中运行的程序；设计文档（包括模块框架设计，重要流程图（主要是insert,del,update接口），核心数据结构，运行时截图（操作相关结果）。
完成时间：11.20 日前提交，提交实验报告及源代码。
提交邮箱： lpue2014@163.com

select * from db where id=838;int temp = sscanf(mp->cmd,"select * from db where id=%d;\n", keyIndex); 1

总结：之前写都是什么(*Pointer).member,这么写太麻烦了,所以直接用箭头来省略部分书写内容
**箭头（->）：左边必须为指针；**
**点号（.）：左边必须为实体**

acewzj is not in the sudoers file

```c++
// int to key_t
void intToKeyT(bpt::key_t *a,int *b){
	char key[16] = { 0 };//如果只对数组的一部分进行初始化，则编译器将把其他元素设置为0。因此，当只将第一个元素初始化为0时，编译器会自动将其他元素设为0 (就像前一句说的那样)。或者3.用memset函数在程序开始时初始化数组。比如：int arr[1024];memset(arr, 0, 1024); //清零
	sprintf(key, "%d", *b);
    ///* Write formatted output to S.  */
	//extern int sprintf (char *__restrict __s,   //
	//	    const char *__restrict __format, ...) __THROWNL;
	*a = key;
}
```

__restrict关键字告诉编译器额外信息(两个指针不指向同一数据),从而生成更优化的[汇编代码](https://en.cppreference.com/w/c/language/restrict).

__THROW is meant to declare the function as capable of
throwing exceptions (a C++ feature). In C, the macro does nothing.fread:

```c++
size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream)
ptr -- 这是指向带有最小尺寸 size*nmemb 字节的内存块的指针。
size -- 这是要读取的每个元素的大小，以字节为单位。
nmemb -- 这是元素的个数，每个元素的大小为 size 字节。
stream -- 这是指向 FILE 对象的指针，该 FILE 对象指定了一个输入流。
返回值
```

search_index只是要找到key所对应的偏移地址--怎么找到呢?

首先找到根的偏移,然后取出根的偏移在文件中的数据,有偏移[起始地址]+数据类型大小[long 8]bit parent next prev n children  ,相当于反序列化?从磁盘上复活数据对象哈哈,

接着根据这个数据,因为数据里面有一个数组[50阶]的,从这里面找到比key要大的那个.这是因为在节点里面数组从左到右依次增大.

接着一层一层的往下找它的孩子?它的孩子里面存着是

update db 111 23 123@163.com where id=1;

select * from db where id in(0,9);

insert db 5002 acej 25 acewzj@qq.com;

delete from db where id=2; 

在 B+树中删除关键字时，有以下几种情况：

2、 当删除某结点中最大或者最小的关键字，就会涉及到更改其双亲结点一直到根结点中所有索引值的更改。

例如，在图 1的 B+树中删除关键字 97，删除后的 B+树如图 6 所示：![](http://data.biancheng.net/uploads/allimg/171024/2-1G024141030209.png)

当删除该关键字，导致当前结点中关键字个数小于`⌈M/2⌉`
，若其兄弟结点中含有多余的关键字，可以从兄弟结点中借关键字完成删除操作。例如，在图 1 的 B+树中删除关键字 51，由于其兄弟结点中含有 3 个关键字，所以可以选择借一个关键字，同时修改双亲结点中的索引值，删除之后的 B+树如图 7 所示：

![](http://data.biancheng.net/uploads/allimg/171024/2-1G024141129106.png)

#### 多线程

0 begin wait a condition...
1 begin wait a condition...
2 begin wait a condition...

0 begin produce product...
produce 86
0 end produce product...

- **以默认方式启动的线程，在线程结束后不会自动释放占有的系统资源，要在主控线程中调用pthread_join()后才会释放**
- **以分离状态启动的线程，在线程结束后会自动释放所占有的系统资源,这个时候就不需要调用pthread_join方法了**