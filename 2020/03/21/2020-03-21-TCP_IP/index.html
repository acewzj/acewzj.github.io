<!DOCTYPE html>




<html class="theme-next mist" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/favicon.ico?v=5.1.4" color="#222">





  <meta name="keywords" content="TCP/IP 网络编程 服务器," />










<meta name="description" content="这篇文章主要记述了TCP&#x2F;IP以及网络编程的知识。">
<meta property="og:type" content="article">
<meta property="og:title" content="TCP&#x2F;IP">
<meta property="og:url" content="http://acewzj.github.io/2020/03/21/2020-03-21-TCP_IP/index.html">
<meta property="og:site_name" content="acewzj">
<meta property="og:description" content="这篇文章主要记述了TCP&#x2F;IP以及网络编程的知识。">
<meta property="og:image" content="https://i.loli.net/2020/04/01/2UY1yrgvwzsNjD8.png">
<meta property="og:image" content="https://i.loli.net/2020/04/01/OcltiYzaLw89gv3.png">
<meta property="og:image" content="https://i.loli.net/2020/04/01/L6Qp4ORXPeFi5UY.png">
<meta property="og:image" content="https://i.loli.net/2020/04/01/1gzbMQ6qr5VkNY7.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/4FkcyDpC9ZxMiTu.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/IhUAb6fsQgp2LyG.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/e7WKMlwZguRIyE4.png">
<meta property="og:image" content="https://i.loli.net/2020/04/01/8ZcPnrdFHtVwW5D.png">
<meta property="og:image" content="https://i.loli.net/2020/04/01/Nxpg5lwZLejzRTA.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/4txL8PY9qgjCdbJ.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/JuRfAcSBvnHa1qr.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/fHRLFJg8sGY6t4b.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/M1fJEvI9H56tsWQ.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/amtJPn6jgFLT7BC.png">
<meta property="og:image" content="https://i.loli.net/2020/03/30/uzFWcwyeg9NmIrZ.jpg">
<meta property="og:image" content="https://i.loli.net/2020/03/30/9w3uJ4Iv8hYfcEC.png">
<meta property="article:published_time" content="2020-03-21T02:16:18.000Z">
<meta property="article:modified_time" content="2020-04-02T10:25:47.824Z">
<meta property="article:author" content="acewzj">
<meta property="article:tag" content="TCP&#x2F;IP 网络编程 服务器">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/04/01/2UY1yrgvwzsNjD8.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://acewzj.github.io/2020/03/21/2020-03-21-TCP_IP/"/>





  <title>TCP/IP | acewzj</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">acewzj</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">王忠杰</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://acewzj.github.io/2020/03/21/2020-03-21-TCP_IP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="acewzj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="acewzj">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">TCP/IP</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-21T10:16:18+08:00">
                2020-03-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/TCP-IP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP/IP</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这篇文章主要记述了TCP/IP以及网络编程的知识。</p>
<a id="more"></a>


<p>废话少说，首先，我们需要知道TCP在网络OSI的七层模型中的第四层——<code>Transport层</code>，IP在第三层——<code>Network层</code>，ARP在第二层——<code>Data Link层</code>，在第二层上的数据，我们叫<code>Frame</code>，在第三层上的数据叫<code>Packet</code>，第四层的数据叫<code>Segment</code>。</p>
<p>首先，我们需要知道，我们程序的数据首先会打到TCP的<code>Segment</code>中，然后TCP的<code>Segment</code>会打到IP的<code>Packet</code>中，然后再打到以太网<code>Ethernet</code>的<code>Frame</code>中，传到对端后，各个层解析自己的协议，然后把数据交给更高层的协议处理。</p>
<h2 id="connection-refused"><a href="#connection-refused" class="headerlink" title="connection refused"></a>connection refused</h2><p>服务器正常启动，但是客户端一启动就在<code>connect</code>函数退出了，错误显示<code>connection refused</code>，单步调试也看不出什么来。</p>
<p>上网一看，有的人也碰到了类似问题，他们怀疑出现这个状况最大的可能是服务器正在监听程序，但是客户端并没有按照规矩的IP和端口号来给服务器发程序：这不有的人就是因为把服务器的<code>serv_addr.sin_port = htons(atoi(argv[1]));</code>写错为<code>serv_addr.sin_port = htonl(atoi(argv[1]));</code>导致端口号分配出错了。</p>
<p><img src="https://i.loli.net/2020/04/01/2UY1yrgvwzsNjD8.png" alt="image-20200401092200981"></p>
<p>当然我也好不到哪里去？在使用telnet localhost 9000发现服务器正常好用之后，我坚信我的客户端程序出了问题：一行一行代码排查，终于发现<code>serv_addr.sin_port = htons(argv[1]);</code> 我特么忘了加atoi，这端口号肯定是错了啊【初始端口为9000，16进制为0x2328经过hostToNetShort后变成0x2823–&gt;10275】</p>
<p><img src="https://i.loli.net/2020/04/01/OcltiYzaLw89gv3.png" alt="image-20200401100250744"></p>
<p><img src="https://i.loli.net/2020/04/01/L6Qp4ORXPeFi5UY.png" alt="image-20200401100638777"></p>
<p><img src="https://i.loli.net/2020/04/01/1gzbMQ6qr5VkNY7.png" alt="image-20200401101317898"></p>
<h2 id="1、Epoll"><a href="#1、Epoll" class="headerlink" title="1、Epoll"></a>1、Epoll</h2><p><img src="https://i.loli.net/2020/03/30/4FkcyDpC9ZxMiTu.png" alt="image-20200328232049698"></p>
<p><img src="https://i.loli.net/2020/03/30/IhUAb6fsQgp2LyG.png" alt="image-20200328232416075"></p>
<p><img src="https://i.loli.net/2020/03/30/e7WKMlwZguRIyE4.png" alt="image-20200328232423802"></p>
<h2 id="2、不同socket地址结构对比"><a href="#2、不同socket地址结构对比" class="headerlink" title="2、不同socket地址结构对比"></a>2、不同socket地址结构对比</h2><p><img src="https://i.loli.net/2020/04/01/8ZcPnrdFHtVwW5D.png" alt="image-20200401224452953"></p>
<h2 id="3、如何判断机器的大端与小端？"><a href="#3、如何判断机器的大端与小端？" class="headerlink" title="3、如何判断机器的大端与小端？"></a>3、如何判断机器的大端与小端？</h2><h3 id="3-1、常见的字节序"><a href="#3-1、常见的字节序" class="headerlink" title="3.1、常见的字节序"></a>3.1、常见的字节序</h3><p>一般操作系统都是小端，而通讯协议是大端的。</p>
<p><img src="https://i.loli.net/2020/04/01/Nxpg5lwZLejzRTA.png" alt="image-20200401213715103"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BigtoLittle16(A)  ((((uint16)(A) &amp; 0xff00) &gt;&gt; 8) | </span></span><br><span class="line">							(((uint16)(A) &amp; <span class="number">0x00ff</span>) &lt;&lt; <span class="number">8</span>))</span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BigtoLittle32(A)  ((((uint32)(A) &amp; 0xff000000) &gt;&gt; 24) |                                            						(((uint32)(A) &amp; 0x00ff0000) &gt;&gt; 8) | \</span></span><br><span class="line">                   (((uint32)(A) &amp; <span class="number">0x0000ff00</span>) &lt;&lt; <span class="number">8</span>) | \</span><br><span class="line">                   (((uint32)(A) &amp; <span class="number">0x000000ff</span>) &lt;&lt; <span class="number">24</span>))</span><br></pre></td></tr></table></figure>



<h2 id="4、慢系统调用阻塞状态下来了个信号（Vital）"><a href="#4、慢系统调用阻塞状态下来了个信号（Vital）" class="headerlink" title="4、慢系统调用阻塞状态下来了个信号（Vital）"></a>4、慢系统调用阻塞状态下来了个信号（Vital）</h2><p>select函数、accept函数等都是慢系统调用函数，就是它得等系统网络IO准备好了才能执行，没有准备好就进入阻塞状态下，如果这个时候来了一个信号（因为我们知道信号是模仿的中断的嘛），当执行完信号处理函数返回后，PC指针就会跑到select函数的下一条指令去执行去了。。。。。。这不完蛋了吗：我等待的事件还没来呢我就被信号处理函数给跳过去了。</p>
<p>所以我们需要在select函数的返回值上做文章，如果select函数失败会返回-1，如果是去执行信号处理函数去了，error = EINTR</p>
<h2 id="4-1、非阻塞编程"><a href="#4-1、非阻塞编程" class="headerlink" title="4.1、非阻塞编程"></a>4.1、非阻塞编程</h2><p>让服务器不会阻塞在send，accept等函数之上，防止有人恶意攻击</p>
<p><img src="https://i.loli.net/2020/03/30/4txL8PY9qgjCdbJ.png" alt="image-20200322111836020"></p>
<p><img src="https://i.loli.net/2020/03/30/JuRfAcSBvnHa1qr.png" alt="image-20200322112447217"></p>
<p><img src="https://i.loli.net/2020/03/30/fHRLFJg8sGY6t4b.png" alt="image-20200322112833866"></p>
<p><img src="https://i.loli.net/2020/03/30/M1fJEvI9H56tsWQ.png" alt="image-20200322113420519"></p>
<h2 id="5、TCP头格式"><a href="#5、TCP头格式" class="headerlink" title="5、TCP头格式"></a>5、TCP头格式</h2><h3 id="acknowledge-告知已收到"><a href="#acknowledge-告知已收到" class="headerlink" title="acknowledge(告知已收到)"></a>acknowledge(告知已收到)</h3><p>接下来，我们来看一下TCP头的格式</p>
<p><img src="https://i.loli.net/2020/03/30/amtJPn6jgFLT7BC.png" alt="image-20200320091059508"></p>
<p>逐个分析：</p>
<ul>
<li>16位源端口号和16位目的端口号。</li>
<li>32位序号：一次TCP通信过程中某一个传输方向上的字节流的每个字节的编号，通过这个来确认发送的数据有序，比如现在序列号为1000，发送了1000，下一个序列号就是2000。</li>
<li>32位确认号：用来响应TCP报文段，给收到的TCP报文段的序号加1，三握时还要携带自己的序号。</li>
<li>4位头部长度：标识该TCP头部有多少个4字节，共表示最长15*4=60字节。同IP头部。</li>
<li>6位保留。6位标志。URG（紧急指针是否有效）ACK（表示确认号是否有效）PSH（提示接收端应用程序应该立即从TCP接收缓冲区读走数据）RST（表示要求对方重新建立连接）SYN（表示请求建立一个连接）FIN（表示通知对方本端要关闭连接）</li>
<li>16位窗口大小：TCP流量控制的一个手段，用来告诉对端TCP缓冲区还能容纳多少字节。</li>
<li>16位校验和：由发送端填充，接收端对报文段执行CRC算法以检验TCP报文段在传输中是否损坏。</li>
<li>16位紧急指针：一个正的偏移量，它和序号段的值相加表示最后一个紧急数据的下一字节的序号。</li>
</ul>
<h2 id="6、三次握手与四次挥手"><a href="#6、三次握手与四次挥手" class="headerlink" title="6、三次握手与四次挥手"></a>6、三次握手与四次挥手</h2><p><img src="https://i.loli.net/2020/03/30/uzFWcwyeg9NmIrZ.jpg" alt=""></p>
<p><img src="https://i.loli.net/2020/03/30/9w3uJ4Iv8hYfcEC.png" alt="image-20200321103919380"></p>
<p><strong>握手过程可以简化为下面的四次交互：</strong></p>
<ul>
<li>1 ) clien 端首先发送一个 SYN 包告诉 Server 端我的初始序列号是 X；</li>
<li>2 ) Server 端收到 SYN 包后回复给 client 一个 ACK 确认包，告诉 client 说我收到了；</li>
<li>3 ) 接着 Server 端也需要告诉 client 端自己的初始序列号，于是 Server 也发送一个 SYN 包告诉 client 我的初始序列号是Y；</li>
<li>4 ) Client 收到后，回复 Server 一个 ACK 确认包说我知道了。</li>
</ul>
<h4 id="这里为什么服务器也要发一个初始序列号？"><a href="#这里为什么服务器也要发一个初始序列号？" class="headerlink" title="这里为什么服务器也要发一个初始序列号？"></a>这里为什么服务器也要发一个初始序列号？</h4><p>因为有可能客户端之前与服务器连过一次，后来网络断了，客户端再连接时你服务器好意思再从头给人家发一次吗？</p>
<p><strong>在三次握手过程中，细心的同学可能会有以下疑问：</strong></p>
<ul>
<li>1）初始化序列号X、Y是可以是写死固定的吗，为什么不能呢？</li>
<li>2）假如Client发送一个SYN包给Server后就挂了或是不管了，这个时候这个连接处于什么状态呢？会超时吗？为什么呢？</li>
</ul>
<p><strong>如果初始化序列号（缩写为ISN：Inital Sequence Number）可以固定，我们来看看会出现什么问题：</strong></p>
<ul>
<li>假设ISN固定是1，Client和Server建立好一条TCP连接后，Client连续给Server发了10个包，这10个包不知怎么被链路上的路由器缓存了(路由器会毫无先兆地缓存或者丢弃任何的数据包)，这个时候碰巧Client挂掉了；</li>
<li>然后Client用同样的端口号重新连上Server，Client又连续给Server发了几个包，假设这个时候Client的序列号变成了5；</li>
<li>接着，之前被路由器缓存的10个数据包全部被路由到Server端了，Server给Client回复确认号10，这个时候，Client整个都不好了，这是什么情况？我的序列号才到5，你怎么给我的确认号是10了，整个都乱了。</li>
</ul>
<h2 id="疑症-3-初始化连接的-SYN-超时问题"><a href="#疑症-3-初始化连接的-SYN-超时问题" class="headerlink" title="疑症 3 : 初始化连接的 SYN 超时问题"></a>疑症 3 : 初始化连接的 SYN 超时问题</h2><p>Client发送SYN包给Server后挂了，Server回给Client的SYN-ACK一直没收到Client的ACK确认，这个时候这个连接既没建立起来，也不能算失败。这就需要一个超时时间让Server将这个连接断开，否则这个连接就会一直占用Server的SYN连接队列中的一个位置，大量这样的连接就会将Server的SYN连接队列耗尽，让正常的连接无法得到处理。</p>
<p>目前，Linux下默认会进行5次重发SYN-ACK包，重试的间隔时间从1s开始，下次的重试间隔时间是前一次的双倍，5次的重试时间间隔为1s, 2s, 4s, 8s, 16s，总共31s，第5次发出后还要等32s都知道第5次也超时了.所以，总共需要 1s + 2s + 4s+ 8s+ 16s + 32s = 63s，TCP才会把断开这个连接。</p>
<p>由于，SYN超时需要63秒，那么就给攻击者一个攻击服务器的机会，攻击者在短时间内发送大量的SYN包给Server(俗称 SYN flood 攻击)，用于耗尽Server的SYN队列。对于应对SYN 过多的问题，linux提供了几个TCP参数：tcp_syncookies、tcp_synack_retries、tcp_max_syn_backlog、tcp_abort_on_overflow 来调整应对。</p>
<h2 id="8、疑症-5-四次挥手能不能变成三次挥手呢？"><a href="#8、疑症-5-四次挥手能不能变成三次挥手呢？" class="headerlink" title="8、疑症 5 : 四次挥手能不能变成三次挥手呢？"></a>8、疑症 5 : 四次挥手能不能变成三次挥手呢？</h2><p>答案是可能的。</p>
<p>TCP是全双工通信，Cliet在自己已经不会在有新的数据要发送给Server后，可以发送FIN信号告知Server，这边已经终止Client到对端Server那边的数据传输。但是，这个时候对端Server可以继续往Client这边发送数据包。于是，两端数据传输的终止在时序上是独立并且可能会相隔比较长的时间，这个时候就必须最少需要2+2 = 4 次挥手来完全终止这个连接。但是，如果Server在收到Client的FIN包后，在也没数据需要发送给Client了，那么对Client的ACK包和Server自己的FIN包就可以合并成为一个包发送过去，这样四次挥手就可以变成三次了(似乎linux协议栈就是这样实现的)。</p>
<p>TCP进行断开连接的目标是：回收资源、终止数据传输。由于TCP是全双工的，需要Peer两端分别各自拆除自己通向Peer对端的方向的通信信道。</p>
<p><strong>这样需要四次挥手来分别拆除通信信道，就比较清晰明了了：</strong></p>
<ul>
<li>1）Client 发送一个FIN包来告诉 Server 我已经没数据需要发给 Server了；</li>
<li>2）Server 收到后回复一个 ACK 确认包说我知道了；</li>
<li>3）然后 server 在自己也没数据发送给client后，Server 也发送一个 FIN 包给 Client 告诉 Client 我也已经没数据发给client 了；</li>
<li>4）Client 收到后，就会回复一个 ACK 确认包说我知道了。</li>
</ul>
<p>很多人会问，为什么建链接要3次握手，断链接需要4次挥手？</p>
<ul>
<li><strong>对于建链接的3次握手，</strong>主要是要初始化Sequence Number 的初始值。通信的双方要互相通知对方自己的初始化的Sequence Number（缩写为ISN：Inital Sequence Number）——所以叫SYN，全称Synchronize Sequence Numbers。也就上图中的 x 和 y。这个号要作为以后的数据通信的序号，以保证应用层接收到的数据不会因为网络上的传输的问题而乱序（TCP会用这个序号来拼接数据）。</li>
<li><strong>对于4次挥手，</strong>其实你仔细看是2次，因为TCP是全双工的，所以，发送方和接收方都需要Fin和Ack。只不过，有一方是被动的，所以看上去就成了所谓的4次挥手。如果两边同时断连接，那就会就进入到CLOSING状态，然后到达TIME_WAIT状态。下图是双方同时断连接的示意图（你同样可以对照着TCP状态机看）：</li>
</ul>
<p>另外，有几个事情需要注意一下：</p>
<ul>
<li><strong>关于建连接时SYN超时</strong>。试想一下，如果server端接到了client发的SYN后回了SYN-ACK后client掉线了，server端没有收到client回来的ACK，那么，这个连接处于一个中间状态，即没成功，也没失败。于是，server端如果在一定时间内没有收到的TCP会重发SYN-ACK。在Linux下，默认重试次数为5次，重试的间隔时间从1s开始每次都翻售，5次的重试时间间隔为1s, 2s, 4s, 8s, 16s，总共31s，第5次发出后还要等32s都知道第5次也超时了，所以，总共需要 1s + 2s + 4s+ 8s+ 16s + 32s = 2^6 -1 = 63s，TCP才会把断开这个连接。</li>
<li><strong>关于SYN Flood攻击</strong>。一些恶意的人就为此制造了SYN Flood攻击——给服务器发了一个SYN后，就下线了，于是服务器需要默认等63s才会断开连接，这样，攻击者就可以把服务器的syn连接的队列耗尽，让正常的连接请求不能处理。于是，Linux下给了一个叫<strong>tcp_syncookies</strong>的参数来应对这个事——当SYN队列满了后，TCP会通过源地址端口、目标地址端口和时间戳打造出一个特别的Sequence Number发回去（又叫cookie），如果是攻击者则不会有响应，如果是正常连接，则会把这个 SYN Cookie发回来，然后服务端可以通过cookie建连接（即使你不在SYN队列中）。请注意，<strong>请先千万别用tcp_syncookies来处理正常的大负载的连接的情况</strong>。因为，synccookies是妥协版的TCP协议，并不严谨。对于正常的请求，你应该调整三个TCP参数可供你选择，第一个是：tcp_synack_retries 可以用他来减少重试次数；第二个是：tcp_max_syn_backlog，可以增大SYN连接数；第三个是：tcp_abort_on_overflow 处理不过来干脆就直接拒绝连接了。</li>
<li><strong>关于ISN的初始化</strong>。ISN是不能hard code的，不然会出问题的——比如：如果连接建好后始终用1来做ISN，如果client发了30个segment过去，但是网络断了，于是 client重连，又用了1做ISN，但是之前连接的那些包到了，于是就被当成了新连接的包，此时，client的Sequence Number 可能是3，而Server端认为client端的这个号是30了。全乱了。<a href="http://tools.ietf.org/html/rfc793" target="_blank" rel="noopener">RFC793</a>中说，ISN会和一个假的时钟绑在一起，这个时钟会在每4微秒对ISN做加一操作，直到超过2^32，又从0开始。这样，一个ISN的周期大约是4.55个小时。因为，我们假设我们的TCP Segment在网络上的存活时间不会超过Maximum Segment Lifetime（缩写为MSL – <a href="http://en.wikipedia.org/wiki/Maximum_Segment_Lifetime" target="_blank" rel="noopener">Wikipedia语条</a>），所以，只要MSL的值小于4.55小时，那么，我们就不会重用到ISN。</li>
<li><strong>关于 MSL 和 TIME_WAIT</strong>。通过上面的ISN的描述，相信你也知道MSL是怎么来的了。我们注意到，在TCP的状态图中，从TIME_WAIT状态到CLOSED状态，有一个超时设置，这个超时设置是 2*MSL（<a href="http://tools.ietf.org/html/rfc793" target="_blank" rel="noopener">RFC793</a>定义了MSL为2分钟，Linux设置成了30s）为什么要这有TIME_WAIT？为什么不直接给转成CLOSED状态呢？主要有两个原因：1）TIME_WAIT确保有足够的时间让对端收到了ACK，如果被动关闭的那方没有收到Ack，就会触发被动端重发Fin，一来一去正好2个MSL，2）有足够的时间让这个连接不会跟后面的连接混在一起（你要知道，有些自做主张的路由器会缓存IP数据包，如果连接被重用了，那么这些延迟收到的包就有可能会跟新连接混在一起）。你可以看看这篇文章《<a href="http://www.serverframework.com/asynchronousevents/2011/01/time-wait-and-its-design-implications-for-protocols-and-scalable-servers.html" target="_blank" rel="noopener">TIME_WAIT and its design implications for protocols and scalable client server systems</a>》</li>
<li><strong>关于TIME_WAIT数量太多</strong>。从上面的描述我们可以知道，TIME_WAIT是个很重要的状态，但是如果在大并发的短链接下，TIME_WAIT 就会太多，这也会消耗很多系统资源。只要搜一下，你就会发现，十有八九的处理方式都是教你设置两个参数，一个叫<strong>tcp_tw_reuse</strong>，另一个叫<strong>tcp_tw_recycle</strong>的参数，这两个参数默认值都是被关闭的，后者recyle比前者resue更为激进，resue要温柔一些。另外，如果使用tcp_tw_reuse，必需设置tcp_timestamps=1，否则无效。这里，你一定要注意，<strong>打开这两个参数会有比较大的坑——可能会让TCP连接出一些诡异的问题</strong>（因为如上述一样，如果不等待超时重用连接的话，新的连接可能会建不上。正如<a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="noopener">官方文档</a>上说的一样“<strong>It should not be changed without advice/request of technical experts</strong>”）。</li>
<li><strong>关于tcp_tw_reuse</strong>。官方文档上说tcp_tw_reuse 加上tcp_timestamps（又叫PAWS, for Protection Against Wrapped Sequence Numbers）可以保证协议的角度上的安全，但是你需要tcp_timestamps在两边都被打开（你可以读一下<a href="http://lxr.free-electrons.com/ident?i=tcp_twsk_unique" target="_blank" rel="noopener">tcp_twsk_unique</a>的源码 ）。我个人估计还是有一些场景会有问题。</li>
<li><strong>关于tcp_tw_recycle</strong>。如果是tcp_tw_recycle被打开了话，会假设对端开启了tcp_timestamps，然后会去比较时间戳，如果时间戳变大了，就可以重用。但是，如果对端是一个NAT网络的话（如：一个公司只用一个IP出公网）或是对端的IP被另一台重用了，这个事就复杂了。建链接的SYN可能就被直接丢掉了（你可能会看到connection time out的错误）（如果你想观摩一下Linux的内核代码，请参看源码<a href="http://lxr.free-electrons.com/ident?i=tcp_timewait_state_process" target="_blank" rel="noopener"> tcp_timewait_state_process</a>）。</li>
<li><strong>关于tcp_max_tw_buckets</strong>。这个是控制并发的TIME_WAIT的数量，默认值是180000，如果超限，那么，系统会把多的给destory掉，然后在日志里打一个警告（如：time wait bucket table overflow），官网文档说这个参数是用来对抗DDoS攻击的。也说的默认值180000并不小。这个还是需要根据实际情况考虑。</li>
</ul>
<p>*<em>Again，使用tcp_tw_reuse和tcp_tw_recycle来解决TIME_WAIT的问题是非常非常危险的，因为这两个参数违反了TCP协议（<a href="http://tools.ietf.org/html/rfc1122" target="_blank" rel="noopener">RFC 1122</a>） *</em></p>
<p>其实，TIME_WAIT表示的是你主动断连接，所以，这就是所谓的“不作死不会死”。试想，如果让对端断连接，那么这个破问题就是对方的了，呵呵。另外，如果你的服务器是于HTTP服务器，那么设置一个<a href="http://en.wikipedia.org/wiki/HTTP_persistent_connection" target="_blank" rel="noopener">HTTP的KeepAlive</a>有多重要（浏览器会重用一个TCP连接来处理多个HTTP请求），然后让客户端去断链接（你要小心，浏览器可能会非常贪婪，他们不到万不得已不会主动断连接）。</p>
<h4 id="数据传输中的Sequence-Number"><a href="#数据传输中的Sequence-Number" class="headerlink" title="数据传输中的Sequence Number"></a>数据传输中的Sequence Number</h4><p>下图是我从Wireshark中截了个我在访问coolshell.cn时的有数据传输的图给你看一下，SeqNum是怎么变的。（使用Wireshark菜单中的Statistics -&gt;Flow Graph… ）</p>
<p><a href="http://www.52im.net/thread-1003-1-1.html" target="_blank" rel="noopener">http://www.52im.net/thread-1003-1-1.html</a></p>
<p>作者：Cooci_和谐学习_不急不躁<br>链接：<a href="https://www.jianshu.com/p/69695f332a71" target="_blank" rel="noopener">https://www.jianshu.com/p/69695f332a71</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    acewzj
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://acewzj.github.io/2020/03/21/2020-03-21-TCP_IP/" title="TCP/IP">http://acewzj.github.io/2020/03/21/2020-03-21-TCP_IP/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/TCP-IP-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"># TCP/IP 网络编程 服务器</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/17/2020-03-17-Schedule/" rel="next" title="Schedule">
                <i class="fa fa-chevron-left"></i> Schedule
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/29/2020-03-29-Matlab/" rel="prev" title="Matlab">
                Matlab <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">acewzj</p>
              <p class="site-description motion-element" itemprop="description">acewzj</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#connection-refused"><span class="nav-number">1.</span> <span class="nav-text">connection refused</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1、Epoll"><span class="nav-number">2.</span> <span class="nav-text">1、Epoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、不同socket地址结构对比"><span class="nav-number">3.</span> <span class="nav-text">2、不同socket地址结构对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、如何判断机器的大端与小端？"><span class="nav-number">4.</span> <span class="nav-text">3、如何判断机器的大端与小端？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1、常见的字节序"><span class="nav-number">4.1.</span> <span class="nav-text">3.1、常见的字节序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、慢系统调用阻塞状态下来了个信号（Vital）"><span class="nav-number">5.</span> <span class="nav-text">4、慢系统调用阻塞状态下来了个信号（Vital）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1、非阻塞编程"><span class="nav-number">6.</span> <span class="nav-text">4.1、非阻塞编程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、TCP头格式"><span class="nav-number">7.</span> <span class="nav-text">5、TCP头格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#acknowledge-告知已收到"><span class="nav-number">7.1.</span> <span class="nav-text">acknowledge(告知已收到)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6、三次握手与四次挥手"><span class="nav-number">8.</span> <span class="nav-text">6、三次握手与四次挥手</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#这里为什么服务器也要发一个初始序列号？"><span class="nav-number">8.0.1.</span> <span class="nav-text">这里为什么服务器也要发一个初始序列号？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#疑症-3-初始化连接的-SYN-超时问题"><span class="nav-number">9.</span> <span class="nav-text">疑症 3 : 初始化连接的 SYN 超时问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8、疑症-5-四次挥手能不能变成三次挥手呢？"><span class="nav-number">10.</span> <span class="nav-text">8、疑症 5 : 四次挥手能不能变成三次挥手呢？</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据传输中的Sequence-Number"><span class="nav-number">10.0.1.</span> <span class="nav-text">数据传输中的Sequence Number</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">acewzj</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  









  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
